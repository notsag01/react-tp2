(window.webpackJsonptheoWebApp=window.webpackJsonptheoWebApp||[]).push([[41],{"6ZWm":function(e,t,r){var o,n=t,i=r("oAGj"),a=r("0wFF"),l=r("KSe6"),s=r("CWW7"),u=r("yGNn"),c=r("AVHO"),d=r("Ohrj"),h=r("ascj"),m=r("O60Y"),f=r("wNKJ"),g=r("FNB+"),p=r("yHU1"),v=r("Pil/"),C=r("cmoc"),F=r("16hp"),y=r("OYRJ"),b=r("OdB2"),I=r("QbzR"),S=r("JEzR"),D=r("P83h"),T=r("9Lk3"),x=r("ZK0l"),G=r("x35w"),M=r("X0GW"),P=r("ZhwN"),_=r("iCxV"),k=r("Qlvz"),R=r("NkBu"),w=r("U010"),A=r("fdtz"),B=r("lmwz"),L=r("fNpk"),E=r("hywZ"),N=r("tGKA"),U=r("3DEm"),O=r("K0Rh"),Y=r("7Ta2"),z=r("JO5d"),X=r("Zifs"),H=r("djAF"),W=r("35Q0"),q=r("T6jX"),K=r("fAXt"),V=r("MnRR"),j=r("oKlP"),Z=r("sIWg"),J=r("1NAc"),Q=r("zjod");n.FitType=i.defineEnum("FitType",{None:0,ProportionalFit:1,ProportionalFill:2,Stretch:3}),n.CropType=i.defineEnum("CropType",{ScaleCrop:0,FitBorder:1,FillFocus:2,ExtremeCloseup:3,AbstractCloseup:4,PreserveFocus:5,PreserveFocusAndScale:6}),n.FrameController=(o=function(e,t,r){this.fitting_=n.FitType.None,this.cropType_=null,this.preCropModeLayerIndex_=null,x.GroupController.call(this,e,t,r)},i.defineClass({name:"FrameController",ctor:o,superName:"GroupController",statics:{IMAGE_FITTING_PROPERTY:"image-fitting",CROP_MODE_LAYER:"crop-mode-layer",KIND:{get:function(){return"frame"}},resizeBoundsWithPin:function(e,t,r){var o=e;return 0==r.x?o=new Z.TheoRect(o.minX,o.minY,o.minX+t.width,o.maxY):1==r.x&&(o=new Z.TheoRect(o.maxX-t.width,o.minY,o.maxX,o.maxY)),0==r.y?o=new Z.TheoRect(o.minX,o.minY,o.maxX,o.minY+t.height):1==r.y&&(o=new Z.TheoRect(o.minX,o.maxY-t.height,o.maxX,o.maxY)),o}},props:{moveable:{get:function(){var e;return!((e=i.opt(i.opt(i.opt(this.forma,(function(e){return e.page.document})),(function(e){return e.controller})),(function(e){return e.selection})))&&e.isSelected(this.forma)&&e.inCropMode)&&this.floating}},floating:{get:function(){var e,t;return null!=(e=i.opt(this.forma,(function(e){return e.allowUserMove})))?e:!!(t=this.forma)&&(t.isLogo()||t.isSticker()||i.opt(i.as(t,C.FrameForma),(function(e){return 1==e.hasAlpha()})))}},selectable:{get:function(){return!0}},duplicatable:{get:function(){return this.floating}},rotateable:{get:function(){return!0}},flippable:{get:function(){return!i.opt(this.forma,(function(e){return 1==e.isLogo()}))}},nudgeable:{get:function(){return!0}},image:{get:function(){return B.ImageFacade.getImageFormaForForma(this.forma)}},mask:{get:function(){return B.ImageFacade.getMaskFormaForForma(this.forma)}},cutoutMode:{get:function(){return B.ImageFacade.getCutoutModeForForma(this.forma)}},cutout:{get:function(){if(this.cutoutMode==w.CutoutMode.Off)return null;var e=B.ImageFacade.getCutoutMaskFormaForForma(this.forma);return L.LegacyCoreAssert.isTrue(null!=e,"Could not find cutout mask forma.",void 0,"FrameController","FrameController.swift",125),e}},hasCutout:{get:function(){return B.ImageFacade.getCutoutModeForForma(this.forma)!=w.CutoutMode.Off}},hasBackgroundColor:{get:function(){return this.hasCutout&&i.opt(this.forma,(function(e){return null!=e.style.colors.fieldPrimary}))}},fitting:{get:function(){var e;if(null!=(e=i.as(this.controllerMetadata.get(o.IMAGE_FITTING_PROPERTY),"String")))switch(e){case"cover":return n.FitType.ProportionalFill;case"contain":return n.FitType.ProportionalFit;case"stretch":return n.FitType.Stretch}return n.FitType.None},set:function(e){var t;switch(e){case 2:t="cover";break;case 1:t="contain";break;case 3:t="stretch";break;default:t="none"}this.controllerMetadata.set(o.IMAGE_FITTING_PROPERTY,t)}},copyTo:function(e){var t,r,o;if(void 0===e&&(e=null),L.LegacyCoreAssert.isTrue(null==e||e==i.opt(i.opt(this.owner,(function(e){return e.document})),(function(e){return e.firstPage})),"FrameController does not currently support copying across pages",void 0,"FrameController.copyTo","FrameController.swift",180),(t=i.opt(i.opt(this.owner,(function(e){return e.document})),(function(e){return e.firstPage})))&&(r=i.as(this.forma,C.FrameForma))&&(o=B.ImageFacade.getImageFormaForForma(r))){var n,c,d=o.contentNode,h=null;if((n=i.as(o,Q.VideoForma))&&(d=n.videoContentNode,h=n.contentNode),c=d){var m=this.moveable?s.FloatingImageStrategy.Always:s.FloatingImageStrategy.IfHasAlphaOrIsLogo,f=new s.AddFormaParams(void 0,void 0,void 0,m);return s.CreationFacade.addContent(t,c,h,void 0,f).then((function(e){var n;if(n=i.as(e,g.Forma)){var s,c,d,h=new D.FormaAnimationTransactionEvent(n);return h.duration=0,n.beginUpdate(h),n.match(r),(s=i.as(n,C.FrameForma))&&(c=B.ImageFacade.getImageFormaForForma(s))&&c.match(o),(d=t.document)&&l.AnimationLibrary.updateCurrentStyle(d,n.isVideo()),i.opt(_.Host.logging,(function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsDataImageDuplicated,{})})),n.endUpdate(h),n}return u.CorePromise.reject("Failed to get forma from addContent")}))}}return u.CorePromise.resolve(null)},flip:function(e){var t;void 0===e&&(e=!1),this.floating?K.TransformFacade.flipForma(this.forma,e):(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(K.TransformFacade.flipForma(t,e),this.updateParentGroup())},rotate:function(e){var t;void 0===e&&(e=Math.PI/180),this.floating&&!B.ImageFacade.inCropMode(this.forma)?K.TransformFacade.rotateForma(this.forma,e):(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(K.TransformFacade.rotateForma(t,e),this.updateParentGroup())},rotation:function(){return this.floating?this.forma.rotation():(e=B.ImageFacade.getImageFormaForForma(this.forma))?e.rotation():0;var e},nudge:function(e){var t;this.floating?K.TransformFacade.translateForma(this.forma,e):(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(K.TransformFacade.translateForma(t,e),this.updateParentGroup())},selectionHandlePositions:{get:function(){var e,t=!this.moveable;B.ImageFacade.inCropMode(this.forma)&&(t=!this.maintainAspectRatio,(e=i.opt(this.mask,(function(e){return e.controller})))&&e.maintainAspectRatio&&(t=!1));var r=[new j.TheoPoint(.5,0),new j.TheoPoint(.5,1),new j.TheoPoint(1,.5),new j.TheoPoint(0,.5)];return!this.floating&&this.forma.isGridCell()?r:t?r.concat(i.clone(x.GroupController._getters.selectionHandlePositions.call(this))):x.GroupController._getters.selectionHandlePositions.call(this)}},processEvent:function(e){var t;return(t=i.as(e,v.BeginPointerTrackingEvent))?(t.trackingResponse=this.moveable?p.BeginPointerTrackingResponseEnum.TrackAsGroup:p.BeginPointerTrackingResponseEnum.TrackWithinGroup,!1):x.GroupController.prototype.processEvent.call(this,e)},processFormaDoubleClick:function(e){if(!B.ImageFacade.inCropMode(this.forma)&&(this.owner.selection.replaceSelection(e.forma),this.owner.selection.isSelected(e.forma)))for(var t=i.iter(e.forma.visitAsArray(g.FormaTraversal.JustChildren));!t.done;t.next()){var r,o=t.value;(r=i.as(o.controller,R.ImageController))&&(this.owner.controllerSettingsState.settings=new c.ImageControllerSettings(r))}},processEndFormaDrag:function(e){var t,r=this.owner.document.firstPage;r.publish(new b.EndFormaDragMessage(r)),this.fitChildrenToFrame(),(t=i.as(i.opt(this.forma.parent,(function(e){return e.controller})),T.GridController))&&t.processChildEndFormaDrag(e)},processBeginFormaDrag:function(e){var t;x.GroupController.prototype.processBeginFormaDrag.call(this,e),(t=i.as(i.opt(this.forma.parent,(function(e){return e.controller})),T.GridController))&&t.processChildBeginFormaDrag(this.forma,e)},afterProcessBeginFormaDrag:function(e){var t;(t=i.as(i.opt(this.forma.parent,(function(e){return e.controller})),T.GridController))&&t.processChildBeginFormaDrag(this.forma,e)},clipLineToRectWithTransform:function(e,t,r){var o=r,n=r.transformValues,a=Math.atan2(n.rotSine,n.rotCosine);Math.abs(a)<.01&&(o=N.Matrix2D.scalingXY(n.xscale,n.yscale).skewTo(n.skew).translateXY(n.tx,n.ty));for(var l=[t.horizontalLine(0).transform(o),t.horizontalLine(1).transform(o),t.verticalLine(0).transform(o),t.verticalLine(1).transform(o)],s=i.iter(l);!s.done;s.next()){var u,c=s.value;if(u=c.intersection(e)){var d=e.locate(u),h=c.locate(u);if(d>=.01&&d<=1&&h>=0&&h<=1)return new V.TheoLine(e.p1,u)}}return e},constrainFrameSizeToImage:function(e,t,r){var n,a,l=this,s=t;if((n=i.opt(this.forma_,(function(e){return e.bounds})))&&(a=e.bounds)){var u=o.resizeBoundsWithPin(n,t,r),c=u.horizontalLine(0),d=u.horizontalLine(1),h=u.verticalLine(0),m=u.verticalLine(1),f=[],g=!1,p=!1;if(.5==r.x)g=!0,f=i.clone(0==r.y?[h,m]:[h.reverse(),m.reverse()]);else if(.5==r.y)p=!0,f=i.clone(0==r.x?[c,d]:[c.reverse(),d.reverse()]);else if(r.x==r.y){var v=new V.TheoLine(new j.TheoPoint(u.minX,u.minY),new j.TheoPoint(u.maxX,u.maxY));f=0==r.x?[v,c,h]:[v.reverse(),d.reverse(),m.reverse()]}else v=new V.TheoLine(new j.TheoPoint(u.minX,u.maxY),new j.TheoPoint(u.maxX,u.minY)),f=0==r.x?[v,d,h.reverse()]:[v.reverse(),c.reverse(),m];var C=f.map((function(t){return l.clipLineToRectWithTransform(t,a,e.placement)}),this),F=u.height,y=u.width;if(g)F=C.reduce((function(e,t){return Math.min(e,t.length)}),1e5);else if(p)y=C.reduce((function(e,t){return Math.min(e,t.length)}),1e5);else{for(var b=1e5,I=i.iter(i.toSequence(f));!I.done;I.next()){var S=I.value,D=S.offset,T=S.element,x=i.as(C[D],V.TheoLine).length/T.length;x<b&&(b=x)}y*=b,F*=b}s=new J.TheoSize(y,F)}return s},processFormaResize:function(e){var t,r,n,a,l,s;if((t=i.as(this.forma,C.FrameForma))&&(r=B.ImageFacade.getImageFormaForForma(t))&&(n=t.bounds)&&(a=i.opt(i.opt(t.page.document,(function(e){return e.controller})),(function(e){return e.selection})))&&(l=e.pin)&&(s=e.newSize)){var u=new D.FormaAnimationTransactionEvent(t);u.duration=0,t.beginUpdate(u);var c=[],d=this.maintainAspectRatio||.5!=l.x&&.5!=l.y;if(a.inCropMode){if(s=d?n.size.myAspectRatioClosestCorner(s):s,r.hasAlpha()){var h=o.resizeBoundsWithPin(n,s,l).insetXY(15,15);if(!Z.TheoRect.PointInCommon(r.bounds,N._asterisk_Matrix2D_Matrix2D(r.totalPlacement,t.totalPlacement.inverse),h))return void t.endUpdate(u);e.newSize=s}else e.newSize=this.constrainFrameSizeToImage(r,s,l);for(var m=i.iter(t.visitAsArray(g.FormaTraversal.JustChildren));!m.done;m.next()){var f=m.value;c.push(f),t.root.appendChild(f,!0)}}x.GroupController.prototype.processFormaResize.call(this,e);for(var p=i.iter(c);!p.done;p.next())f=p.value,t.appendChild(f,!0);this.fitChildrenToFrame(),a.inCropMode&&this.updateCropModeImage(),t.endUpdate(u)}},processEndFormaResize:function(e){var t;if(x.GroupController.prototype.processEndFormaResize.call(this,e),this.updateParentGroup(),t=B.ImageFacade.getImageFormaForForma(this.forma)){var r=new D.FormaForceRerenderPseudoChangeEvent(t);t.beginUpdate(r),t.endUpdate(r)}},processFormaDrag:function(e){var t;x.GroupController.prototype.processFormaDrag.call(this,e),(t=i.as(i.opt(this.forma.parent,(function(e){return e.controller})),T.GridController))&&t.processChildFormaDrag(this.forma,e)},afterProcessFormaDrag:function(e){var t;(t=i.as(i.opt(this.forma.parent,(function(e){return e.controller})),T.GridController))&&t.processChildFormaDrag(this.forma,e)},childUpdate:function(e){void 0===e&&(e=null),x.GroupController.prototype.childUpdate.call(this,e),this.blockUpdate||(this.fitChildrenToFrame(),this.updateCropModeImage())},shuffleColorAssignment:function(){var e,t,r,n;if((t=i.as(this.forma,C.FrameForma))&&(r=i.opt(this.forma,(function(e){return e.style})))&&(n=i.as(t.controller,o))){if(t.isLogo())return;var a=this.getCurrentColors(r).length,l=r.colors.color(h.ColorRole.FieldPrimary),s=!(e=i.opt(l,(function(e){return e.isEqual(X.SolidColor.ZERO)})))&&null==e||e,u=a>0&&n.hasCutout&&!s,c=t.page.colorLibraryController;if(u){var m=[],f=null;if(q.TheoDocumentUtils.enableFastHeuristicsForComplexPage(this.forma.page)){var g=n.floating?Y.InferredRoleType.GraphicContent:Y.InferredRoleType.Background;f=i.clone(Y.InferredRole.init_84d1(g,1,Y.InferredRoleType.Background,0))}var p,v=new d.ProfilingPrimaryColorSelector(t,!1).selectColorForGlobalRecolor(void 0,void 0,void 0,i.clone(f));if((p=c.getTheoColorForKey(v))&&m.push(p),a>1){var F,y=new d.ProfilingBackgroundColorSelector(t,!0).selectColorForGlobalRecolor(void 0,void 0,void 0,i.clone(f));(F=c.getTheoColorForKey(y))&&m.push(F)}this.applyColors(i.clone(m))}}},updateCropModeImage:function(){var e,t,r,o,n;B.ImageFacade.inCropMode(this.forma)&&(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(r=B.ImageFacade.getTempCropImageForForma(this.forma))&&(_.Host.platform.isWeb&&!r.bounds.equal(t.bounds)?(this.cleanupCropVisualization(),this.enterCropMode()):((e=i.opt(r.controller,(function(e){return e.userGroupChild})))||null!=e)&&e?(o=r.parent)&&null!=(n=o.indexOfChild(r))&&(i.opt(r.root,(function(e){return e.appendChild(r,!0)})),r.placement=t.totalPlacement,o.insertChildAt(r,n,!0)):r.placement=t.totalPlacement)},updateAfterChildTransform:function(){this.updateParentGroup(),this.fitChildrenToFrame(),this.updateCropModeImage()},enterCropMode:function(){if(B.ImageFacade.inCropMode(this.forma)){if(null!=B.ImageFacade.getTempCropImageForForma(this.forma))return;this.preCropModeLayerIndex_=this.createCropVisualization()}},createCropVisualization:function(){var e,t=new D.FormaAnimationTransactionEvent(this.forma);t.duration=0,this.forma.beginUpdate(t);var r,o,n,a,l,s=null,u=P.GUIDUtils.makeGUID(),c=P.GUIDUtils.makeGUID();if((r=this.forma.parent)&&null!=(o=r.indexOfChild(this.forma))&&(e=o,r.removeChild(this.forma),r.appendChild(this.forma),s=m.DBLink.init_8408(u,this.forma.database,r.parent.id)),(n=B.ImageFacade.getImageFormaForForma(this.forma))&&(a=i.as(this.forma.forkToDatabase(u,!1,this.forma.database,s),C.FrameForma))&&(l=i.as(n.forkToDatabase(c,!1,this.forma.database,m.DBLink.init_8408(c,this.forma.database,a.id)),A.ImageForma))){l.setParent(a),a.setParent(null),a.appendChild(l,!0);var d,h,f,p,v=P.GUIDUtils.makeGUID();(d=this.forma)&&(h=B.ImageFacade.getCutoutMaskFormaForForma(d))&&(f=i.as(h.forkToDatabase(v,!1,this.forma.database,m.DBLink.init_8408(v,this.forma.database,a.id)),A.ImageForma))&&(B.ImageFacade.setCutoutForForma(a,f),B.ImageFacade.setCutoutModeForForma(a,B.ImageFacade.getCutoutModeForForma(d))),(p=i.as(l,Q.VideoForma))&&(p.mode=Q.VideoMode.stillImage),a.intent=g.Forma.INTENT_TEMP_IMAGE_CROP,a.bounds=l.bounds,a.placement=n.totalPlacement,a.isModel=!1,B.ImageFacade.setMaskForForma(a,null),l.placement=N.Matrix2D.Identity,l.style.opacity=.4*l.style.opacity,this.forma.parent.insertBefore(a,this.forma,!0);var F=[];F.push(l);var y,b=new D.FormaInsertedChildrenEvent(a,F,0);a.beginUpdate(b),a.endUpdate(b),(y=i.as(this.forma.page.createFormaWithController(H.ShapeForma.KIND,z.ShapeController.KIND),H.ShapeForma))&&(W.ShapeLibrary.applyToShapeForma(y,W.ShapeLibrary.Square),y.bounds=i.opt(this.forma.root,(function(e){return e.bounds})),y.style.opacity=.5,y.style.colors.fieldPrimary=X.SolidColor.BLACK,y.intent=g.Forma.INTENT_TEMP_IMAGE_CROP,y.allowUserMove=!1,this.forma.parent.insertBefore(y,a,!0))}return this.forma.endUpdate(t),e},cleanupCropVisualization:function(){var e,t=[];if(s=i.opt(this.forma,(function(e){return e.parent})))for(var r=i.iter(s.visitAsArray(g.FormaTraversal.JustChildren));!r.done;r.next())(l=r.value).hasIntent(g.Forma.INTENT_TEMP_IMAGE_CROP)&&t.push(l);if(null!=this.preCropModeLayerIndex_||0!=t.length){var o,n=new D.FormaAnimationTransactionEvent(this.forma);n.duration=0,this.forma.beginUpdate(n);for(var a=i.iter(t);!a.done;a.next()){var l;(l=a.value).removeFromParent(),l.destroy()}if((s=i.opt(this.forma,(function(e){return e.parent})))&&null!=(o=this.preCropModeLayerIndex_)&&(s.removeChild(this.forma),s.insertChildAt(this.forma,o)),this.preCropModeLayerIndex_=null,this.forma.endUpdate(n),this.userGroupChild)for(var s=i.opt(this.forma,(function(e){return e.parent}));((e=i.opt(i.opt(s,(function(e){return e.controller})),(function(e){return e.userGroup})))||null!=e)&&e;)M.GroupFacade.updateUserGroupBounds(s),s=i.opt(s,(function(e){return e.parent}))}},match:function(e){x.GroupController.prototype.match.call(this,e),this.cleanupCropVisualization()},setBoundsWithCropType:function(e,t){this.cropType_=t,i.opt(this.forma,(function(t){return t.bounds=Z.TheoRect.fromSize(e.size)})),this.cropType_=null},fit:function(e){this.fitWithCrop(e)},fitWithCrop:function(e,t){var r,o;void 0===t&&(t=null),this.cropType_=t,(r=this.forma)&&(o=r.bounds)&&(r.placement=N.Matrix2D.Identity,r.bounds=Z.TheoRect.fromSize(this.maintainAspectRatio?e.fitAspectRatioWithin(o.aspectRatio):e.size),r.moveCenterToPoint(e.center)),this.cropType_=null},getCurrentCropType:function(e,t){var r,o,i;if(null!=(r=this.cropType_))return r;if(this.forma.isSticker())return n.CropType.FitBorder;if((o=e)&&(i=t)){var a=Math.abs(o.aspectRatio-i.aspectRatio)<1e-4;return this.maintainAspectRatio&&a?n.CropType.ScaleCrop:this.forma.isGridCell()||this.userGroupChild?n.CropType.PreserveFocus:n.CropType.PreserveFocusAndScale}return n.CropType.PreserveFocus},setChildrenCropping:function(e,t){var r=this;this.forma.visitAll(g.FormaTraversal.JustChildren,(function(o){var n;(n=i.as(o.controller,R.ImageController))&&null!=o.bounds&&n.setCrop(r.forma.bounds,t,e)})),this.fitChildrenToFrame()},isBackgroundImageWithAlpha:function(){var e,t,r=!1;return(e=this.forma)&&(t=this.image)&&(r=e.isBackgroundImage()&&(t.hasAlpha()||this.hasCutout)),r},canHaveNoneFillColor:function(){return this.floating&&this.hasCutout},fitChildrenToFrame:function(e){void 0===e&&(e=!1);var t,r,o=this;if(this.forma.visitAll(g.FormaTraversal.JustChildrenAndAuxiliaries,(function(t){var r,n;if(null!=t.bounds&&null!=o.forma.bounds)if(r=i.as(t,A.ImageForma)){if(!r.hasIntent(g.Forma.INTENT_IMAGE_MASK))if(i.opt(r.animation,(function(e){return e.invalidate()})),e||!r.hasAlpha()||r.hasIntent(g.Forma.INTENT_PATTERN))o.ensureFormaFillsFrame(r,e);else{var a,l=1;(a=i.opt(r.page.view,(function(e){return e.getViewportTransform()})))&&(l=Math.sqrt(Math.abs(a.determinant)));var s=o.userGroupMember?.01:30;o.beginBlockedUpdate(),f.DragFacade.rescueToArbitraryBounds(r,o.forma.bounds,o.forma.totalPlacement,36/l,s/l),o.endBlockedUpdate()}}else if(n=i.as(t,H.ShapeForma)){var u=o.forma.bounds;n.size=u.size,n.placement=N.Matrix2D.Identity}})),(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(r=t.bounds)){var n,a,l;if((n=i.as(B.ImageFacade.getMaskFormaForForma(this.forma),A.ImageForma))&&(a=n.bounds)){var s=r.transform(t.placement);n.placement=N.Matrix2D.Identity.scaleXY(s.width/a.width,s.height/a.height).translateXY(t.placement.tx,t.placement.ty)}(l=B.ImageFacade.getCutoutMaskFormaForForma(this.forma))&&B.ImageFacade.updateCutoutMaskPlacement(this.forma,l)}},ensureFormaFillsFrame:function(e,t){void 0===t&&(t=!1);var r=this.forma.bounds.transform(e.placement.inverse),o=r.height/e.bounds.height,n=r.width/e.bounds.width,i=U.MathUtils.maxDouble(n,o);(i>1||t)&&(e.move(N.Matrix2D.uniformScaling(i)),r=this.forma.bounds.transform(e.placement.inverse)),r.minX<e.bounds.minX&&(e.placement=e.placement.precat(N.Matrix2D.translationXY(r.minX-e.bounds.minX,0)),r=this.forma.bounds.transform(e.placement.inverse)),r.maxX>e.bounds.maxX&&(e.placement=e.placement.precat(N.Matrix2D.translationXY(r.maxX-e.bounds.maxX,0)),r=this.forma.bounds.transform(e.placement.inverse)),r.minY<e.bounds.minY&&(e.placement=e.placement.precat(N.Matrix2D.translationXY(0,r.minY-e.bounds.minY)),r=this.forma.bounds.transform(e.placement.inverse)),r.maxY>e.bounds.maxY&&(e.placement=e.placement.precat(N.Matrix2D.translationXY(0,r.maxY-e.bounds.maxY)),r=this.forma.bounds.transform(e.placement.inverse))},isImageCropped:function(){var e,t,r;return!!((e=i.opt(this.forma,(function(e){return e.bounds})))&&(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(r=t.bounds))&&!r.transform(t.placement).equalWithAccuracy(e,.001)},getAverageEdgeGrid:function(e,t){void 0===t&&(t=!0);var r,o=[];if(r=this.forma.frame)for(var n=new J.TheoSize(r.width/e.width,r.height/e.height),a=i.iter(i.range(0,i.toInt(e.width),!1));!a.done;a.next())for(var l=a.value,s=i.iter(i.range(0,i.toInt(e.height),!1));!s.done;s.next()){var u=s.value,c=Z.TheoRect.fromXYWH(i.toDouble(l)*n.width+r.origin.x,i.toDouble(u)*n.height+r.origin.y,n.width,n.height),d=this.getAverageEdge(c);o.push(d)}if(t){for(var h=[],m=1e-5,f=i.iter(o);!f.done;f.next())m+=d=f.value;for(var g=i.iter(o);!g.done;g.next())d=g.value,h.push(d/m);return h}return o},getAverageEdge:function(e){var t,r=0;if(t=this.forma){var o=e.transform(t.placement.inverse);t.visitAll(g.FormaTraversal.JustChildren,(function(e){var t;(t=i.as(e,A.ImageForma))&&(r+=t.getAverageEdge(o))}))}return r},getFaceIntersections:function(e){var t,r=0;if(t=this.forma){var o=e.transform(t.placement.inverse);t.visitAll(g.FormaTraversal.JustChildren,(function(e){var t;(t=i.as(e,A.ImageForma))&&(r+=t.getFaceIntersections(o))}))}return r},getAverageColor:function(e){var t;if(t=this.forma){var r,o,n,i,a=e.transform(t.placement.inverse);if((r=B.ImageFacade.getImageFormaForForma(t))&&(o=r.getAverageColor(a)))return(n=B.ImageFacade.getCutoutMaskFormaForForma(this.forma))&&(i=n.getAverageColor(a))?new X.SolidColor(o.red,o.green,o.blue,i.red):o}return null},maintainAspectRatio:{get:function(){var e,t=B.ImageFacade.inCropMode(this.forma);return t&&(e=i.opt(this.mask,(function(e){return e.controller})))?e.maintainAspectRatio:this.floating&&!(t&&B.ImageFacade.usesFreeformCropPreset(this.forma))}},clip:{get:function(){return!0}},placeAsLogo:function(){var e,t,r,o;if((e=i.as(this.forma,C.FrameForma))&&(t=e.root)&&(r=B.ImageFacade.getImageFormaForForma(e))&&(o=r.bounds)&&r.isLogo()){var a,l=.12*Math.max(t.finalFrame.height,t.finalFrame.width);if(o.aspectRatio>1?this.fitWithCrop(new Z.TheoRect(0,0,l,l/o.aspectRatio),n.CropType.FitBorder):this.fitWithCrop(new Z.TheoRect(0,0,l*o.aspectRatio,l),n.CropType.FitBorder),a=new E.LogoPlacementSuggester(e,t).fastPlacement()){var s=new D.FormaTransformChangedEvent(e);s.duration=0,e.beginUpdate(s),a.apply(),e.endUpdate(s)}this.bringToForeground()}},bringToForeground:function(){var e,t;(e=i.as(this.forma,C.FrameForma))&&(t=e.parent)&&(t.removeChild(e),t.appendChild(e))},addForma:function(e,t,r){var l,c,d,h;if((l=i.as(e.root,O.RootForma))&&(c=i.as(t,C.FrameForma))&&(d=B.ImageFacade.getImageFormaForForma(c))&&(h=G.GridFacade.getPageGrid(t.page,!0))){if(null==d.frame||r.parentingHint==s.AddFormaParentingHint.addToRoot)return l.appendChild(t),u.CorePromise.resolve(null);var m=!1;if(r.floatingImageStrategy==s.FloatingImageStrategy.Always?(m=!0,d.isLogo()||(d.intent=g.Forma.INTENT_FLOATING_IMAGE)):r.floatingImageStrategy==s.FloatingImageStrategy.IfHasAlphaOrIsLogo&&(d.isLogo()||d.hasAlpha())&&(m=!0),c.allowUserMove=m,m)h.forma.appendChild(c);else{for(var f=i.clone(l.filterWithCallback((function(e){return e.isBackgroundImage()}))),p=i.iter(f);!p.done;p.next()){var v,b=p.value;if(v=B.ImageFacade.getImageStyleForForma(b)){var I=v.clone();I.adjustments=k.ImageAdjustments.createDefault(),B.ImageFacade.applyImageStyle(I,[d])}}h.addFormaToGroup(c)}i.opt(_.Host.logging,(function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsImageAddedToFrame,{hasAlpha:d.hasAlpha()?"true":"false",isLogo:d.isLogo()?"true":"false",isBackground:m?"false":"true"})}));var S=1==l.filterWithCallback((function(e){return B.ImageFacade.isPotentialBackgroundImage(e)})).length;if(m){if(!d.isLogo())return new u.CorePromise((function(e,a){var s;(s=i.opt(d.contentNode,(function(e){return e.image})))?s.whenLoaded().then((function(a){if(r.suggestPlacement){var s,u,d=new F.FormaPlacementSuggester(t,l);(s=i.as(d.fastPlacement(),y.FormaPlacementSuggestion))&&(u=i.as(c.controller,o))&&u.fitWithCrop(s.location,n.CropType.FitBorder)}else i.opt(t.controller,(function(e){return e.fit(l.frame.insetRel(.25,.25,.25,.25))}));return S&&l.page.colorLibraryController.extractImageColors(),e(null)})):e(null)}));i.as(c.controller,o).placeAsLogo()}else if(S)return new u.CorePromise((function(e,t){var r;if(!(r=i.opt(d.contentNode,(function(e){return e.image}))))return e(null);r.whenLoaded().then((function(t){return l.page.colorLibraryController.extractImageColors(),e(null)}))}));return u.CorePromise.resolve(null)}return u.CorePromise.reject("couldn't get critical references")},getCurrentColors:function(e){var t;if(t=this.forma)for(var r=i.iter(t.visitAsArray(g.FormaTraversal.JustChildren));!r.done;r.next()){var o=r.value;if(o.kind==A.ImageForma.KIND)return o.controller.getCurrentColors(e)}return[]},replaceWithColoredShape:function(){var e,t,r;return(e=this.forma)&&(t=i.as(e.page.createFormaWithController(H.ShapeForma.KIND,z.ShapeController.KIND),H.ShapeForma))&&(W.ShapeLibrary.applyToShapeForma(t,W.ShapeLibrary.Square),t.contentID=null,t.preScale=null,t.allowUserMove=!1,(r=e.parent)&&(r.controller.replaceChildWithForma(e,t),null!=r.indexOfChild(t)&&null==e.parent))?t:null},replaceable:{get:function(){return!0}},cropSizeCheck:function(){var e,t;(e=this.forma)&&(t=e.finalFrame)&&(e.visitAll(g.FormaTraversal.JustChildren,(function(r){var o,a;(o=i.as(r.controller,R.ImageController))&&(a=r.finalFrame)&&t.area<.4*a.area&&o.setCrop(e.bounds,null,n.CropType.FitBorder)})),this.fitChildrenToFrame())},postDecode:function(){var e;(e=i.opt(this.forma,(function(e){return e.style})))&&e.kind==I.FormaStyle.KIND&&i.opt(this.forma,(function(t){return t.applyStyle(S.FrameStyle.init_6c45(e.opacity,e.colors.clone()))}))},containsPoint:function(e,t){return void 0===t&&(t=0),!!x.GroupController.prototype.containsPoint.call(this,e,t)&&(!(r=i.as(this.mask,H.ShapeForma))||r.containsPoint(e));var r},applyOpacity:function(e){for(var t=i.iter(this.forma.visitAsArray(g.FormaTraversal.JustChildren));!t.done;t.next()){var r=t.value;i.opt(r.controller,(function(t){return t.applyOpacity(e)}))}},annotations:{get:function(){return i.opt(i.opt(this.image,(function(e){return e.controller})),(function(e){return e.annotations}))}}}}),o)},"9Lk3":function(e,t,r){var o,n,i=t,a=r("oAGj"),l=r("yhkb"),s=r("C42b"),u=r("HWAX"),c=r("ascj"),d=r("quOg"),h=r("FNB+"),m=r("6ZWm"),f=r("waL6"),g=r("cmoc"),p=r("P83h"),v=r("ZK0l"),C=r("tQF8"),F=r("/afT"),y=r("pnSN"),b=r("v/sv"),I=r("4mVB"),S=r("iCxV"),D=r("fdtz"),T=r("lmwz"),x=r("fNpk"),G=r("c+uM"),M=r("tGKA"),P=r("3DEm"),_=r("jcfx"),k=r("JFv5"),R=r("JO5d"),w=r("djAF"),A=r("35Q0"),B=r("T6jX"),L=r("8t9B"),E=r("oKlP"),N=r("sIWg"),U=r("1NAc");i.ResizeCellInfo=(o=function(){},a.defineClass({name:"ResizeCellInfo",ctor:o,props:{init_d41d:function(){this.handle=null,this.newRect=N.TheoRect.Zero},init_implicit:function(e,t){this.handle=e,this.newRect=t},clone:function(){return o.init_implicit(this.handle,this.newRect)}}}),o),i.PROPERTY_FORMA_MAPPING="forma-mapping",i.GridController=(n=function(e,t,r){this.imageInitState_={},this.moveableInitState_={},this.checkFramesForCropping_=[],this.gridBounds_=new N.TheoRect(0,0,1,1),v.GroupController.call(this,e,t,r)},a.defineClass({name:"GridController",ctor:n,superName:"GroupController",statics:{KIND:{get:function(){return"grid"}},MAX_IMAGE_COUNT:{get:function(){return 16}},MAX_CELL_COUNT:{get:function(){return 16}},MIN_CELL_DIM:{get:function(){return 75}},isBackgroundColoredCell:function(e){return e.isGridCell()&&e instanceof w.ShapeForma&&null!=e.controller&&!e.controller.floating},hasLayoutPadding:function(e){var t,r=!1;return(t=a.as(a.opt(e.parent,(function(e){return e.controller})),n))&&(r=t.margin>0||t.spacing>0),r}},props:{gridForma:{get:function(){return this.forma}},gridStyle:{get:function(){return a.as(a.opt(this.forma,(function(e){return e.style})),I.GridStyle)},set:function(e){var t=this;a.opt(e,(function(e){return e.forma=t.forma})),a.opt(this.forma,(function(t){return t.protectedSetStyle(e)}))}},gridCells:{get:function(){return this.gridStyle.gridCells}},backgroundGridCells:{get:function(){return this.gridStyle.nonOverlappingCells()}},foregroundGridCells:{get:function(){return this.gridStyle.overlappingCells()}},formaMapping:{get:function(){return this.gridStyle.formaMapping}},formaMappingSwiftDict:{get:function(){return this.formaMapping}},formaMappingDeepCopy:{get:function(){for(var e={},t=a.iter(a.keys(this.formaMapping));!t.done;t.next()){var r=t.value,o=this.formaMapping[r];e[r]=o.clone()}return e}},selectable:{get:function(){return!0}},moveable:{get:function(){return!1}},rotateable:{get:function(){return!1}},flippable:{get:function(){return!1}},nudgeable:{get:function(){return!1}},canDeleteCellForForma:function(e){if(e.controller.moveable)return!0;if(e.controller.floating)return!0;var t;if(this.gridStyle.numBackgroundCells>1&&(t=this.formaMapping[e.formaID])){if(null!=this.getMergeCell(t))return!0;if(null!=this.getResizeCellToZeroInfo(t))return!0}return!1},getMergeCell:function(e){for(var t=null,r=a.iter(this.gridCells);!r.done;r.next()){var o=r.value;!a.eq(C._equality_GridCell_GridCell,o,e)&&o.mergeableWith(e)&&(null!=t&&0!=this.backgroundImagesForCell(t).length||(t=o))}return t},getResizeCellToZeroInfo:function(e){var t=null;if(this.gridStyle.numBackgroundCells>1){var r=this.getCellRegion(e),o=this.gridForma.frame,n=e.bounds;if(r.minX>o.minX+this.margin+1&&this.canRemoveFromHandleDirection(e,C.GridCellHandle.Left)?(t=C.GridCellHandle.Left,n=new N.TheoRect(n.maxX,n.minY,n.maxX,n.maxY)):r.maxX<o.maxX-this.margin-1&&this.canRemoveFromHandleDirection(e,C.GridCellHandle.Right)?(t=C.GridCellHandle.Right,n=new N.TheoRect(n.minX,n.minY,n.minX,n.maxY)):r.minY>o.minY+this.margin+1&&this.canRemoveFromHandleDirection(e,C.GridCellHandle.Top)?(t=C.GridCellHandle.Top,n=new N.TheoRect(n.minX,n.maxY,n.maxX,n.maxY)):r.maxY<o.maxY-this.margin-1&&this.canRemoveFromHandleDirection(e,C.GridCellHandle.Bottom)&&(t=C.GridCellHandle.Bottom,n=new N.TheoRect(n.minX,n.minY,n.maxX,n.minY)),null!=t){var l=a.clone(i.ResizeCellInfo.init_d41d());return l.handle=t,l.newRect=n,l}}return null},maxMargin:{get:function(){for(var e,t=this.forma.bounds,r=this.forma.finalFrame,o=null,n=a.iter(this.backgroundGridCells);!n.done;n.next()){var i=n.value,l=t.evalRect(i.bounds).transform(this.forma.totalPlacement);o=null==o?l:a.opt(o,(function(e){return e.unionWith(l)}))}return(e=o)?Math.max(P.MathUtils.absDouble(r.minX-e.minX),P.MathUtils.absDouble(r.maxX-e.maxX),P.MathUtils.absDouble(r.minY-e.minY),P.MathUtils.absDouble(r.maxY-e.maxY)):0}},margin:{get:function(){for(var e=this.forma.bounds,t=this.forma.finalFrame,r=Math.max(t.width,t.height),o=a.iter(this.backgroundGridCells);!o.done;o.next()){var n=o.value,i=e.evalRect(n.bounds).transform(this.forma.totalPlacement),l=Math.min(P.MathUtils.absDouble(t.minX-i.minX),P.MathUtils.absDouble(t.maxX-i.maxX),P.MathUtils.absDouble(t.minY-i.minY),P.MathUtils.absDouble(t.maxY-i.maxY));r=Math.min(r,l)}return r},set:function(e){this.setMargin(e)}},setMargin:function(e,t){void 0===t&&(t=!0);var r=this.margin;if(e!=r){var o=this.forma.bounds.transform(this.forma.totalPlacement),i=this.gridStyle.clone();0==r&&!this.isBackgroundVisible()&&t&&this.setContrastingGridBackgroundColor();for(var l=!0,s=(o.width-2*e)/o.width,u=(o.height-2*e)/o.height,c=e/o.width,d=e/o.height,h=(o.width-2*r)/o.width,m=(o.height-2*r)/o.height,f=r/o.width,g=r/o.height,p=a.iter(this.backgroundGridCells);!p.done;p.next()){var v=(F=p.value).bounds.offsetXY(-f,-g).multiplyXY(1/h,1/m);a.opt(this.gridStyle,(function(e){return e.updateCell(F,v.multiplyXY(s,u).offsetXY(c,d))}))}for(var C=a.iter(this.backgroundGridCells);!C.done;C.next()){var F=C.value,y=this.getCellRegion(F);Math.min(y.width,y.height)<n.MIN_CELL_DIM&&(l=!1)}l?(this.resetMoveableFormaToInitialSizes(),this.layoutGrid(this.gridStyle.moveableShift,null,a.clone(this.preUpdateMapping_),this.preUpdateSpacing_)):this.gridStyle=a.as(i,I.GridStyle)}},getLogos:function(){return this.moveableFormae().filter((function(e){return e.isLogo()}),this)},getBackgroundShapes:function(){return this.forma.filterWithCallback((function(e){return n.isBackgroundColoredCell(e)}),h.FormaTraversal.JustChildren)},setMarginAndSpacing:function(e,t){t>=0&&(this.margin=t),e>=0&&(this.spacing=e)},linkedFormaForChild:function(e,t){var r=a.clone(this.forma.visitAsArray(h.FormaTraversal.JustChildren));if(a.remove(r,e),this.owner.interactionMode==d.InteractionMode.AutomaticGrid){if(e.isShape()||e.isBackgroundImage())return r}else if(e.isShape()||e.isImage())return e.controller.moveable?this.moveableFormae():this.forma.filterWithCallback((function(t){return(t.isBackgroundImage()||t.isShape())&&null!=t.controller&&!a.eq(h._equality_Forma_Forma,t,e)}));return[]},isBackgroundVisible:function(){if(this.gridStyle.spacing>0)return!0;for(var e=1,t=0,r=1,o=0,n=a.clone(this.backgroundGridCells),i=a.iter(n);!i.done;i.next()){var l=i.value;e=Math.min(e,l.bounds.minX),t=Math.max(t,l.bounds.maxX),r=Math.min(r,l.bounds.minY),o=Math.max(o,l.bounds.maxY)}return e>0||r>0||t<1||o<1},styleChanged:function(){var e=this;a.opt(this.gridStyle,(function(t){return t.forma=e.forma}))},getBoundaryCells:function(e){return this.filterBoundaryCells(a.clone(this.backgroundGridCells),e)},filterBoundaryCells:function(e,t){for(var r=[],o=a.iter(e);!o.done;o.next()){for(var n=o.value,i=!0,l=a.iter(e);!l.done;l.next()){var s=l.value;a.eq(C._equality_GridCell_GridCell,n,s)||(t==C.GridCellHandle.Left&&s.bounds.maxX-.01<=n.bounds.minX&&(i=!1),t==C.GridCellHandle.Right&&s.bounds.minX+.01>=n.bounds.maxX&&(i=!1),t==C.GridCellHandle.Top&&s.bounds.maxY-.01<=n.bounds.minY&&(i=!1),t==C.GridCellHandle.Bottom&&s.bounds.minY+.01>=n.bounds.maxY&&(i=!1))}i&&r.push(n)}return r},filterCellsByDirection:function(e,t,r){x.LegacyCoreAssert.isTrue(["vertical","horizontal"].includes(r),"unknown direction",{direction:r},"GridController.filterCellsByDirection","GridController.swift",442);for(var o=[],n=a.iter(t);!n.done;n.next()){var i=n.value;"horizontal"==r?a.toDouble(Math.round(1e3*Math.max(e.bounds.minY,i.bounds.minY))/1e3)<a.toDouble(Math.round(1e3*Math.min(e.bounds.maxY,i.bounds.maxY))/1e3)&&o.push(i):"vertical"==r&&a.toDouble(Math.round(1e3*Math.max(e.bounds.minX,i.bounds.minX))/1e3)<a.toDouble(Math.round(1e3*Math.min(e.bounds.maxX,i.bounds.maxX))/1e3)&&o.push(i)}return o},spacing:{get:function(){return this.gridStyle.spacing},set:function(e){var t=this.gridStyle.spacing;if(t!=e){0!=t||this.isBackgroundVisible()||this.setContrastingGridBackgroundColor(),this.gridStyle.spacing=e;for(var r=a.iter(this.gridCells);!r.done;r.next()){var o=r.value,i=this.getCellRegion(o);if(Math.min(i.width,i.height)<n.MIN_CELL_DIM)return void(this.gridStyle.spacing=t)}this.resetMoveableFormaToInitialSizes(),this.layoutGrid(this.gridStyle.moveableShift,null,a.clone(this.preUpdateMapping_),this.preUpdateSpacing_)}}},setContrastingGridBackgroundColor:function(){for(var e=this.forma.page.colorLibraryController,t=e.getThemeColorKeys().concat(l.ColorLibraryController.THEME_DERIVED_BW_KEYS),r=[],o=a.iter(this.gridCells);!o.done;o.next()){var n,i=o.value;null!=this.backgroundShapeFormaForCell(i)&&null!=i.colorID&&(t.includes(i.colorID)&&a.remove(t,i.colorID),(n=e.getSolidColorForKey(i.colorID))&&r.push(n),x.LegacyCoreAssert.isTrue(null!=e.getSolidColorForKey(i.colorID),"why is the grid color nil??",void 0,"GridController.setContrastingGridBackgroundColor","GridController.swift",523))}0==(t=t.filter((function(t){var o=e.getSolidColorForKey(t);if(null==o)return!1;for(var n=o,i=a.iter(r);!i.done;i.next()){var l=i.value;if(!n.contrasts(l,!1))return!1}return!0}),this)).length&&(t=this.forma.page.colorLibraryController.getThemeColorKeys().concat(l.ColorLibraryController.THEME_DERIVED_BW_KEYS));var u=this.forma.root.style.colors.colorID(c.ColorRole.FieldPrimary);if(null==u||!t.includes(u)){var d=t[s.CoreRandom.nextIntUniform(t.length)];this.forma.root.style.colors.setColorId(c.ColorRole.FieldPrimary,d)}},showHandle:function(e){for(var t=0,r=a.iter(this.gridCells);!r.done;r.next())t+=r.value.bounds.area;return t<.99||v.GroupController.prototype.showHandle.call(this,e)},selectionHandlePositions:{get:function(){for(var e=[],t=a.iter(this.gridCells);!t.done;t.next())for(var r=t.value,o=a.iter(C.GridCell.handles());!o.done;o.next()){var n=o.value,i=r.handlePosition(n);if(this.shouldShowHandle(i,r,n)){for(var l=!1,s=a.iter(e);!s.done;s.next())s.value.distanceTo(i)<.001&&(l=!0);l||e.push(i)}}for(var u=[],c=[],d=a.iter(e);!d.done;d.next()){var h=d.value;if(!c.includes(h)){var m=[];m.push(h);for(var f=a.iter(e);!f.done;f.next()){var g=f.value;h==g||c.includes(g)||this.mergeableHandlePoints(h,g)&&m.push(g)}u.push(this.mergeHandlePoints(a.clone(m)));for(var p=a.iter(m);!p.done;p.next()){var v=p.value;c.push(v)}}}return u}},mergeableHandlePoints:function(e,t){if(e.x==t.x||e.y==t.y){for(var r=new N.TheoRect(e.x,e.y,t.x,t.y).outsetXY(.001,.001),o=a.iter(this.gridCells);!o.done;o.next())if(o.value.bounds.insetRel(.01,.01,.01,.01).intersects(r))return!1;for(var n=a.iter(this.gridCells);!n.done;n.next())if(n.value.bounds.insetRel(.01,.01,.01,.01).intersects(r))return!1;return!0}return!1},mergeHandlePoints:function(e){if(e.length>0){for(var t=e[0].x,r=e[0].x,o=e[0].y,n=e[0].y,i=a.iter(e);!i.done;i.next()){var l=i.value;t=Math.min(t,l.x),r=Math.max(r,l.x),o=Math.min(o,l.y),n=Math.max(n,l.y)}var s=new E.TheoPoint(.5,.5);return a.sort(e,(function(e,t){return e.distanceTo(s)<t.distanceTo(s)}))[0]}return x.LegacyCoreAssert.fail("not enough points",void 0,"GridController.mergeHandlePoints","GridController.swift",694),E.TheoPoint.ZERO},shouldShowHandle:function(e,t,r){for(var o=P.MathUtils.absDouble(e.x)>.01&&P.MathUtils.absDouble(e.y)>.01&&P.MathUtils.absDouble(1-e.x)>.01&&P.MathUtils.absDouble(1-e.y)>.01,n=0,i=a.iter(this.gridCells);!i.done;i.next()){var l=i.value;!a.eq(C._equality_GridCell_GridCell,t,l)&&this.adjacentCellForHandle(t,l,r)&&(n+=1)}return n<=1&&o},adjacentCellForHandle:function(e,t,r){if(e.bounds.L1Distance(t.bounds)>.01)return!1;var o=t.bounds.center.y>=e.bounds.minY&&t.bounds.center.y<=e.bounds.maxY&&e.bounds.height>t.bounds.height+.05,n=t.bounds.center.x>=e.bounds.minX&&t.bounds.center.x<=e.bounds.maxX&&e.bounds.width>t.bounds.width+.05;return!!(r==C.GridCellHandle.Left&&o&&t.bounds.center.x<e.bounds.center.x||r==C.GridCellHandle.Right&&o&&t.bounds.center.x>e.bounds.center.x||r==C.GridCellHandle.Top&&n&&t.bounds.center.y<e.bounds.center.y||r==C.GridCellHandle.Bottom&&n&&t.bounds.center.y>e.bounds.center.y)},getCellBackgroundShape:function(e){var t=this.cellForForma(e);if(null!=t)for(var r=a.iter(this.formaeForCell(t));!r.done;r.next()){var o=r.value;if(o instanceof w.ShapeForma&&n.isBackgroundColoredCell(o))return a.as(o,w.ShapeForma)}return null},getCellBackgroundImage:function(e){if(null!=e.controller&&e.controller.floating)return null;var t=this.cellForForma(e);if(null!=t)for(var r=a.iter(this.formaeForCell(t));!r.done;r.next()){var o,n=r.value;if(n.isBackgroundImage()&&(o=a.as(n,g.FrameForma)))return T.ImageFacade.getImageFormaForForma(o)}return null},childToSelect:function(){var e=a.clone(this.foregroundGridCells);if(0==e.length){var t=new E.TheoPoint(.5,.5);e=a.sort(this.backgroundGridCells,(function(e,r){return e.bounds.center.distanceTo(t)<r.bounds.center.distanceTo(t)}))}for(var r=a.clone(this.moveableFormae()),o=a.iter(e);!o.done;o.next())for(var n=o.value,i=a.iter(this.formaeForCell(n));!i.done;i.next()){var l=i.value;if(!a.containsEq(r,l,h._equality_Forma_Forma))return l}return this.forma},findCellHandle:function(e){for(var t=a.iter(this.gridCells);!t.done;t.next())for(var r=t.value,o=a.clone(C.GridCell.handlePositions()),n=a.iter(o);!n.done;n.next()){var i=n.value;if(r.bounds.eval(i).distanceTo(e)<.01)return[r,C.GridCell.handleForPosition(i)]}return[null,null]},containsPoint:function(e,t){void 0===t&&(t=0);for(var r=a.iter(this.gridCells);!r.done;r.next()){var o=r.value,n=this.getCellRegion(o);if(0!=t&&(n=n.outsetXY(t,t)),n.containsPoint(e))return!0}return!1},processFormaClick:function(e){a.eq(h._equality_Forma_Forma,e.forma,this.forma)||v.GroupController.prototype.processFormaClick.call(this,e)},beforeProcessFormaDrag:function(e){var t;(t=this.cellForForma(a.first(e.dragDelegate.draggedFormae)))&&(this.dragShapeInitBounds_=t.bounds),this.geomEventAroundChildDrag=new p.FormaGeometryChangedEvent(this.forma),this.forma.beginUpdate(this.geomEventAroundChildDrag)},processFormaDrag:function(e){this.beforeProcessFormaDrag(e),v.GroupController.prototype.processFormaDrag.call(this,e),this.afterProcessFormaDrag(e)},afterProcessFormaDrag:function(e){this.processChildFormaDrag(a.first(e.dragDelegate.draggedFormae),e),this.forma.endUpdate(this.geomEventAroundChildDrag),this.geomEventAroundChildDrag=null},processChildFormaDrag:function(e,t){if(e.controller.kind!=n.KIND){var r=this.cellForForma(e);if(null!=r&&e.kind==w.ShapeForma.KIND&&n.isBackgroundColoredCell(e)&&a.containsEq(this.foregroundGridCells,r,C._equality_GridCell_GridCell)&&null!=this.dragShapeInitBounds_){var o=this.forma.finalFrame,i=e.finalFrame,l=-1*Math.min(0,i.minX-o.minX),s=-1*Math.min(0,i.minY-o.minY);i.maxX>o.maxX&&(l=o.maxX-i.maxX),i.maxY>o.maxY&&(s=o.maxY-i.maxY),e.move(M.Matrix2D.translationXY(l,s)),i=e.finalFrame;for(var u=this.gridStyle.updateCell(r,N.TheoRect.fromXXYY((i.minX-o.minX)/o.width,(i.maxX-o.minX)/o.width,(i.minY-o.minY)/o.height,(i.maxY-o.minY)/o.height)),c=u.bounds.origin.subtract(this.dragShapeInitBounds_.origin),d=a.clone(this.moveableFormae()),m=a.iter(this.formaeForCell(u));!m.done;m.next()){var f=m.value;a.containsEq(d,f,h._equality_Forma_Forma)&&f.move(M.Matrix2D.translationXY(c.x*o.width,c.y*o.height))}}}},processChildBeginFormaDrag:function(e,t){this.inferGridCellAssignment()},processEndFormaDrag:function(e){v.GroupController.prototype.processEndFormaDrag.call(this,e),this.processChildEndFormaDrag(e)},afterProcessEndFormaDrag:function(e){this.processChildEndFormaDrag(e)},processChildEndFormaDrag:function(e){this.dragShapeInitBounds_=null,this.inferGridCellAssignment(),a.first(e.dragDelegate.draggedFormae).isTypeLockup()&&this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&this.setInitialFormaSizes()},updateInitStateForForma:function(e){var t={bounds:e.bounds,placement:e.placement};if(this.moveableInitState_[e.id]=t,null!=this.preUpdateMapping_){for(var r=[],o=a.iter(a.keys(this.preUpdateMapping_));!o.done;o.next()){var n=o.value;(u=this.preUpdateMapping_[n])&&r.push(u)}for(var i=null,l=a.iter(r);!l.done;l.next()){var s,u=l.value,c=this.getCellRegion(u,this.forma.bounds),d=e.finalFrame;(s=c.intersectionWith(d))&&s.area/d.area>.8&&(i=u,this.preUpdateMapping_[e.formaID]=u)}null==i?null!=this.preUpdateMapping_[e.formaID]&&a.removeKey(this.preUpdateMapping_,e.formaID):this.preUpdateMapping_[e.formaID]=i}},isChildSwappable:function(e){var t;return(t=a.as(e,D.ImageForma))?this.isChildSwappable(t.parent):null!=e.controller&&!e.controller.moveable},swapGridChildren:function(e,t){var r,o;this.isChildSwappable(e)&&this.isChildSwappable(t)&&(r=this.cellForForma(e))&&(o=this.cellForForma(t))&&this.swapCells(r,o)},swapCells:function(e,t){var r=e,o=t,n=t.colorID;o=this.gridStyle.updateCell(o,null,e.colorID,null),r=this.gridStyle.updateCell(r,null,n,null);for(var i=[],l=[],s=a.iter(this.formaMappingSwiftDict);!s.done;s.next()){var u=s.key,c=s.value;a.eq(C._equality_GridCell_GridCell,c,r)&&i.push(u),a.eq(C._equality_GridCell_GridCell,c,o)&&l.push(u)}for(var h=a.iter(i);!h.done;h.next())u=h.value,this.gridStyle.mapCellToFormaID(u,o);for(var f=a.iter(l);!f.done;f.next())u=f.value,this.gridStyle.mapCellToFormaID(u,r);var g=null;this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&(this.resetMoveableFormaToInitialSizes(),g=a.clone(this.preUpdateMapping_)),this.layoutGrid(this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&this.gridStyle.moveableShift,null,a.clone(g));for(var p=a.iter(i);!p.done;p.next())u=p.value,o.bounds.area<r.bounds.area/2&&(F=a.as(a.opt(this.forma.formaByID(u),(function(e){return e.controller})),m.FrameController))&&F.cropSizeCheck();for(var v=a.iter(l);!v.done;v.next()){var F;u=v.value,r.bounds.area<o.bounds.area/2&&(F=a.as(a.opt(this.forma.formaByID(u),(function(e){return e.controller})),m.FrameController))&&F.cropSizeCheck()}},spacingChangesVisible:{get:function(){return this.gridStyle.numBackgroundCells>1}},enterLayoutMode:function(){this.setInitialFormaSizes(),this.inferGridCellAssignment(),this.updateGridColors()},setInitialFormaSizes:function(){x.LegacyCoreAssert.isTrue(null!=this.gridStyle.forma,"grid style does not have a forma when setting initial sizes",void 0,"GridController.setInitialFormaSizes","GridController.swift",1088),this.preUpdateMapping_=a.clone(this.formaMappingDeepCopy),this.preUpdateSpacing_=this.gridStyle.spacing,a.removeAll(this.moveableInitState_);for(var e=a.iter(this.moveableFormae());!e.done;e.next()){var t,r=e.value;(t=a.as(r.controller,L.TypeLockupController))&&t.centerAlignmentIfSingleLine();var o={bounds:r.bounds,placement:r.placement};this.moveableInitState_[r.id]=o}},onFormaeDeleted:function(e){for(var t=a.iter(e);!t.done;t.next()){var r=t.value;a.removeKey(this.moveableInitState_,r.id)}},beginChildResizeEvent:function(e){this.setImageInitialSizes()},setImageInitialSizes:function(){this.imageInitState_={};for(var e=a.iter(this.forma.visitAsArray(h.FormaTraversal.PreOrder));!e.done;e.next()){var t=e.value;null!=t.controller&&t.controller.moveable&&t.kind==D.ImageForma.KIND&&(this.imageInitState_[t.formaID]=t.placement)}},resetMoveableFormaToInitialSizes:function(){if(!this.blockUpdate)for(var e=a.iter(this.moveableInitState_);!e.done;e.next()){var t,r=e.key,o=e.value;(t=a.as(a.opt(this.forma,(function(e){return e.database.getObject(r)})),h.Forma))&&(t.bounds=o.bounds,t.placement=o.placement)}},resetImageFormaToInitialPlacement:function(){for(var e=a.iter(this.forma.visitAsArray(h.FormaTraversal.PreOrder));!e.done;e.next()){var t,r=e.value;(t=this.imageInitState_[r.formaID])&&(r.placement=t)}},currentResizeCellHandlePosition:function(){return null!=this.resizeCell_?this.resizeCell_.handlePosition(this.resizeCellHandle_):null},clone:function(e){return new f.FormaControllerFactory(this.owner).createController(this.kind,e)},postClone:function(e){var t,r;(t=a.as(e.controller,n))&&(r=t.gridStyle)&&(e.style.forma=e,a.opt(this.gridStyle,(function(e){return e.postCloneMatch(r)})))},contentID:{get:function(){return"grid"}},mappedFormaIDs:function(){x.LegacyCoreAssert.isFalse(a.keys(this.formaMapping).includes(this.forma.formaID),"should be returning the grid id",void 0,"GridController.mappedFormaIDs","GridController.swift",1208);for(var e=[],t=a.iter(this.formaMapping);!t.done;t.next()){var r=t.key;e.push(r)}return e},matchStyle:function(e){var t,r;if(this.matchImageStyles(e),(t=a.as(e,n))&&(r=a.opt(a.opt(e.forma,(function(e){return e.root})),(function(e){return e.style.colors})))){var o=a.clone(this.forma.filterWithCallback((function(e){return n.isBackgroundColoredCell(e)}))),i=a.clone(e.forma.filterWithCallback((function(e){return n.isBackgroundColoredCell(e)})));this.isBackgroundVisible()&&(t.isBackgroundVisible()?o=[e.forma.root].concat(o):o.push(e.forma.root));for(var l=[],s=a.iter(i);!s.done;s.next()){var u=s.value;l.push(u.style.colors)}t.isBackgroundVisible()&&(this.isBackgroundVisible()?l=[r].concat(l):l.push(r));for(var c=a.iter(a.range(0,o.length,!1));!c.done;c.next()){var d=c.value;d<l.length&&o[d].style.colors.match(l[d])}}},matchImageStyles:function(e){var t=a.clone(this.forma.filterWithCallback((function(e){return e.kind==D.ImageForma.KIND}))),r=a.clone(e.forma.filterWithCallback((function(e){return e.kind==D.ImageForma.KIND})));if(t.length>0&&r.length>0)for(var o=a.iter(a.range(0,t.length,!1));!o.done;o.next()){var n=o.value;t[n].match(r[n%r.length])}},match:function(e){this.matchImageStyles(e),this.beginBlockedUpdate(),this.forma.bounds=e.forma.bounds,this.endBlockedUpdate();var t=e.forma.filterWithCallback((function(e){return e.isBackgroundImage()})).length;this.gridStyle.match(e.forma.style);var r,o=this.forma.filterWithCallback((function(e){return e.isBackgroundImage()})).length,i=this.forma.filterWithCallback((function(e){return n.isBackgroundColoredCell(e)})).length,l=e.forma.filterWithCallback((function(e){return n.isBackgroundColoredCell(e)})).length;if(r=a.as(e,n)){o>0&&t>0&&this.matchImageStyles(e);var s=this.gridStyle;if(t<=o){this.splitCellsWithMultipleBackgroundImages(null);var u=0==l&&1==t&&r.maxMargin<10,c=1==l&&0==t&&r.maxMargin<10;(i>0&&(u||c)&&0==s.overlappingCells().length||o+t==0&&l<=1)&&(0==t&&0==o&&1==r.gridStyle.numCells?this.gridStyle.updateCell(this.gridCells[0],null,r.gridCells[0].colorID,null):this.recreateGrid(!1,Math.max(o,1),!1)),Math.abs(r.margin-r.maxMargin)<1&&(this.margin=r.margin)}else if(o<t){for(var d=t-o,h=a.clone(a.shuffle(this.forma.page.colorLibraryController.getThemeColorKeys())),m=a.iter(this.gridCells);!m.done;m.next()){var f;null!=(f=(v=m.value).colorID)&&h.includes(f)&&h.length>d&&a.remove(h,v.colorID)}for(var g=0,p=a.iter(this.gridCells);!p.done;p.next()){var v;null==(v=p.value).colorID&&(this.gridStyle.updateCell(v,null,h[g%h.length],null),g+=1)}}this.layoutGrid(!1),this.cropCheck()}},postMatch:function(e){this.inferBackgroundCellAssignment()},showChildHandle:function(e,t){var r,o,n=this.forma.bounds,i=this.forma.finalFrame;if(((r=a.opt(e.controller,(function(e){return e.userGroupChild})))||null!=r)&&r)return!1;if(e.controller.floating)return!0;if((o=this.cellForForma(e))&&this.gridStyle.overlappingCells().filter((function(e){return a.eq(C._equality_GridCell_GridCell,e,o)}),this).length>0&&i.equalWithAccuracy(e.finalFrame,10))return!0;for(var l=0,s=a.iter(this.backgroundGridCells);!s.done;s.next()){var u=s.value,c=n.evalRect(u.bounds).transform(this.forma.totalPlacement),d=Math.min(P.MathUtils.absDouble(i.minX-c.minX),P.MathUtils.absDouble(i.maxX-c.maxX),P.MathUtils.absDouble(i.minY-c.minY),P.MathUtils.absDouble(i.maxY-c.maxY));l=Math.max(l,d)}var h=e.finalFrame.eval(t);return!(l<.001&&(h.x<5||h.y<5||h.x>e.root.finalFrame.maxX-5||h.y>e.root.finalFrame.maxY-5))},applyGridStyleWithMapping:function(e,t){var r=this.gridStyle,o=a.clone(this.gridCells),n=a.clone(this.formaMappingSwiftDict),i=this.margin;r.match(e),this.updateHierarchy(),this.colorGrid(a.clone(o),a.clone(n)),this.layoutGrid(e.moveableShift),this.setInitialFormaSizes(),r.cropType=m.CropType.PreserveFocus,t&&this.setMargin(i,!1)},applyStyle:function(e,t){var r;if(r=a.as(e,I.GridStyle)){var o;if(this.gridStyle.forma=this.forma,0!=a.count(r.formaMapping)&&0==t)r.spacing=this.gridStyle.spacing,this.applyGridStyleWithMapping(r,!0),o=r;else{var n=null!=this.gridForma.parent&&null!=this.gridForma.root;if(x.LegacyCoreAssert.isTrue(n,"bad things are happening. we're apply a style to a forma which is no longer attached",void 0,"GridController.applyStyle","GridController.swift",1467),!n)return;var i=a.clone(r.numCells==this.gridStyle.numCells?this.formaMappingSwiftDict:null),l=a.clone(new b.GridSuggester(this.gridForma,r,a.clone(i)).createSuggestions());if(l.length>0){var s=l[t%l.length];s.gridStyle.spacing=this.gridStyle.spacing,this.applyGridStyleWithMapping(s.gridStyle,!0),o=s.gridStyle}}null!=o&&o.moveableShift&&this.owner.interactionMode!=d.InteractionMode.DefaultInteraction&&this.adjustLogos(a.clone(this.getLogos())),r.name==this.owner.document.gridLibrary.basicFullDesignGridStyle().name||B.TheoDocumentUtils.enableFastHeuristicsForComplexPage(this.forma.page)||(this.contrastCheck(),this.cropCheck()),x.LegacyCoreAssert.isTrue(null!=this.gridStyle.forma,"grid style does not have a forma after applying",void 0,"GridController.applyStyle","GridController.swift",1494)}},adjustLogos:function(e){for(var t=a.iter(e);!t.done;t.next()){var r,o=t.value;(r=a.as(o.controller,m.FrameController))&&r.placeAsLogo()}},numCells:{get:function(){return this.gridCells.length}},contrastCheck:function(){for(var e=a.iter(this.moveableFormae());!e.done;e.next()){var t,r=e.value;null!=this.formaMapping[r.formaID]&&(t=this.cellForForma(r))&&this.backgroundShapeFormaForCell(t)&&a.opt(r.controller,(function(e){return e.contrastCheck(!1)}))}},cropCheck:function(){for(var e=a.iter(this.checkFramesForCropping_);!e.done;e.next()){var t,r=e.value;(t=a.as(r.controller,m.FrameController))&&t.cropSizeCheck()}},replaceChildWithForma:function(e,t,r){void 0===r&&(r=!1);var o,n,i=this.isReplacedWithSameImage(e,t);if(v.GroupController.prototype.replaceChildWithForma.call(this,e,t,r),e.controller.floating){var l,s,u=e.placement.transformValues,c=t.finalFrame.center;t.placement=t.placement.rotateTo(u.rotCosine,u.rotSine),t.moveCenterToPoint(c),(l=T.ImageFacade.getImageFormaForForma(e))&&(s=T.ImageFacade.getImageFormaForForma(t))&&(s.intent=l.intent)}if((o=this.cellForForma(e))&&(this.gridStyle.replaceMappedForma(e,t),t.isShape())){var d,h,f=this.forma.page.colorLibraryController;(d=this.getContrastingColorForCell(t))&&null!=(h=f.getKeyOfColorInTheme(d))&&this.gridStyle.updateCell(o,null,h,null)}(n=a.as(t.controller,m.FrameController))&&(i||e.controller.floating||n.fitWithCrop(t.frame,m.CropType.FitBorder)),i||e.controller.floating||this.layoutGrid(!1)},isReplacedWithSameImage:function(e,t){var r=a.clone(t.filterByKind(D.ImageForma.KIND)),o=a.clone(e.filterByKind(D.ImageForma.KIND));if(r.length>0&&o.length>0)for(var n=a.iter(r);!n.done;n.next()){var i,l,s=n.value,u=o[0];if((i=a.opt(s.contentNode,(function(e){return e.mediaMetadata})))&&(l=a.opt(u.contentNode,(function(e){return e.mediaMetadata}))))return null!=i.assetID&&null!=l.assetID&&i.assetID==l.assetID}return!1},removeFormaWithoutGridModification:function(e){if(e.isGridCell()){var t=this.cellForForma(e);if(a.opt(t,(function(e){return null==e.colorID}))){var r,o,n=this.forma.page.colorLibraryController;(r=this.getContrastingColorForCell(e))&&null!=(o=n.getKeyOfColorInTheme(r))&&a.opt(t,(function(e){return e.colorID=o}))}}v.GroupController.prototype.removeFormaFromGroup.call(this,e),a.opt(this.gridStyle,(function(t){return t.removeMappingToForma(e)}))},removeFormaFromGroup:function(e){var t;if(v.GroupController.prototype.removeFormaFromGroup.call(this,e),this.forma instanceof y.GroupForma&&(t=this.formaMapping[e.formaID])){if(this.gridStyle.removeMappingToForma(e),e.controller.floating)return;if(e.controller.moveable){for(var r=a.iter(this.formaeForCell(t));!r.done;r.next())l=r.value,this.gridStyle.removeMappingToForma(l);a.opt(this.gridStyle,(function(e){return e.removeCell(t)}))}else{var o,n=this.getMergeCell(t);if(o=n){this.gridStyle.mergeCell(o,t),this.gridStyle.name=I.GridStyle.CUSTOM_LAYOUT_NAME;for(var i=a.iter(this.formaeForCell(t));!i.done;i.next()){var l=i.value;this.gridStyle.removeMappingToForma(l)}this.gridStyle.removeCell(t)}if(null==n){var s,u=this.gridStyle.numBackgroundCells;if(s=this.getResizeCellToZeroInfo(t)){var d=s.newRect,h=s.handle;x.LegacyCoreAssert.isTrue(null!=h,"info needed to resize grid cell to 0 missing handle",void 0,"GridController.removeFormaFromGroup","GridController.swift",1669),x.LegacyCoreAssert.isTrue(d!=N.TheoRect.Zero,"info needed to resize grid cell to 0 has empty rect",void 0,"GridController.removeFormaFromGroup","GridController.swift",1670);var m=this.gridStyle.cellIndex(t);if(this.updateCellRegion(t,d,h,!1),x.LegacyCoreAssert.isTrue(null!=m,"did not find index for cell in grid style",void 0,"GridController.removeFormaFromGroup","GridController.swift",1676),null!=m){for(var f=this.gridStyle.gridCells[m],g=a.iter(this.formaeForCell(f));!g.done;g.next()){var l=g.value;a.opt(this.gridStyle,(function(e){return e.removeMappingToForma(l)}))}this.gridStyle.removeCell(f)}this.gridStyle.removeCell(t),this.gridStyle.name=I.GridStyle.CUSTOM_LAYOUT_NAME}else if(1==u){var p;null!=(p=a.opt(a.opt(this.forma,(function(e){return e.root})),(function(e){return e.style.colors.colorID(c.ColorRole.FieldPrimary)})))&&(this.gridStyle.updateCellByIndex(0,null,p,null),this.margin=0)}else x.LegacyCoreAssert.fail("Should have at least one background cell. Something is wrong.",void 0,"GridController.removeFormaFromGroup","GridController.swift",1695)}this.layoutGrid(!1)}this.preUpdateMapping_=a.clone(this.formaMappingDeepCopy)}1==this.gridStyle.gridCells.length&&this.gridStyle.gridCells[0].bounds.equalWithAccuracy(N.TheoRect.ONE_BY_ONE,.01)&&(this.gridStyle.name=I.GridStyle.SINGLE_LAYOUT_NAME)},canRemoveFromHandleDirection:function(e,t){for(var r=a.iter(this.gridCells);!r.done;r.next()){var o=r.value;if(!a.eq(C._equality_GridCell_GridCell,o,e)&&0==e.bounds.L1Distance(o.bounds)){var n=e.bounds.unionWith(o.bounds);if(t==C.GridCellHandle.Left&&e.bounds.minX==o.bounds.maxX&&n.height!=e.bounds.height)return!1;if(t==C.GridCellHandle.Right&&e.bounds.maxX==o.bounds.minX&&n.height!=e.bounds.height)return!1;if(t==C.GridCellHandle.Bottom&&e.bounds.minY==o.bounds.maxY&&n.width!=e.bounds.width)return!1;if(t==C.GridCellHandle.Top&&e.bounds.maxY==o.bounds.minY&&n.width!=e.bounds.width)return!1}}return!0},setupWithFormae:function(e){var t;if(t=a.as(this.forma,y.GroupForma)){t.removeAllChildren();for(var r=a.iter(e);!r.done;r.next()){var o=r.value;t.appendChild(o)}this.recreateGrid()}},inferGridCellAssignment:function(e){void 0===e&&(e=null);var t,r=null!=e?e:a.opt(this.forma,(function(e){return e.bounds}));if(t=r)for(var o=a.iter(this.moveableFormae());!o.done;o.next()){for(var n=o.value,i=null,l=a.iter(this.gridCells);!l.done;l.next()){var s,u,c=l.value,d=this.getCellRegion(c,t);(s=a.opt(n.frame,(function(e){return e.intersectionWith(r)})))&&(u=d.intersectionWith(s))&&u.area/s.area>.85&&(i=c,this.gridStyle.mapCellToForma(n,c))}null==i&&null!=this.formaMapping[n.formaID]&&this.gridStyle.removeMappingToForma(n)}},backgroundImagesForCell:function(e){for(var t=a.clone(this.forma.visitAsArray(h.FormaTraversal.JustChildren)),r=[],o=a.iter(t);!o.done;o.next()){var n=o.value;a.eq(C._equality_GridCell_GridCell,this.formaMapping[n.formaID],e)&&n.isBackgroundImage()&&r.push(n)}return r},addFormaToGroupWithCurrentImage:function(e){var t,r;if(x.LegacyCoreAssert.isTrue(null!=this.gridStyle.forma,"grid style does not have a forma when adding forma to group with current image",void 0,"GridController.addFormaToGroupWithCurrentImage","GridController.swift",1821),(t=a.as(this.forma,y.GroupForma))&&(r=e.finalFrame)){t.appendChild(e);var o=a.clone(this.backgroundGridCells);if(0==o.length)return void x.LegacyCoreAssert.fail("ERROR: no background cells!",void 0,"GridController.addFormaToGroupWithCurrentImage","GridController.swift",1831);for(var n=o[0],i=a.iter(o);!i.done;i.next()){var l,s=i.value;if(l=this.getCellRegion(s).intersectionWith(r)){var u=this.getCellRegion(n).intersectionWith(r);(null==u||u.area<l.area)&&(n=s)}}this.gridStyle.mapCellToForma(e,n),this.splitCellsWithMultipleBackgroundImages(e),this.layoutGrid(!1)}},addFormaToGroup:function(e){var t,r,o=this;if(x.LegacyCoreAssert.isTrue(null!=this.gridStyle.forma,"grid style does not have a forma when adding forma to group",void 0,"GridController.addFormaToGroup","GridController.swift",1863),(t=a.as(this.forma,y.GroupForma))&&(r=e.finalFrame)){t.appendChild(e);var i=e.isImage()&&!e.controller.floating,l=null,s=null;if(this.owner.selection.forEachSelected((function(e){n.isBackgroundColoredCell(e)&&e.parent==o.forma&&(l=o.cellForForma(e),s=e)})),null!=s&&this.owner.selection.deselectForma(s),null==l)for(var u=!1,c=a.iter(this.backgroundGridCells);!c.done;c.next()){for(var d,m=c.value,f=0!=this.backgroundImagesForCell(m).length,g=a.clone(this.forma.visitAsArray(h.FormaTraversal.JustChildren)),p=a.iter(g);!p.done;p.next()){var v=p.value;a.eq(C._equality_GridCell_GridCell,this.formaMapping[v.formaID],m)&&v.isBackgroundImage()&&(f=!0)}if(f)f==i&&(null==l||l.bounds.area<m.bounds.area&&!u)&&(l=m);else if(null!=l&&u){if(d=this.getCellRegion(m).intersectionWith(r)){var F=this.getCellRegion(l).intersectionWith(r);(null==F||F.area<d.area)&&(l=m)}}else u=!0,l=m}this.gridStyle.mapCellToForma(e,null!=l?l:this.gridCells[0]),this.splitCellsWithMultipleBackgroundImages(e),this.layoutGrid(!1)}},createBasicGrid:function(){var e=this.gridCells[0].colorID,t=[new C.GridCell(new N.TheoRect(0,0,1,1),e)];this.gridStyle.setGridCells(a.clone(t));for(var r=a.iter(this.forma.visitAsArray(h.FormaTraversal.JustChildren));!r.done;r.next()){var o=r.value;o.isBackgroundImage()&&this.gridStyle.mapCellToForma(o,this.gridCells[0])}this.splitCellsWithMultipleBackgroundImages(null)},splitCellsWithMultipleBackgroundImages:function(e){var t;if((t=a.as(this.forma,y.GroupForma))&&t.bounds){for(var r=a.clone(t.visitAsArray(h.FormaTraversal.JustChildren)),o=[],n=a.iter(this.backgroundGridCells);!n.done;n.next()){for(var i=n.value,l=[],s=0,u=a.iter(r);!u.done;u.next()){var c=u.value;a.eq(C._equality_GridCell_GridCell,this.formaMapping[c.formaID],i)&&c.isBackgroundImage()&&(s+=1,l.push(c))}if(a.sortInPlace(l,(function(e,t){return e.finalFrame.center.distanceTo(E.TheoPoint.ZERO)<t.finalFrame.center.distanceTo(E.TheoPoint.ZERO)})),s>1){a.opt(this.gridStyle,(function(e){return e.name=I.GridStyle.CUSTOM_LAYOUT_NAME}));var d=a.indexOfEq(this.gridCells,i,C._equality_GridCell_GridCell),m=this.getCellRegion(i),f=m.width,p=m.height,v=i.bounds,F=f/p>=1;F?f/=a.toDouble(s):p/=a.toDouble(s);var b=s%2==0&&s>2;if(b){var S=Math.max(f/p,p/f),D=f,x=p;F?(D=m.width/a.toDouble(a.toInt(s/2)),x=m.height/2):(D=m.width/2,x=m.height/a.toDouble(a.toInt(s/2))),Math.max(D/x,x/D)<S?(f=D,p=x):b=!1}for(var G=a.toInt(m.width/f),M=a.toInt(m.height/p),P=0,_=a.repeat(a.repeat(1,M),G),k=a.iter(a.range(0,G,!1));!k.done;k.next())for(var R=k.value,w=a.iter(a.range(0,M,!1));!w.done;w.next()){var A,B,L,U=w.value,O=m.aspectRatio;a.eq(h._equality_Forma_Forma,l[P],e)&&(A=a.as(l[P],g.FrameForma))&&(B=T.ImageFacade.getImageFormaForForma(A))&&(L=B.bounds)&&(O=L.aspectRatio),_[R][U]=F?O:1/O,P+=1}if(P=0,b)for(var Y=a.toDouble(i.bounds.width)/a.toDouble(G),z=a.toDouble(i.bounds.height)/a.toDouble(M),X=a.iter(a.range(0,G,!1));!X.done;X.next()){R=X.value;for(var H=a.iter(a.range(0,M,!1));!H.done;H.next()){U=H.value;var W=new N.TheoRect(v.minX+a.toDouble(R)*Y,v.minY+a.toDouble(U)*z,v.minX+a.toDouble(R+1)*Y,v.minY+a.toDouble(U+1)*z),q=new C.GridCell(W,i.colorID);this.gridStyle.insertCell(q,d),this.gridStyle.mapCellToForma(l[P],q),P+=1}}else for(var K=[],V=[],j=[],Z=[],J=a.iter(a.range(0,G,!1));!J.done;J.next()){R=J.value,K=a.clone(_[R]),Z=a.clone(m.split(_[R].length,F,a.clone(K)));for(var Q=a.iter(a.range(0,M,!1));!Q.done;Q.next()){if(U=Q.value,G>0&&0==U){V.splice(0);for(var $=a.iter(a.range(0,G,!1));!$.done;$.next()){var ee=$.value;V.push(_[ee][U])}j=a.clone(m.split(V.length,F,a.clone(V)))}if(Z.length>1){var te=m.locatePoint(Z[U].evalXY(0,0)),re=m.locatePoint(Z[U].evalXY(1,1));W=v.evalUUVV(te.x,re.x,te.y,re.y),q=new C.GridCell(W,i.colorID),this.gridStyle.insertCell(q,d),this.gridStyle.mapCellToForma(l[P],q),P+=1}}j.length>1&&(te=m.locatePoint(j[R].evalXY(0,0)),re=m.locatePoint(j[R].evalXY(1,1)),W=v.evalUUVV(te.x,re.x,te.y,re.y),q=new C.GridCell(W,i.colorID),this.gridStyle.insertCell(q,d),this.gridStyle.mapCellToForma(l[P],q),P+=1)}o.push(i)}}for(var oe=a.iter(o);!oe.done;oe.next())i=oe.value,this.gridStyle.removeCell(i)}},shouldRecreateGrid:function(e){var t;if((t=a.opt(this.forma,(function(e){return e.root})))&&t.isModel)return!1;if(this.gridStyle.anyOverlap)return!1;var r,o,n=this.gridCells.length;if(1==n)return!1;if(n>4)return!1;if((r=a.as(this.forma,y.GroupForma))&&(o=r.bounds)){if(o.similarity(e)<.1)return!1;var i=!1,l=o.aspectRatio>1?o.width/a.toDouble(n)/o.height:o.height/a.toDouble(n)/o.width;if(l=Math.max(l,1/l),n%2==0){var s=0,u=0;o.aspectRatio>1?(s=o.width/a.toDouble(a.toInt(n/2)),u=o.height/2):(s=o.width/2,u=o.height/a.toDouble(a.toInt(n/2)));var c=Math.max(s/u,u/s);c<l&&(l=c)}for(var d=a.iter(this.gridCells);!d.done;d.next()){var h=d.value,m=e.evalRect(h.bounds).aspectRatio;m=Math.max(m,1/m);var f=o.evalRect(h.bounds).aspectRatio;(f=Math.max(f,1/f))-m>=2&&f-l>=1&&(i=!0)}return i}return!1},recreateGrid:function(e,t,r){void 0===e&&(e=!0),void 0===t&&(t=null),void 0===r&&(r=!0),this.assertCorrectLayout();var o=this.forma.filterWithCallback((function(e){return e.kind==D.ImageForma.KIND&&e.parent.isBackgroundImage()})).length,n=null!=t?t:Math.max(o,this.gridCells.length),i=a.clone(this.owner.document.gridLibrary.getGridsByCellNumber(n,!1));if(n==this.gridCells.length){var l=a.opt(this.gridStyle,(function(e){return e.clone()}));i.push(l.flipRegion())}for(var s=this.spacing,u=[],c=a.iter(i);!c.done;c.next()){var d=c.value;d.moveableShift=e;var h=a.clone(r?this.formaMappingSwiftDict:null);a.append(u,new b.GridSuggester(this.forma,d,a.clone(h)).createSuggestions())}if(u.length>0){a.sortInPlace(u,(function(e,t){return e.score>t.score}));var m=u[0];x.LegacyCoreAssert.isTrue(m.gridStyle.moveableShift==e,"moveable shift failing",void 0,"GridController.recreateGrid","GridController.swift",2295),m.gridStyle.spacing=s,this.applyGridStyleWithMapping(m.gridStyle,!0)}else this.createBasicGrid()},childUpdate:function(e){var t;if(void 0===e&&(e=null),this.updatedChild=e,null!=e&&null==this.dragShapeInitBounds_&&this.isGridCell(e)&&(t=e)){this.owner.interactionMode!=d.InteractionMode.AutomaticGrid&&this.updateGridAssignments(),this.updateGridColors();var r=this.cellForForma(t);if(null==r)return void a.opt(S.Host.logging,(function(e){return e.warning("Couldn't match cell")}));var o=this.updatedCellBounds(t,r,!1),n=null;if(P.MathUtils.absDouble(r.bounds.minX-o.minX)>.001?n=C.GridCellHandle.Left:P.MathUtils.absDouble(r.bounds.maxX-o.maxX)>.001?n=C.GridCellHandle.Right:P.MathUtils.absDouble(r.bounds.minY-o.minY)>.001?n=C.GridCellHandle.Top:P.MathUtils.absDouble(r.bounds.maxY-o.maxY)>.001&&(n=C.GridCellHandle.Bottom),null!=n){o=this.updatedCellBounds(t,r,!0),this.updateCellRegion(r,o,n,!0);var i=null;this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&(0==a.count(this.moveableInitState_)&&this.setInitialFormaSizes(),this.resetMoveableFormaToInitialSizes(),i=a.clone(this.preUpdateMapping_)),this.resetImageFormaToInitialPlacement(),this.layoutGrid(this.owner.interactionMode==d.InteractionMode.AutomaticGrid,null,a.clone(i))}}},getAdjustedSpacingsForCell:function(e,t){var r=a.clone(this.backgroundGridCells),o=a.clone(this.filterCellsByDirection(e,a.clone(r),"horizontal")),n=a.clone(this.filterCellsByDirection(e,a.clone(r),"vertical"));o=a.sort(o,(function(e,t){return e.bounds.minX<t.bounds.minX})),n=a.sort(n,(function(e,t){return e.bounds.minY<t.bounds.minY})),o=a.clone(this.removeOverlapCells(a.clone(o),"horizontal")),n=a.clone(this.removeOverlapCells(a.clone(n),"vertical"));for(var i=-1,l=-1,s=a.iter(a.range(0,o.length,!1));!s.done;s.next())if(o[c=s.value].bounds.equalWithAccuracy(e.bounds,C.GridCell.BOUNDS_ACCURACY)){i=c;break}for(var u=a.iter(a.range(0,n.length,!1));!u.done;u.next()){var c;if(n[c=u.value].bounds.equalWithAccuracy(e.bounds,C.GridCell.BOUNDS_ACCURACY)){l=c;break}}var d=t,h=t,m=t,f=t,g=o.length,p=a.toDouble(g-1)/a.toDouble(g);0==i&&(d=0,g>2?h*=p:h/=2),i==g-1&&(h=0,g>2?d*=p:d/=2),g>2&&0!=i&&i!=g-1&&(1==i&&i==g-2?(d*=1-p,h*=1-p):1==i?(d*=1-p,h/=2):i==g-2?(h*=1-p,d/=2):(d/=2,h/=2));var v=n.length,F=a.toDouble(v-1)/a.toDouble(v);return 0==l&&(m=0,v>2?f*=F:f/=2),l==v-1&&(f=0,v>2?m*=F:m/=2),v>2&&0!=l&&l!=v-1&&(1==l&&l==v-2?(m*=1-F,f*=1-F):1==l?(m*=1-F,f/=2):l==v-2?(f*=1-F,m/=2):(m/=2,f/=2)),[d,h,m,f]},updatedCellBounds:function(e,t,r){var o=this.forma.finalFrame,n=r?e.finalFrame.intersectionWith(o):e.finalFrame,i=a.clone(this.gridStyle.overlappingCells()),l=a.containsEq(i,t,C._equality_GridCell_GridCell)?0:this.gridStyle.spacing,s=a.clone(this.getAdjustedSpacingsForCell(t,l)),u=s[0],c=s[1],d=s[2],h=s[3],m=new N.TheoRect(n.minX-u,n.minY-d,n.maxX+c,n.maxY+h);return new N.TheoRect((m.minX-o.minX)/o.width,(m.minY-o.minY)/o.height,(m.maxX-o.minX)/o.width,(m.maxY-o.minY)/o.height)},updateCellRegion:function(e,t,r,o){if(void 0===o&&(o=!0),null!=a.as(this.forma,y.GroupForma)){var i=e.bounds,l=null,s=null,u=null;r==C.GridCellHandle.Left?(l=i.verticalLine(0),s=t.minX):r==C.GridCellHandle.Right?(l=i.verticalLine(1),s=t.maxX):r==C.GridCellHandle.Top?(l=i.horizontalLine(0),u=t.minY):r==C.GridCellHandle.Bottom&&(l=i.horizontalLine(1),u=t.maxY);var c=this.getCellRegion(e,null,t);if(o&&Math.min(c.width,c.height)<n.MIN_CELL_DIM)return a.opt(S.Host.logging,(function(e){return e.info("new cell too small")})),!1;if(null!=s&&(s<0||s>1)||null!=u&&(u<0||u>1))return a.opt(S.Host.logging,(function(e){return e.info("shifted out of bounds  "+i.asString+" -> "+t.asString)})),!1;var d=[],h=[];if(d.push({cell:e,bounds:t}),h.push({cell:e,bounds:e.bounds}),null!=l&&a.containsEq(this.backgroundGridCells,e,C._equality_GridCell_GridCell))for(var m=a.iter(this.gridCells);!m.done;m.next()){var f=m.value;if(!a.eq(C._equality_GridCell_GridCell,f,e)){var g=f.bounds,p=g,v=l.projectionOffset(f.handlePosition(C.GridCellHandle.Left)).length(),F=l.projectionOffset(f.handlePosition(C.GridCellHandle.Right)).length(),b=l.projectionOffset(f.handlePosition(C.GridCellHandle.Top)).length(),I=l.projectionOffset(f.handlePosition(C.GridCellHandle.Bottom)).length();if(null!=s&&(v<F&&v<.02?p=new N.TheoRect(s,g.minY,g.maxX,g.maxY):v>F&&F<.02&&(p=new N.TheoRect(g.minX,g.minY,s,g.maxY))),null!=u&&(I<b&&I<.02?p=new N.TheoRect(g.minX,g.minY,g.maxX,u):I>b&&b<.02&&(p=new N.TheoRect(g.minX,u,g.maxX,g.maxY))),g.minX!=p.minX&&g.maxX!=p.maxX||g.minY!=p.minY&&g.maxY!=p.maxY)return!1;if(c=this.getCellRegion(f,null,p),p.minX<0||p.minY<0||p.maxX>1||p.maxY,o&&Math.min(c.width,c.height)<n.MIN_CELL_DIM)return!1;d.push({cell:f,bounds:p}),h.push({cell:f,bounds:f.bounds})}}for(var D=a.clone(this.gridStyle.nonOverlappingCells()),T=a.iter(d);!T.done;T.next()){var x=T.value;this.gridStyle.updateCell(x.cell,x.bounds)}for(var G=a.iter(D);!G.done;G.next()){if(f=G.value,!this.gridBounds_.contains(f.bounds))return a.opt(S.Host.logging,(function(e){return e.info("out of bounds "+f.bounds)})),!1;f.bounds.area}if(this.gridStyle.nonOverlappingCells().length!=D.length){for(var M=a.iter(this.gridCells);!M.done;M.next())f=M.value,a.opt(S.Host.logging,(function(e){return e.info("gridCell "+f.bounds.asString)}));for(var P=a.iter(h);!P.done;P.next())x=P.value,this.gridStyle.updateCell(x.cell,x.bounds);return!1}return!0}return!1},inferBackgroundCellAssignment:function(){for(var e=a.iter(this.gridCells);!e.done;e.next())for(var t=e.value,r=this.getCellRegion(t),o=a.iter(this.forma.visitAsArray(h.FormaTraversal.JustChildren));!o.done;o.next()){var n,i=o.value;(n=i.finalFrame)&&n.equalWithAccuracy(r,.01)&&(i.controller.moveable&&i.kind!=w.ShapeForma.KIND||this.gridStyle.mapCellToForma(i,t))}},backgroundShapeFormaForCell:function(e,t){void 0===t&&(t=null);for(var r=a.clone(null!=t?t:this.formaMappingSwiftDict),o=a.iter(r);!o.done;o.next()){var n,i=o.key,l=o.value;if(a.eq(C._equality_GridCell_GridCell,l,e)&&(n=this.forma.formaByID(i))&&n.kind==w.ShapeForma.KIND&&this.isGridCell(n))return a.as(n,w.ShapeForma)}return null},isGridCell:function(e){if(e.hasIntent(h.Forma.INTENT_GRID_CELL))return!0;if(a.opt(e.controller,(function(e){return 1==e.floating})))return!1;if(e.hasIntent(h.Forma.INTENT_ICON)||e.hasIntent(h.Forma.INTENT_FLOATING_SHAPE)||e.hasIntent(h.Forma.INTENT_LOGO)||e.hasIntent(h.Forma.INTENT_FLOATING_IMAGE))return!1;if(e.parent==this.forma&&(e.isShape()||e.isImage())){var t,r;if((t=a.as(e,w.ShapeForma))&&null==t.contentNode)return!0;if(e.isBackgroundImage())return!0;if(r=e.finalFrame)for(var o=a.iter(this.gridCells);!o.done;o.next()){var n=o.value;if(this.getCellRegion(n).equalWithAccuracy(r,.1))return!0}if(e.kind==y.GroupForma.KIND)return!1;if(null==a.opt(a.as(e,w.ShapeForma),(function(e){return e.contentNode}))&&e.isShape())return!0}return!1},childMoveableInDirection:function(e,t){if(e.isShape()||e.isImage()){var r,o,n;if((r=this.cellForForma(e))&&a.containsEq(this.foregroundGridCells,r,C._equality_GridCell_GridCell)&&(o=e.finalFrame)&&(n=a.opt(this.forma,(function(e){return e.finalFrame})))){if(Math.abs(o.width-n.width)<2&&t.x>0)return!1;if(Math.abs(o.height-n.height)<2&&t.y>0)return!1}return null==e.allowUserMove||e.allowUserMove}return!0},formaeForCell:function(e){for(var t=[],r=a.iter(this.formaMappingSwiftDict);!r.done;r.next()){var o,n=r.key,i=r.value;a.eq(C._equality_GridCell_GridCell,i,e)&&(o=this.forma.formaByID(n))&&t.push(o)}return t},cellForForma:function(e){var t;return null!=(t=a.opt(this.gridStyle,(function(t){return t.cellForForma(e)})))?t[1]:null},updateGridAssignments:function(){this.forma.bounds;for(var e=a.clone(this.forma.visitAsArray(h.FormaTraversal.JustChildren)),t=a.iter(this.gridCells);!t.done;t.next())for(var r=t.value,o=this.getCellRegion(r),n=a.containsEq(this.foregroundGridCells,r,C._equality_GridCell_GridCell),i=a.iter(e);!i.done;i.next()){var l,s,u=i.value;n&&u.isBackgroundImage()||(l=u.finalFrame)&&(s=l.intersectionWith(o))&&s.area/Math.max(o.area,l.area)>.9&&this.gridStyle.mapCellToForma(u,r)}},beginUpdateGroup:function(e){void 0===e&&(e=null),v.GroupController.prototype.beginUpdateGroup.call(this,e),this.inferGridCellAssignment()},updateGroup:function(){if(!this.blockUpdate){var e=!1,t=null,r=null;if(null!=this.oldBounds){t=a.clone(this.formaMappingSwiftDict),this.beginBlockedUpdate();var o=this.margin,n=this.maxMargin;r=this.spacing,this.updateGridColors(),this.inferGridCellAssignment(this.oldBounds);for(var i=a.iter(this.moveableFormae());!i.done;i.next()){var l=i.value;(null==this.formaMapping[l.formaID]||this.formaMapping[l.formaID].bounds.equalWithAccuracy(N.TheoRect.ONE_BY_ONE,C.GridCell.BOUNDS_ACCURACY))&&(e=!0)}if(e)for(var s=a.iter(this.moveableFormae());!s.done;s.next())l=s.value,this.gridStyle.removeMappingToFormaID(l.formaID);!e&&this.shouldRecreateGrid(this.oldBounds)&&this.recreateGrid(),Math.abs(o-n)<50&&(this.margin=.1,this.margin=o),this.endBlockedUpdate()}var u=this.gridStyle.cropType;if(1==this.gridStyle.numBackgroundCells&&"Original"==this.gridForma.page.sizeID){var c,d=a.clone(this.forma.filterWithCallback((function(e){return null!=e.parent&&e.parent.isBackgroundImage()&&e.kind==D.ImageForma.KIND})));1==d.length&&(c=a.as(d[0],D.ImageForma))&&c.bounds.size.similarity(this.gridForma.page.pageSize)<.001&&(this.gridStyle.cropType=m.CropType.FitBorder)}if(this.layoutGrid(this.gridStyle.moveableShift,this.oldBounds,a.clone(t),r),this.gridStyle.cropType=u,null!=this.oldBounds&&(this.setInitialFormaSizes(),e&&null!=t))for(var h=a.iter(this.moveableFormae());!h.done;h.next()){var f;(f=t[(l=h.value).formaID])&&this.gridStyle.mapCellToFormaID(l.formaID,f)}}},colorGrid:function(e,t){for(var r=a.sort(e,(function(e,t){return e.bounds.minY<t.bounds.minY||!(e.bounds.minY>t.bounds.minY)&&e.bounds.minX<t.bounds.minX})),o=[],n=a.iter(r);!n.done;n.next())null!=(F=n.value).colorID&&null!=this.backgroundShapeFormaForCell(F,a.clone(t))&&o.push(F.colorID);var i,l=this.isBackgroundVisible(),s=this.forma.root.style.colors.colorID(c.ColorRole.FieldPrimary);0!=o.length||l||null!=(i=s)&&o.push(i);for(var u=a.iter(this.forma.page.colorLibraryController.getThemeColorKeys());!u.done;u.next()){var d=u.value;o.includes(d)||l&&d==s||o.push(d)}for(var h=a.clone(this.gridCells),f=a.sort(h,(function(e,t){return e.bounds.center.distanceTo(E.TheoPoint.ZERO)<t.bounds.center.distanceTo(E.TheoPoint.ZERO)})),g=a.iter(this.formaMappingSwiftDict);!g.done;g.next()){var p,v=g.key,F=g.value,y=this.forma.formaByID(v);if(null!=y&&y.isBackgroundImage())(p=a.as(y.controller,m.FrameController))&&(p.isBackgroundImageWithAlpha()||null!=(S=a.indexOfEq(f,F,C._equality_GridCell_GridCell))&&f.splice(S,1));else if(a.opt(a.opt(y,(function(e){return e.controller})),(function(e){return e.kind==L.TypeLockupController.KIND}))){var b;if((b=a.as(a.opt(y,(function(e){return e.controller})),L.TypeLockupController))&&(a.opt(b.lockupStyle,(function(e){return e.backing==G.LockupBacking.Banner}))||a.opt(b.lockupStyle,(function(e){return e.backing==G.LockupBacking.BannerHorizontal}))||a.opt(b.lockupStyle,(function(e){return e.backing==G.LockupBacking.BannerVertical}))||a.opt(b.lockupStyle,(function(e){return e.backing==G.LockupBacking.Knockout})))){var I,S,D,T=a.opt(y,(function(e){return e.style.colors.colorID(c.ColorRole.FieldSecondary)}));(I=this.gridStyle.updateCell(F,null,T,null))&&(null!=(S=a.indexOfEq(f,F,C._equality_GridCell_GridCell))&&f.splice(S,1),null!=(D=a.indexOf(o,I.colorID))&&o.push(o.splice(D,1)))}}}for(var M=[],P=0,_=a.iter(f);!_.done;_.next()){F=_.value;for(var k=!1,R=a.iter(this.formaeForCell(F));!R.done;R.next()){var w,A;(w=t[R.value.formaID])&&null!=(A=w.colorID)&&o.includes(A)&&(k=!0,this.gridStyle.updateCell(F,null,A,null),o.length>f.length&&a.remove(o,A))}k||M.push(F)}if(0==o.length)x.LegacyCoreAssert.fail("ERROR: incorrectly removed all background colors.",void 0,"GridController.colorGrid","GridController.swift",3163);else for(var B=a.iter(M);!B.done;B.next())F=B.value,this.gridStyle.updateCell(F,null,o[P%o.length],null),P+=1},updateGridColors:function(){if(!this.blockUpdate)for(var e=a.iter(this.gridCells);!e.done;e.next()){var t,r=e.value;(t=this.backgroundShapeFormaForCell(r))&&(r.colorID==t.style.colors.colorID(c.ColorRole.FieldPrimary)&&r.opacity==t.style.opacity||this.gridStyle.updateCell(r,null,t.style.colors.colorID(c.ColorRole.FieldPrimary),t.style.opacity))}},getCellsSortedByRow:function(){return a.sort(this.gridCells,(function(e,t){return e.bounds.minY<t.bounds.minY||!(e.bounds.minY>t.bounds.minY)&&e.bounds.minX<t.bounds.minX}))},getCellsSortedByColumn:function(){return a.sort(this.gridCells,(function(e,t){return e.bounds.minX<t.bounds.minX||!(e.bounds.minX>t.bounds.minX)&&e.bounds.minY<t.bounds.minY}))},getContrastingColorForCell:function(e){var t=this.cellForForma(e);if(null!=t){var r=this.forma.page.colorLibraryController,o=[];this.isBackgroundVisible()&&null!=(i=a.opt(e.root,(function(e){return e.style.colors.colorID(c.ColorRole.FieldPrimary)})))&&(l=r.getSolidColorForKey(i))&&o.push(l);for(var n=a.iter(this.gridCells);!n.done;n.next()){var i,l,s=n.value;!a.eq(C._equality_GridCell_GridCell,t,s)&&t.mergeableWith(s)&&null!=(i=s.colorID)&&(l=r.getSolidColorForKey(i))&&o.push(l)}var u=a.clone(this.getContrastingThemeColorsInRandomOrder(a.clone(o)));if(u.length>0)return r.getTheoColorForKey(u[0]);x.LegacyCoreAssert.fail("failed in getContrastingColorForCell to get a color. we should never get here...",void 0,"GridController.getContrastingColorForCell","GridController.swift",3279)}return null},getContrastingThemeColorsInRandomOrder:function(e){for(var t=a.clone(e),r=this.forma.page.colorLibraryController,o=r.getThemeColorKeys().concat(),n=[];o.length>0;){var i=s.CoreRandom.nextIntUniform(o.length),l=o[i];o.splice(i,1);for(var u=!1,c=a.iter(t);!c.done;c.next()){var d,h=c.value;(d=r.getSolidColorForKey(l))&&d.distanceTo(h)<23&&(u=!0)}u||(n.push(l),t.push(r.getSolidColorForKey(l)))}return n.length<2&&(n=r.getThemeColorKeys().concat()),n},buildCellColorGroups:function(){for(var e=a.clone(this.getCellsSortedByRow()),t={},r=a.iter(e);!r.done;r.next()){var o,n=r.value;if(o=this.backgroundShapeFormaForCell(n)){for(var i=o.formaID,l=!1,s=a.iter(a.keys(t));!s.done;s.next()){var u=s.value;(new _.ProfilingColorMap).checkIfTwoFormaAreInSamePaletteMappingGroup(u,i)&&(t[u].push(n),l=!0)}l||(t[i]=[n])}}return t},shuffleColorAssignment:function(){var e=a.clone(this.buildCellColorGroups()),t=this.forma.page.colorLibraryController,r=[];if(this.isBackgroundVisible()){var o=this.forma.root.style.colors.colorID(c.ColorRole.FieldPrimary);r.push(t.getSolidColorForKey(o))}for(var n=a.clone(this.getContrastingThemeColorsInRandomOrder(a.clone(r))),i=a.count(e)<=n.length,l=0,s=a.iter(e);!s.done;s.next()){for(var u,d=s.value,h=a.iter(d);!h.done;h.next()){var m,f,g=h.value;if((m=this.gridStyle.updateCell(g,null,n[l%n.length],null))&&(f=this.backgroundShapeFormaForCell(m))){var p=(new _.ProfilingColorMap).overridePaletteMappingDueToContrast(m.colorID,f.formaID);f.style.colors.setColorId(c.ColorRole.FieldPrimary,p),u=p}}i&&null!=u&&a.remove(n,u),l+=1}},getCellIdsGroupedByColor:function(){for(var e=a.clone(this.getCellsSortedByRow()),t={},r=a.iter(e);!r.done;r.next()){var o,n,i,l,s=r.value,c=null;if((o=this.backgroundShapeFormaForCell(s))&&(c=o.formaID),(n=this.forma)&&null!=(i=s.colorID)&&(l=n.page.colorLibraryController.getSolidColorForKey(i))){for(var d=l.rgbString,h=!1,m=a.iter(a.keys(t));!m.done;m.next()){var f=m.value;null!=c&&u.ColorSelectorUtils.compareTwoColorStringsWithMargin(f,d)&&(t[f].push(c),h=!0)}h||null==c||(t[d]=[c])}}return t},moveableFormae:function(){for(var e=[],t=a.iter(this.forma.visitAsArray(h.FormaTraversal.JustChildren));!t.done;t.next()){var r=t.value;!r.controller.floating||!r.controller.moveable||r instanceof D.ImageForma||this.isGridCell(r)||e.push(r)}return a.sortInPlace(e,(function(e,t){return e.finalFrame.center.distanceTo(E.TheoPoint.ZERO)<t.finalFrame.center.distanceTo(E.TheoPoint.ZERO)})),e},removeOverlapCells:function(e,t){x.LegacyCoreAssert.isTrue(["vertical","horizontal"].includes(t),"unknown direction",{direction:t},"GridController.removeOverlapCells","GridController.swift",3447);for(var r=[],o=a.iter(a.range(0,e.length,!1));!o.done;o.next()){var n=e[o.value];if(r.length>0){var i=r[r.length-1];"horizontal"==t?a.toDouble(Math.round(1e3*Math.max(n.bounds.minX,i.bounds.minX))/1e3)<a.toDouble(Math.round(1e3*Math.min(n.bounds.maxX,i.bounds.maxX))/1e3)||r.push(n):"vertical"==t&&(a.toDouble(Math.round(1e3*Math.max(n.bounds.minY,i.bounds.minY))/1e3)<a.toDouble(Math.round(1e3*Math.min(n.bounds.maxY,i.bounds.maxY))/1e3)||r.push(n))}else r.push(n)}return r},getCellRegion:function(e,t,r,o){void 0===t&&(t=null),void 0===r&&(r=null),void 0===o&&(o=null);var n=null!=t?t:this.forma.bounds,i=null!=r?r:e.bounds,l=n.evalRect(i).transform(this.forma.totalPlacement).rounded();if(a.containsEq(this.foregroundGridCells,e,C._equality_GridCell_GridCell))return l;var s=null!=o?o:this.gridStyle.spacing,u=a.clone(this.getAdjustedSpacingsForCell(e,s)),c=u[0],d=u[1],h=u[2],m=u[3],f=new N.TheoRect(l.minX+c,l.minY+h,l.maxX-d,l.maxY-m).rounded();return 0==f.area?new N.TheoRect(f.minX,f.minY,f.maxX+1,f.maxY+1):f},updateHierarchy:function(){for(var e=a.iter(a.keys(this.formaMapping));!e.done;e.next()){var t,r,o=e.value;(t=a.opt(a.opt(this.forma,(function(e){return e.root})),(function(e){return e.formaByID(o)})))&&(r=t.controller)&&(t.parent==this.forma||t.parent.hasIntent(h.Forma.INTENT_INFERRED_TEMP_GROUP)||r.userGroupChild||(t instanceof D.ImageForma?x.LegacyCoreAssert.fail("shouldn't have a mapping to an image ",void 0,"GridController.updateHierarchy","GridController.swift",3512):this.gridForma.appendChild(t,!0)))}},layoutGrid:function(e,t,r,o){void 0===t&&(t=null),void 0===r&&(r=null),void 0===o&&(o=null);var n,i=this;if(!this.blockUpdate&&null!=this.forma.bounds){var l=new p.FormaGeometryChangedEvent(this.forma);this.forma.beginUpdate(l);var s=a.clone(this.moveableFormae()),u=a.clone(F.GroupDetector.detectProximityGroups(a.clone(s))),f=[];if(e&&this.owner.interactionMode!=d.InteractionMode.DefaultInteraction)for(var v=a.iter(a.range(0,this.gridCells.length,!1));!v.done;v.next()){for(var y=v.value,b=this.gridCells[y],I=this.getCellRegion(b),S=[],D=a.iter(this.formaeForCell(b));!D.done;D.next()){var T=D.value;a.containsEq(s,T,h._equality_Forma_Forma)&&S.push(T)}S.length>0&&(f=f.concat(S),this.evaluateCellAndSplit(a.clone(S),a.clone(u),I,t,a.clone(r),o))}if(null!=t&&f.length<s.length){for(var x=[],M=a.iter(s);!M.done;M.next())T=M.value,a.containsEq(f,T,h._equality_Forma_Forma)||x.push(T);this.moveFormaeToCell(a.clone(x),this.forma.frame,t,a.clone(r),o)}var P=a.clone(this.forma.filterWithCallback((function(e){return i.isGridCell(e)&&e.isShape()}),h.FormaTraversal.JustChildren));this.checkFramesForCropping_=[];for(var _=0,k=a.iter(a.range(0,this.gridCells.length,!1));!k.done;k.next()){y=k.value,b=this.gridCells[y],I=this.getCellRegion(b);for(var B=!1,E=[],U=a.iter(this.formaeForCell(b));!U.done;U.next()){var O,Y=U.value;Y.isBackgroundImage()&&(E.push(Y),((n=a.opt(a.as(Y,g.FrameForma),(function(e){return e.hasAlpha()})))||null!=n)&&n||(B=!0),Y.frame.area>2*I.area&&this.checkFramesForCropping_.push(Y),(O=a.as(Y.controller,m.FrameController))&&O.fitWithCrop(I,this.gridStyle.cropType),Y.intent=h.Forma.INTENT_GRID_CELL)}if(!B){var z;if(null==(j=this.backgroundShapeFormaForCell(b))?(j=a.as(this.forma.page.createFormaWithController(w.ShapeForma.KIND,R.ShapeController.KIND),w.ShapeForma),A.ShapeLibrary.applyToShapeForma(j,A.ShapeLibrary.Square)):a.remove(P,j),this.gridStyle.mapCellToForma(j,b),null==b.colorID){var X,H=this.forma.page.colorLibraryController.getThemeColorKeys()[0];b.bounds.equal(N.TheoRect.ONE_BY_ONE)&&null!=(X=a.opt(a.opt(this.forma,(function(e){return e.root})),(function(e){return e.style.colors.colorID(c.ColorRole.FieldPrimary)})))&&(H=X),b=this.gridStyle.updateCell(b,null,H,null)||b}null!=(z=b.colorID)&&(j.contentID=z+a.toString(_)),j.style.opacity=b.opacity,j.style.colors.setColorId(c.ColorRole.FieldPrimary,b.colorID),j.allowUserMove=a.containsEq(this.foregroundGridCells,b,C._equality_GridCell_GridCell),j.controller.fit(I),E.splice(0,0,j),j.intent=h.Forma.INTENT_GRID_CELL}for(var W=a.iter(E);!W.done;W.next()){var q=W.value,K=this.gridForma.indexOfChild(q);null!=K&&K==_||this.gridForma.insertChildAt(q,_),_+=1}}for(var V=a.iter(P);!V.done;V.next()){var j=V.value;this.gridStyle.removeMappingToForma(j),j.removeFromParent()}for(var Z=a.iter(f);!Z.done;Z.next()){var J,Q=Z.value;(J=a.as(Q.controller,L.TypeLockupController))&&(this.gridCells.length>1&&this.owner.interactionMode==d.InteractionMode.AutomaticGrid&&(a.opt(J.lockupStyle,(function(e){return e.backing==G.LockupBacking.Banner}))||a.opt(J.lockupStyle,(function(e){return e.backing==G.LockupBacking.BannerHorizontal}))||a.opt(J.lockupStyle,(function(e){return e.backing==G.LockupBacking.BannerVertical}))||a.opt(J.lockupStyle,(function(e){return e.backing==G.LockupBacking.Knockout})))&&(a.opt(J.lockupStyle,(function(e){return e.textLook=G.LockupTextLook.Fill})),a.opt(J.lockupStyle,(function(e){return e.backingArtworkID=null})),a.opt(J.lockupStyle,(function(e){return e.backing=G.LockupBacking.None}))),J.snapSizeToBounds())}this.forma.endUpdate(l)}},assertCorrectLayout:function(){this.gridStyle},evaluateCellAndSplit:function(e,t,r,o,n,i){if(void 0===o&&(o=null),void 0===n&&(n=null),void 0===i&&(i=null),0!=e.length)if(1!=e.length&&null==o){for(var l=e[0].finalFrame,s=a.iter(e);!s.done;s.next()){var u=s.value;l=l.unionWith(u.finalFrame)}for(var c=Math.max(r.aspectRatio,1/r.aspectRatio),d=Math.max(l.aspectRatio,1/l.aspectRatio),m=r.similarity(l)>.1?Math.min(a.toInt(c-1),Math.max(1,P.MathUtils.absInt(a.toInt(c-d)))):1,f=[],g=a.iter(t);!g.done;g.next()){for(var p=g.value,v=[],C=a.iter(e);!C.done;C.next())u=C.value,a.containsEq(p,u,h._equality_Forma_Forma)&&v.push(u);v.length>0&&f.push(a.clone(v))}for(var y=Math.min(e.length,m),b=a.iter(e);!b.done;b.next()){var I,S;u=b.value,(I=a.as(u.controller,L.TypeLockupController))&&null!=(S=I.averageLineHeight)&&S<.5*L.TypeLockupController.MIN_LINE_HEIGHT&&(y+=1)}f=a.clone(F.GroupDetector.splitFormaGroups(a.clone(f),Math.max(y,1)));var D=null;if(r.aspectRatio>2)D=a.clone(r.insetRel(.1,.1,0,0).split(f.length,!0));else{if(null!=n)return void this.moveFormaeToCell(a.clone(e),r,o,a.clone(n),i);for(var T=this.forma.root.finalFrame.height,x=[],G=a.iter(f);!G.done;G.next())if((p=G.value).length>0){l=p[0].finalFrame;for(var M=a.iter(p);!M.done;M.next())u=M.value,l=l.unionWith(u.finalFrame);x.push(l.height/T+.1)}D=a.clone(r.insetRel(0,0,.1,.1).split(f.length,!1,a.clone(x)))}var _=null;1==f.length&&(_=a.clone(n));for(var k=a.iter(a.range(0,f.length,!1));!k.done;k.next()){var R=k.value;this.moveFormaeToCell(a.clone(f[R]),D[R],null,a.clone(_),i)}}else this.moveFormaeToCell(a.clone(e),r,o,a.clone(n),i)},moveFormaeToCell:function(e,t,r,o,n){if(void 0===r&&(r=null),void 0===o&&(o=null),void 0===n&&(n=null),0!=e.length){var i,l=null;if(i=o)for(var s=null!=r?r:this.forma.bounds,u=a.iter(e);!u.done;u.next()){var c;if(c=i[u.value.formaID]){var d=this.getCellRegion(c,s,void 0,n);if(null!=l&&!l.equal(d)){l=null;break}l=d}}for(var h=a.sort(e,(function(e,t){return e.parent.indexOfChild(e)<t.parent.indexOfChild(t)})),m={},f=a.iter(h);!f.done;f.next()){var g=f.value;a.opt(a.as(g.controller,L.TypeLockupController),(function(e){return e.snapSizeToBounds()})),m[g.formaID]=g.parent.indexOfChild(g)}var p=this.forma.page.createFormaWithController(y.GroupForma.KIND,v.GroupController.KIND);p.allowUserMove=!1;var C=p.controller;p.isModel=!0,this.gridForma.isModel=!0,null==r?e.length>B.TheoDocumentUtils.DESIGN_COMPLEXITY_HEURISTIC_THRESHOLD?C.preferredResizeType=k.ResizeLayoutType.Fit:C.preferredResizeType=k.ResizeLayoutType.Pin:C.preferredResizeType=this.preferredResizeType,this.gridForma.appendChild(p);for(var F=h[0].finalFrame,b=a.iter(h);!b.done;b.next())g=b.value,F=F.unionWith(g.finalFrame);null==l?(p.placement=M.Matrix2D.translationXY(F.minX,F.minY),p.bounds=N.TheoRect.fromSize(F.size)):(p.placement=M.Matrix2D.translationXY(l.minX,l.minY),p.bounds=N.TheoRect.fromSize(l.size));var I=t.equal(this.forma.frame)&&null!=r;I&&(p.placement=M.Matrix2D.Identity,p.bounds=N.TheoRect.fromSize(r.size));for(var D=a.iter(h);!D.done;D.next())g=D.value,p.appendChild(g,!0);var T=U.TheoSize.Zero;if(null!=l||I)T=t.size;else{var x=Math.min(50,.05*t.width),G=Math.min(50,.05*t.height),P=t.insetXY(x,G),_=Math.min(P.height,F.height);1==e.length&&(_=Math.max(_,.75*P.height)),T=new U.TheoSize(P.width,_)}p.bounds=N.TheoRect.fromSize(T),p.move(M.Matrix2D.translation(p.finalFrame.evalXY(.5,.5).multiply(-1)).translate(t.center));for(var R=a.iter(h);!R.done;R.next())g=R.value,this.gridForma.insertChildAt(g,m[g.formaID],!0),t.contains(g.finalFrame)||a.opt(S.Host.logging,(function(e){return e.warning("warning. child forma "+g.finalFrame.asString+" must be within region "+t.asString+" ")}));p.removeFromParent(),this.gridForma.isModel=!1}},getAlignments:function(e){return void 0===e&&(e=!1),[]},postDecode:function(){var e=this;x.LegacyCoreAssert.isTrue(null!=this.forma,"forma present",void 0,"GridController.postDecode","GridController.swift",4122),x.LegacyCoreAssert.isTrue(null!=this.gridStyle,"grid style present",void 0,"GridController.postDecode","GridController.swift",4123),a.opt(this.gridStyle,(function(t){return t.forma=e.forma})),this.inferBackgroundCellAssignment(),this.inferGridCellAssignment(),this.updateGridColors()},resizeWithFit:function(e,t,r){if(null!=this.forma){this.inferBackgroundCellAssignment();var o=1==this.backgroundGridCells.length&&this.maxMargin<1,n=this.isBackgroundVisible();this.forma.bounds=a.opt(this.forma.bounds,(function(e){return e.scale(t,new E.TheoPoint(0,0))}));for(var i=a.iter(this.forma.visitAsArray(h.FormaTraversal.JustChildren));!i.done;i.next())i.value.move(M.Matrix2D.translation(r));if(this.beginBlockedUpdate(),this.forma.bounds=e,this.endBlockedUpdate(),o){this.gridStyle.nonOverlappingCells()[0].bounds=N.TheoRect.ONE_BY_ONE;var l=this.gridStyle.moveableShift;this.gridStyle.moveableShift=!1,this.updateGroup(),this.gridStyle.moveableShift=l}if(!n)for(var s=a.iter(this.backgroundGridCells);!s.done;s.next()){var u,d=s.value;null!=(u=d.colorID)&&this.backgroundShapeFormaForCell(d)&&this.forma.root.style.colors.setColorId(c.ColorRole.FieldPrimary,u)}this.updateAllGridCells()}},updateAllGridCells:function(){for(var e=a.iter(this.forma.visitAsArray(h.FormaTraversal.JustChildren));!e.done;e.next()){var t,r=e.value;r.isGridCell()&&(t=this.cellForForma(r))&&(t.bounds=this.updatedCellBounds(r,t,!0))}},getBasicShapeLayoutColor:function(){var e;return(e=this.gridStyle)&&1==e.gridCells.length&&e.gridCells[0].bounds.equalWithAccuracy(N.TheoRect.ONE_BY_ONE,.01)?e.gridCells[0].colorID:null},canMoveShape:function(e){if(e.parent!=this.forma)return!1;var t;if(l=this.cellForForma(e))return a.containsEq(this.foregroundGridCells,l,C._equality_GridCell_GridCell);if(t=e.finalFrame){for(var r={},o=[],n=a.iter(this.gridCells);!n.done;n.next()){var i,l=n.value,s=this.getCellRegion(l);(i=t.intersectionWith(s))&&i.area/s.area>.6&&(r[l]=i.area/s.area,o.push(l))}if(o.length>0)return a.sortInPlace(o,(function(e,t){return r[e]>r[t]})),a.containsEq(this.foregroundGridCells,o[0],C._equality_GridCell_GridCell)}return!1},cleanupUnusedBackgroundCellColors:function(){for(var e=a.iter(this.gridCells);!e.done;e.next())for(var t=e.value,r=this.getCellRegion(t),o=a.iter(this.forma.visitAsArray(h.FormaTraversal.JustChildren));!o.done;o.next()){var n,i=o.value;(n=i.finalFrame)&&n.equalWithAccuracy(r,.01)&&i.isBackgroundImage()&&(t.colorID=null)}}}}),n)},JO5d:function(e,t,r){var o,n=t,i=r("oAGj"),a=r("0wFF"),l=r("6h7+"),s=r("aO0D"),u=r("CWW7"),c=r("yGNn"),d=r("AVHO"),h=r("Ohrj"),m=r("ascj"),f=r("FNB+"),g=r("H9Ol"),p=r("yHU1"),v=r("Pil/"),C=r("16hp"),F=r("G1DZ"),y=r("P83h"),b=r("9Lk3"),I=r("pnSN"),S=r("6Rk9"),D=r("x35w"),T=r("iCxV"),x=r("tGKA"),G=r("uxH+"),M=r("K0Rh"),P=r("7Ta2"),_=r("djAF"),k=r("35Q0"),R=r("T6jX"),w=r("oKlP"),A=r("sIWg"),B=r("qSCS"),L=r("LGJg");n.ShapeController=(o=function(e,t,r){g.FormaController.call(this,e,t,r)},i.defineClass({name:"ShapeController",ctor:o,superName:"FormaController",statics:{KIND:{get:function(){return"shape"}}},props:{duplicatable:{get:function(){return this.forma.hasIntent(f.Forma.INTENT_ICON)}},selectable:{get:function(){return null==this.forma||null==R.TheoDocumentUtils.getCellBackgroundImage(this.forma)}},rotateable:{get:function(){return this.forma.hasIntent(f.Forma.INTENT_ICON)||this.forma.hasIntent(f.Forma.INTENT_FLOATING_SHAPE)}},moveable:{get:function(){return null!=this.forma.allowUserMove?this.forma.allowUserMove:!(!this.forma.hasIntent(f.Forma.INTENT_ICON)&&!this.forma.hasIntent(f.Forma.INTENT_FLOATING_SHAPE))||((e=i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),b.GridController))?e.canMoveShape(this.forma):g.FormaController._getters.moveable.call(this));var e}},floating:{get:function(){return!(!this.forma.hasIntent(f.Forma.INTENT_ICON)&&!this.forma.hasIntent(f.Forma.INTENT_FLOATING_SHAPE))||!this.forma.hasIntent(f.Forma.INTENT_GRID_CELL)&&g.FormaController._getters.floating.call(this)}},deleteable:{get:function(){var e,t,r,o,n=this;return i.opt(this.forma,(function(e){return null!=e.controller&&n.forma.isGridCell()}))&&(e=i.as(i.opt(this.forma,(function(e){return e.root})),M.RootForma))&&(t=i.opt(i.as(e.controller,G.RootController),(function(e){return e.getGridController()})))?1==t.gridStyle.numBackgroundCells&&(r=i.opt(this.forma,(function(e){return e.finalFrame})))&&(o=i.opt(i.opt(this.forma,(function(e){return e.root})),(function(e){return e.finalFrame})))?!r.equal(o):t.canDeleteCellForForma(this.forma):g.FormaController._getters.deleteable.call(this)}},replaceable:{get:function(){return!(!i.opt(this.forma,(function(e){return null!=e.controller}))||this.forma.isGridCell()&&this.forma.controller.moveable)}},flippable:{get:function(){return this.forma.hasIntent(f.Forma.INTENT_ICON)}},nudgeable:{get:function(){return this.forma.hasIntent(f.Forma.INTENT_ICON)}},maintainAspectRatio:{get:function(){var e,t,r,o;return this.forma.hasIntent(f.Forma.INTENT_IMAGE_MASK)&&null!=(e=i.opt(i.as(this.forma,_.ShapeForma),(function(e){return e.shapeLibraryID})))&&(t=s.CropAssetLibrary.getCropShapeFromID(e))?t.fixAspectRatio:(!(r=i.opt(i.as(i.opt(i.as(this.forma,_.ShapeForma),(function(e){return e.contentNode})),B.URLBasedContentNode),(function(e){return e.mediaMetadata})))||null==(o=r.searchTerm)||"square"!=o.toLowerCase()&&"rectangle"!=o.toLowerCase())&&this.forma.hasIntent(f.Forma.INTENT_ICON)}},selectionHandlePositions:{get:function(){return this.forma.hasIntent(f.Forma.INTENT_GRID_CELL)?[new w.TheoPoint(.5,0),new w.TheoPoint(.5,1),new w.TheoPoint(1,.5),new w.TheoPoint(0,.5)]:g.FormaController._getters.selectionHandlePositions.call(this)}},processFormaResize:function(e){g.FormaController.prototype.processFormaResize.call(this,e)},processBeginFormaResize:function(e){g.FormaController.prototype.processBeginFormaResize.call(this,e)},processEndFormaResize:function(e){g.FormaController.prototype.processEndFormaResize.call(this,e),this.updateParentGroup()},processEvent:function(e){var t;return(t=i.as(e,v.BeginPointerTrackingEvent))?(t.trackingResponse=p.BeginPointerTrackingResponseEnum.TrackAsGroup,!1):g.FormaController.prototype.processEvent.call(this,e)},processFormaDoubleClick:function(e){this.owner.selection.replaceSelection(e.forma),this.owner.controllerSettingsState.settings=new d.ShapeControllerSettings(this)},addForma:function(e,t,r){var o;if(o=i.as(e.root,M.RootForma)){for(var n,a,l=i.clone(o.filterWithCallback((function(e){return e.isTypeLockup()}))),s=null,u=i.iter(l);!u.done;u.next()){var d;(d=u.value.style.colors.fieldPrimary)&&(s=d)}if((n=i.as(t,_.ShapeForma))&&(a=D.GridFacade.getPageGrid(t.page,!0))&&(a.forma.appendChild(n),r.suggestPlacement)){var h=new C.FormaPlacementSuggester(n,o),f=i.clone(h.createPlacementSuggestions(!0,n.bounds.aspectRatio));f.length>0&&f[0].apply()}return null==s?i.opt(this.forma,(function(e){return e.style.colors.setColorId(m.ColorRole.FieldPrimary,o.page.colorLibraryController.getThemeColorKeys()[0])})):i.opt(this.forma,(function(e){return e.style.colors.setColor(m.ColorRole.FieldPrimary,s)})),this.contrastCheck(!1),c.CorePromise.resolve(null)}return c.CorePromise.reject("failed to get critical references")},getSuggestableColors:function(){for(var e=this.forma.page.colorLibraryController,t=i.clone(e.getColorThemeAsArrayOfTheoColors()),r=[],o=this.getBackgroundColor(),n=i.iter(t);!n.done;n.next()){var a=n.value;if(!a.isBrandkitColor()){if(this.floating&&null!=o&&!o.contrasts(a.rgbColor,!1))continue;r.push([a])}}return r},fit:function(e){var t;(t=i.as(this.forma,_.ShapeForma))&&(t.size=this.maintainAspectRatio?e.fitAspectRatioWithin(t.bounds.aspectRatio):e.size,t.placement=x.Matrix2D.Identity,t.moveCenterToPoint(e.center))},setNewShape:function(e){var t=new y.FormaGeometryChangedEvent(this.forma);this.forma.beginUpdate(t),k.ShapeLibrary.applyToShapeForma(this.forma,e),this.forma.endUpdate(t)},styleChanged:function(){!this.blockUpdate&&this.forma.isGridCell()&&i.opt(i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),b.GridController),(function(e){return e.updateGridColors()}))},copyTo:function(e){var t;if(void 0===e&&(e=null),t=i.as(this.forma,_.ShapeForma)){var r=e||t.page,n=r.createFormaWithController(_.ShapeForma.KIND,o.KIND);return n.match(t),u.CreationFacade.addForma(r,n,new u.AddFormaParams(void 0,!1)).then((function(e){n.style.match(t.style),n.intent=t.intent;var o,l,s,c,d,h=t.contentID;return(o=t.page.document)&&(l=r.document)&&o!=l&&null!=(s=t.contentID)&&(c=o.content.nodeByID(s))&&(d=i.as(l.content.createNode(L.VectorContentNode.KIND,null),L.VectorContentNode))&&(u.CreationFacade.addContentNodeToDocument(d,l),d.match(c),h=d.contentID),n.contentID=h,t.hasIntent(f.Forma.INTENT_ICON)?i.opt(T.Host.logging,(function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsDataIconDuplicated,{})})):i.opt(T.Host.logging,(function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsDataShapeDuplicated,{})})),n}))}return c.CorePromise.reject("Why calling ShapeController.duplicate but not for a shape forma?")},shuffleColorAssignment:function(){var e,t;if((e=i.as(this.forma,_.ShapeForma))&&(t=e.parent))if(b.GridController.isBackgroundColoredCell(e)){var r,o;(r=i.as(t.controller,b.GridController))&&(o=r.getContrastingColorForCell(e))&&this.applyColors([o])}else{var n=null;(R.TheoDocumentUtils.enableFastHeuristicsForComplexPage(e.page)||F.FormaSourceUtils.isDesignIngredient(e.source))&&(n=i.clone(P.InferredRole.init_84d1(P.InferredRoleType.GraphicContent,1,P.InferredRoleType.Background,0)));var a,l=new h.ProfilingPrimaryColorSelector(e,!1);if(a=this.userGroupRoot){var s=i.clone(this.getBackgroundColors());a.visit(f.FormaTraversal.PreOrder,(function(t,r,o){var n;return t==e||t instanceof I.GroupForma||!t.isShape()||S.GeometryFacade.formaBoundsIntersect(e,t)||(n=i.opt(t.controller,(function(e){return e.getBackgroundColors()})))&&i.append(s,n),!1})),l.updateBackgroundColors(i.clone(s))}var u=l.selectColorForGlobalRecolor(void 0,void 0,void 0,i.clone(n));e.style.colors.setColorId(m.ColorRole.FieldPrimary,u)}},applyColors:function(e,t){void 0===t&&(t=m.ColorRole.FieldPrimary),g.FormaController.prototype.applyColors.call(this,i.clone(e),t),l.BadgeFacade.logColorChange(i.opt(this.forma,(function(e){return e.source})))},containsPoint:function(e,t){if(void 0===t&&(t=0),!g.FormaController.prototype.containsPoint.call(this,e,t))return!1;var r,o;if((r=i.opt(i.as(this.forma,_.ShapeForma),(function(e){return e.maskImage})))&&(o=this.forma.bounds)){if(r.isEmpty())return!0;var n,a=new A.TheoRect(0,0,i.toDouble(r.width),i.toDouble(r.height)),l=new w.TheoPoint(e.x/o.width*a.width,e.y/o.height*a.height),s=.05*Math.max(a.width,a.height),u=new A.TheoRect(l.x-s,l.y-s,l.x+s,l.y+s);return!!(n=a.intersectionWith(u))&&r.sumRegion(n)>1e-5}return!0}}}),o)},KIfs:function(e,t,r){var o,n,i,a=t,l=r("oAGj"),s=r("gXiO"),u=r("fWxZ"),c=r("iCxV"),d=r("fNpk"),h=r("tGKA"),m=r("g8Fi"),f=r("oKlP");a.kAllowMultipleDragsInFlight=!1,a.debug_print=function(e,t,r){void 0===t&&(t=" "),void 0===r&&(r="\n")},a.debug_print=function(e,t,r,o){void 0===r&&(r=" "),void 0===o&&(o="\n")},a.debug_print=function(e,t,r,o,n){void 0===o&&(o=" "),void 0===n&&(n="\n")},a.debug_print=function(e,t,r,o,n,i){void 0===n&&(n=" "),void 0===i&&(i="\n")},a.debug_print=function(e,t,r,o,n,i,a){void 0===i&&(i=" "),void 0===a&&(a="\n")},a.debug_print=function(e,t,r,o,n,i,a,l){void 0===a&&(a=" "),void 0===l&&(l="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s){void 0===l&&(l=" "),void 0===s&&(s="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s,u){void 0===s&&(s=" "),void 0===u&&(u="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s,u,c){void 0===u&&(u=" "),void 0===c&&(c="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s,u,c,d){void 0===c&&(c=" "),void 0===d&&(d="\n")},a.dot=function(e,t){return e.dotProduct(t)},a.cross=function(e,t){return e.x*t.y-e.y*t.x},a.concat=function(e,t,r){return h.Matrix2D.concat2(h.Matrix2D.concat2(e,t),r)},a.scale=function(e,t){return new f.TheoPoint(e*t.x,e*t.y)},a.blend=function(e,t,r){return a.scale(1-t,e).add(a.scale(t,r))},a.midpoint=function(e,t){return a.blend(e,.5,t)},a.moveBy=function(e){return h.Matrix2D.translation(e)},a.move=function(e,t){return a.moveBy(t.subtract(e))},a.PointerDrag=(o=function(e,t){this.begin=e,this.end=t},l.defineClass({name:"PointerDrag",ctor:o}),o),a.freeMovement_=function(e){if(1==e.length)return{movement:a.move(e[0].begin,e[0].end),rise:0,run:1};if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(f.TheoPoint.ZERO)&&r.equal(f.TheoPoint.ZERO))return{movement:a.move(e[0].begin,e[0].end),rise:0,run:1};if(t.equal(f.TheoPoint.ZERO))return{movement:a.move(e[0].begin,e[0].end),rise:0,run:1};var o=a.dot(t,t),n=a.dot(t,r),i=a.cross(t,r),l=n/o,s=i/o,u=new h.Matrix2D(l,s,-s,l,0,0),c=a.concat(a.moveBy(e[0].begin.invert()),u,a.moveBy(e[0].end));return d.LegacyCoreAssert.isTrue(0!=c.determinant,"free movement matrix determinant should've been 0",void 0,"freeMovement_","PointerStateMachine.swift",269),{movement:c,rise:i,run:n}}return{movement:h.Matrix2D.Identity,rise:0,run:1}},a.MoorePenrose10011001=function(e,t,r,o,n,i,a,s){var u=e-r,c=t-o,d=u*u,h=c*c,m=2*(d+h),f=c*(e+r),g=u*(t+o),p=[[2*u,2*c,-2*u,-2*c],[h-2*r*u,-f,h+2*e*u,f],[-g,d-2*o*c,g,d+2*t*c]];p=p.map((function(e){return e.map((function(e){return e/m}),this)}),this);var v=p.map((function(e){return function(e,t){return l.zip(l.clone(e),l.clone(t)).map((function(e){return e[0]*e[1]}),this).reduce((function(e,t){return e+t}),0)}(l.clone(e),[n,i,a,s])}),this);return{u:v[0],v:v[1],w:v[2]}},a.noRotation_=function(e){if(1==e.length)return a.move(e[0].begin,e[0].end);if(2==e.length){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(f.TheoPoint.ZERO)&&r.equal(f.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(t.equal(f.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var o=a.MoorePenrose10011001(e[0].begin.x,e[0].begin.y,e[1].begin.x,e[1].begin.y,e[0].end.x,e[0].end.y,e[1].end.x,e[1].end.y),n=o.u,i=o.v,l=o.w;return new h.Matrix2D(n,0,0,n,i,l)}if(e.length>2){var s=a.noRotation_([e[0],e[1]]),u=a.noRotation_([e[0],e[2]]),c=a.noRotation_([e[1],e[2]]);return s.averageTranslationScale([s,u,c])}return h.Matrix2D.Identity},a.noRotation2_=function(e,t){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var r=e[1].begin.subtract(e[0].begin),o=e[1].end.subtract(e[0].end);if(r.equal(f.TheoPoint.ZERO)&&o.equal(f.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(r.equal(f.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var n=a.MoorePenrose10011001(e[0].begin.x,e[0].begin.y,e[1].begin.x,e[1].begin.y,e[0].end.x,e[0].end.y,e[1].end.x,e[1].end.y),i=n.u;n.v,n.w;return a.concat(a.moveBy(t.invert()),new h.Matrix2D(i,0,0,i,0,0),a.moveBy(t))}return h.Matrix2D.Identity},a.noScale_=function(e){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(f.TheoPoint.ZERO)&&r.equal(f.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(t.equal(f.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var o=a.MoorePenrose10011001(-e[0].begin.y,e[0].begin.x,-e[1].begin.y,e[1].begin.x,e[0].end.x-e[0].begin.x,e[0].end.y-e[0].begin.y,e[1].end.x-e[1].begin.x,e[1].end.y-e[1].begin.y),n=o.u,i=o.v,l=o.w;return new h.Matrix2D(Math.cos(n),Math.sin(n),-Math.sin(n),Math.cos(n),i,l)}return h.Matrix2D.Identity},a.noScale2_=function(e){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(f.TheoPoint.ZERO)&&r.equal(f.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(t.equal(f.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var o=a.dot(t,t),n=a.dot(r,r),i=a.dot(t,r),l=a.cross(t,r),s=Math.sqrt(o*n),u=i/s,c=l/s,m=new h.Matrix2D(u,c,-c,u,0,0),g=a.concat(a.moveBy(a.midpoint(e[0].begin,e[1].begin).invert()),m,a.moveBy(a.midpoint(e[0].end,e[1].end)));return d.LegacyCoreAssert.isTrue(0!=g.determinant,"noScale2 result matrix determinant should've been 0",void 0,"noScale2_","PointerStateMachine.swift",633),g}return h.Matrix2D.Identity},a.noScale3_=function(e,t){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var r=e[1].begin.subtract(e[0].begin),o=e[1].end.subtract(e[0].end);if(r.equal(f.TheoPoint.ZERO)&&o.equal(f.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(r.equal(f.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var n=a.dot(r,r),i=a.dot(o,o),l=a.dot(r,o),s=a.cross(r,o),u=Math.sqrt(n*i),c=l/u,m=s/u,g=new h.Matrix2D(c,m,-m,c,0,0),p=a.concat(a.moveBy(t.invert()),g,a.moveBy(t));return d.LegacyCoreAssert.isTrue(0!=p.determinant,"noScale3 result matrix determinant should've been 0",void 0,"noScale3_","PointerStateMachine.swift",674),p}return h.Matrix2D.Identity},a.closestApproach_=function(e,t,r,o){var n=e.subtract(r),i=o.subtract(t),l=a.dot(i,i);return 0==l?{distance:Math.sqrt(a.dot(n,n)),time:0}:{distance:a.cross(i,n)/Math.sqrt(l),time:a.dot(i,n)/l}},a.DragPace=l.defineEnum("DragPace",{StoppedPace:0,SlowPace:1,MediumPace:2,FastPace:3}),a.DragMode=l.defineEnum("DragMode",{UniformScaleNoSkew:0,NoScaleNoSkew:1,UniformScaleNoRotationNoSkew:2}),a.ActiveDragDelegateProtocol=l.defineProtocol("ActiveDragDelegateProtocol",{modifierKeys:"Dictionary<String>",activeDragDidBegin:"(ActiveDrag) -> Void",activeDragDidActivate:"(ActiveDrag) -> Boolean",activeDragDidDeactivate:"(ActiveDrag, Boolean) -> Void",activeDragClaimNewPointers:"(ActiveDrag, Array<PointerState>, Boolean) -> Array<PointerState>",activeDragDidCommit:"(ActiveDrag) -> Void",activeDragDidMove:"(ActiveDrag, DragPace) -> Void",activeDragDidChangePace:"(ActiveDrag, DragPace, DragPace) -> Void",activeDragHeldPointerEndedAsTap:"(ActiveDrag, PointerState) -> Void",activeDragDidEnd:"(ActiveDrag, Boolean, Array<PointerState>) -> Void"}),a.ActiveDrag=(n=function(e,t,r,o,n){this.initiated=!1,this.dragMode_=a.DragMode.UniformScaleNoSkew,this.pointers=[],this.totalMovement=h.Matrix2D.Identity,this.currentlySnapped_=!1,this.activationClock_=0,this._assignment=0,this.activeDragDelegate=t,this.pointerStateMachine=e,this.currentPace=a.DragPace.MediumPace,this.stoppedUtmost=9,this.slowUtmost=48,this.mediumUtmost=300,this.stoppedSlack=.5,this.slowSlack=.333,this.transientSlack=.333,this.futurePace=this.currentPace,this.pointers=[],this.uncommitedMovement=h.Matrix2D.Identity,this.newDragPlacement_=o,this.viewportScale=n,s.CoreObject.call(this),this.commitWithNewPointers(r)},l.defineClass({name:"ActiveDrag",ctor:n,superName:"CoreObject",props:{dragMode:{get:function(){return this.dragMode_},set:function(e){this.dragMode_,this.dragMode_=e}},currentlySnapped:{get:function(){return this.currentlySnapped_},set:function(e){this.currentlySnapped_!=e&&(this.currentlySnapped_=e)}},startPaceTimer:function(){if(null==this.paceTimer){var e=this;this.paceTimer=c.Host.async.startTimer(.6,(function(){var t;(t=e)&&(t.activePace(),t.paceTimer=null,t.startPaceTimer())}))}},stopPaceTimer:function(){l.opt(this.paceTimer,(function(e){return e.cancel()})),this.paceTimer=null},activeDragDidCommit:function(){this.activeDragDelegate.activeDragDidCommit(this)},commitDrag:function(){this.slipPointers(!1),this.activeDragDidCommit(),this.totalMovement=h._asterisk_Matrix2D_Matrix2D(this.totalMovement,this.uncommitedMovement);var e=this.uncommitedMovement;return this.uncommitedMovement=h.Matrix2D.Identity,e},newDragPlacement:{get:function(){return this.newDragPlacement_},set:function(e){this.newDragPlacement_=e}},commitWithNewPointers:function(e,t){void 0===t&&(t=!0);for(var r=l.iter(e);!r.done;r.next()){var o=r.value;o.pointerStatus=m.PointerStatus.DragHeld,this.pointers.push(o)}this.commitDrag();var n=this.activationClock_,i=this;c.Host.async.postOnMainThread(.6,(function(){var e;(e=i)&&(n==e.activationClock_&&e.activateAll()?a.debug_print("time activated"):a.debug_print("not time activated"))})),e.splice(0)},claimPointers:function(e,t){return this.activeDragDelegate.activeDragClaimNewPointers(this,l.clone(e),t)},activeDragDidDeactivate:function(){var e=this.currentlySnapped;this.currentlySnapped=!1,this.activeDragDelegate.activeDragDidDeactivate(this,e)},deactivateAll:function(){if(this.initiated){this.commitDrag();for(var e=l.iter(this.pointers);!e.done;e.next()){var t=e.value;t.pointerStatus==m.PointerStatus.DragActive&&(t.pointerStatus=m.PointerStatus.DragInactive)}this.stopPaceTimer(),this.activeDragDidDeactivate()}},activeDragDidBegin:function(){this.activeDragDelegate.activeDragDidBegin(this)},activeDragDidActivate:function(){return this.activeDragDelegate.activeDragDidActivate(this)},activeDragDidMove:function(){this.activeDragDelegate.activeDragDidMove(this,this.currentPace)},activeDragDidEnd:function(e){this.initiated&&this.stopPaceTimer(),this.activeDragDelegate.activeDragDidEnd(this,this.initiated,l.clone(e)),this.pointers.splice(0)},activateAll:function(){for(var e=!1,t=l.iter(this.pointers);!t.done;t.next()){var r=t.value;r.pointerStatus!=m.PointerStatus.DragActive&&(r.pointerStatus=m.PointerStatus.DragActive,e=!0)}return!!e&&(this.activationClock_+=1,this.initiated||(this.initiated=!0,this.activeDragDidBegin()),this.selectDragMode(),this.startPaceTimer(),this.activeDragDidActivate()&&this.slipPointers(!0),!0)},slipPointers:function(e){for(var t=l.iter(this.pointers);!t.done;t.next()){var r=t.value,o=f._minus_TheoPoint_TheoPoint(r.currentLocation,r.startLocation);r.slippage=e?f._plus_TheoPoint_TheoPoint(r.slippage,o):f.TheoPoint.ZERO,r.startLocation=r.currentLocation,r.startTime=r.currentTime}},selectDragMode:function(){var e=this;if(this.pointers.length<=1)return a.debug_print("just one pointer"),void(this.dragMode=a.DragMode.UniformScaleNoSkew);var t=function(t){return f._minus_TheoPoint_TheoPoint(e.pointers[t].currentLocation,e.pointers[t].startLocation)},r=t(0),o=t(1),n=a.dot(r,o)/r.length()/o.length(),i=n>.5;if(a.debug_print("cosine_subtended",n),i)return a.debug_print("same direction"),void(this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew);var l,s=h.Matrix2D.Identity;s=(l=this.pointers[0].viewportTransform)?l:h.Matrix2D.uniformScaling(this.viewportScale);var u=this.freeMovement(s),c=u.movement,d=u.rise,m=u.run,g=c.determinant;a.debug_print("activateAll",Math.sqrt(g),d/m);var p=this.closestApproach(),v=p.distance;if(p.time,1==g&&0==d)a.debug_print("==== translate"),this.dragMode=a.DragMode.UniformScaleNoSkew;else if(1==g)a.debug_print("==== rotate"),this.dragMode=a.DragMode.NoScaleNoSkew;else if(0==d)a.debug_print("==== scale"),this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew;else{var C=.7*Math.abs(1-Math.sqrt(g)),F=Math.abs(d/m);C>1.1*F&&C>.01?(a.debug_print("==== scale"),this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew):F>1.1*C&&F>.01?(a.debug_print("==== rotate"),this.dragMode=a.DragMode.NoScaleNoSkew):(a.debug_print("==== free"),this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew)}this.dragMode==a.DragMode.UniformScaleNoRotationNoSkew&&Math.abs(v)>100&&(a.debug_print("!!!!!!!!override"),this.dragMode=a.DragMode.NoScaleNoSkew)},notifyPaceChanged:function(e,t){},activeDragDidChangePace:function(e,t){this.notifyPaceChanged(e,t),this.activeDragDelegate.activeDragDidChangePace(this,e,t)},activePace:function(){var e,t=this.dragVelocity*this.viewportScale;if(e=t<=this.stoppedUtmost?a.DragPace.StoppedPace:t<this.slowUtmost?a.DragPace.SlowPace:t<this.mediumUtmost?a.DragPace.MediumPace:a.DragPace.FastPace,this.futurePace!=e){this._assignment+=1;var r=this._assignment;if(this.futurePace=e,this.currentPace!=this.futurePace){var o=this.transientSlack;this.futurePace==a.DragPace.SlowPace&&(o=this.slowSlack),this.futurePace==a.DragPace.StoppedPace&&(o=this.stoppedSlack);var n=this;c.Host.async.postOnMainThread(o,(function(){var e;if((e=n)&&e._assignment==r){var t=e.currentPace;e.currentPace=e.futurePace,e.activeDragDidChangePace(t,e.currentPace),e.currentPace==a.DragPace.StoppedPace&&e.deactivateAll()}}))}}return this.currentPace},dragVelocity:{get:function(){for(var e=0,t=l.iter(this.pointers);!t.done;t.next()){var r=t.value.pointerVelocity();r>e&&(e=r)}return e}},activePointers:function(e){for(var t=[],r=l.iter(this.pointers);!r.done;r.next()){var o=r.value;o.pointerStatus==m.PointerStatus.DragActive&&t.push(new a.PointerDrag(e.transformPoint(o.startLocation),e.transformPoint(o.currentLocation)))}return t},freeMovement:function(e){var t=l.clone(this.activePointers(e));return a.freeMovement_(l.clone(t))},noScale:function(e,t){var r=l.clone(this.activePointers(e));return a.noScale3_(l.clone(r),t)},noRotation:function(e,t){var r=l.clone(this.activePointers(e));return a.noRotation2_(l.clone(r),t)},closestApproach:function(){for(var e=[],t=l.iter(this.pointers);!t.done;t.next()){var r=t.value;r.pointerStatus==m.PointerStatus.DragActive&&(e.push(r),a.debug_print("gorg=======",r.currentTime))}if(e.length<=1)return{distance:0,time:0};var o=h.Matrix2D.uniformScaling(this.viewportScale),n=function(t){for(var r=o.transformPoint(e[t].startLocation),n=o.transformPoint(e[t].currentLocation),i=e[t].startTime,s=e[t].currentTime,u=r.equal(n)?f.TheoPoint.ZERO:n.subtract(r).multiply(1/(s-i)),c=l.iter(e[t].history);!c.done;c.next()){var d=c.value;a.debug_print("\t......... "+d)}return{point:n,velocity:u}},i=n(0),s=n(1);return a.closestApproach_(i.point,i.velocity,s.point,s.velocity)}}}),n),a.PointerStateMachineDelegateProtocol=l.defineProtocol("PointerStateMachineDelegateProtocol",{createDragsForPointers:"(PointerStateMachine, Array<PointerState>, Boolean, Integer) -> Array<PointerState>",activeDragDidFinish:"(PointerStateMachine, ActiveDrag) -> Void"}),a.PointerStateMachine=(i=function(e){this.trackingStarted_=!1,this.drags_=[],this.delegate=e,s.CoreObject.call(this)},l.defineClass({name:"PointerStateMachine",ctor:i,superName:"CoreObject",statics:{DRAG_THRESHOLD:9,DRAG_LARGETHRESHOLD:18,_implements:function(e){return"TheoMessageSubscriber"==e}},props:{attach:function(e,t){this.owner=e,this.subscription_=t.subscribe(this,m.PointersStateChangeMessage.TYPE)},detach:function(){l.opt(this.subscription_,(function(e){return e.unsubscribe()})),this.subscription_=null,this.owner=null},onMessage:function(e){var t;(t=l.as(e,m.PointersStateChangeMessage))&&(this.trackingStarted_?t.changeType==m.PointersStateChangeTypeEnum.PointersDown?this.processDown(t):t.changeType==m.PointersStateChangeTypeEnum.PointersMoved?this.processMove(t):t.changeType==m.PointersStateChangeTypeEnum.PointersUp&&this.processUp(t):t.changeType==m.PointersStateChangeTypeEnum.PointersDown&&(this.trackingStarted_=!0,this.drags_=[],this.processDown(t)))},processDown:function(e){if(null!=e){for(var t=e,r=l.clone(t.pointers),o=l.iter(this.drags_);!o.done;o.next()){var n=o.value;r=l.clone(n.claimPointers(l.clone(r),a.kAllowMultipleDragsInFlight))}0!=r.length&&(r=l.clone(this.delegate.createDragsForPointers(this,l.clone(r),a.kAllowMultipleDragsInFlight,this.drags_.length)))}},appendDrag:function(e){this.drags_.push(e)},processMove:function(e){for(var t,r=l.iter(this.drags_);!r.done;r.next()){for(var o=r.value,n=o.viewportScale*o.viewportScale,s=[],d=l.iter(e.pointers);!d.done;d.next()){var h=d.value;o.pointers.includes(h)&&s.push(h)}if(0!=s.length){var g=i.DRAG_THRESHOLD;c.Host.platform.isMobile&&e.pointers.length>0&&0==((t=l.opt(l.opt(l.opt(l.as(e.pointers[0].currentPage,u.FormaPage),(function(e){return e.document})),(function(e){return e.controller})),(function(e){return e.selection.selectedCount})))||null!=t?t:0)&&(g=i.DRAG_LARGETHRESHOLD);for(var p=l.iter(s);!p.done;p.next()){(h=p.value).pointerStatus,m.PointerStatus.DragActive;var v=f._minus_TheoPoint_TheoPoint(h.currentLocation,h.startLocation),C=v.dotProduct(v)*n;if(C>g*g){o.activateAll()&&a.debug_print("move activated",Math.sqrt(C));break}}o.initiated&&o.activeDragDidMove()}}},activeDragTouchesEnded:function(e,t){for(var r=l.iter(t);!r.done;r.next()){var o,n=r.value;n.pointerStatus==m.PointerStatus.DragHeld&&e.activeDragDelegate.activeDragHeldPointerEndedAsTap(e,n),null!=(o=l.indexOf(e.pointers,n))&&e.pointers.splice(o,1)}e.commitDrag()},processUp:function(e){for(var t=0;t<this.drags_.length;){for(var r=this.drags_[t],o=[],n=l.iter(e.pointers);!n.done;n.next()){var i=n.value;r.pointers.includes(i)&&o.push(i)}o.length==r.pointers.length?(r.activeDragDidEnd(l.clone(o)),this.delegate.activeDragDidFinish(this,r),this.drags_.splice(t,1)):(this.activeDragTouchesEnded(r,l.clone(o)),t+=1)}}}}),i)},LhEC:function(e,t,r){var o,n=t,i=r("oAGj"),a=r("ZK0l");n.PROPERTY_SIZE_DEPRECATED="size",n.ResponsiveController=(o=function(e,t,r){a.GroupController.call(this,e,t,r)},i.defineClass({name:"ResponsiveController",ctor:o,superName:"GroupController",statics:{KIND:{get:function(){return"responsive"}}}}),o)},NkBu:function(e,t,r){var o,n=t,i=r("oAGj"),a=r("AVHO"),l=r("ascj"),s=r("H9Ol"),u=r("6ZWm"),c=r("yHU1"),d=r("Pil/"),h=r("cmoc"),m=r("fdtz"),f=r("lmwz"),g=r("uWOl"),p=r("37nf"),v=r("fNpk"),C=r("tGKA"),F=r("jcfx"),y=r("fAXt"),b=r("oKlP"),I=r("sIWg");n.ImageController=(o=function(e,t,r){this._annotations=[],s.FormaController.call(this,e,t,r)},i.defineClass({name:"ImageController",ctor:o,superName:"FormaController",statics:{KIND:{get:function(){return"image"}}},props:{rotateable:{get:function(){return!0}},flippable:{get:function(){return!this.forma.isLogo()}},nudgeable:{get:function(){return!0}},floating:{get:function(){var e;return(e=i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),u.FrameController))?e.floating:s.FormaController._getters.floating.call(this)}},moveable:{get:function(){var e,t;if((e=i.as(this.forma,m.ImageForma))&&(t=e.parent)){var r;if((r=i.opt(i.opt(e.page.document,(function(e){return e.controller})),(function(e){return e.selection})))&&r.isSelected(t)&&r.inCropMode)return!0;if(t.isGridCell())return!0}return!1}},annotations:{get:function(){return this._annotations}},addAnnotation:function(e){this._annotations.splice(0,0,e)},removeAnnotationsOfType:function(e){var t=!1;return this._annotations.splice((function(r){var o=r.id==e;return o&&(t=!0),o}),0),t},match:function(e){},setCrop:function(e,t,r){var o,n;if((o=this.forma)&&(n=o.bounds))if(r!=u.CropType.PreserveFocus&&r!=u.CropType.PreserveFocusAndScale||null==t)if(r==u.CropType.ScaleCrop&&null!=t){F=o.placement.transformValuesRKST;var a=Math.max(e.width/t.width,e.height/t.height);o.placement=o.placement.scaleTo(a*F.xscale,a*F.yscale)}else{var l,s,c,d=e.transform(o.placement.inverse),h=i.opt(t,(function(e){return e.transform(o.placement.inverse)})),f=null;if((l=i.opt(i.opt(i.as(this.forma,m.ImageForma),(function(e){return e.contentNode})),(function(e){return e.focusRegion})))&&(f=p.ImageUtils.suggestCrop(this.forma.bounds.size,l,d,h,r)),null==f&&(s=i.opt(i.as(o,m.ImageForma),(function(e){return e.contentNode})))&&(f=new I.TheoRect(0,0,i.toDouble(s.pixelWidth),i.toDouble(s.pixelHeight))),c=f){o.move(C.Matrix2D.uniformScaling(d.width/c.width));var g=o.placement.transformPoint(c.center);o.move(C.Matrix2D.translation(e.center.subtract(g)))}}else{var F=o.placement.transformValuesRKST,y=C._asterisk_Matrix2D_Matrix2D(C.Matrix2D.rotation(F.rotCosine,F.rotSine),C.Matrix2D.skewing(F.skew).scaleXY(F.xscale>0?1:-1,F.yscale>0?1:-1)),S=C.Matrix2D.scalingXY(Math.abs(F.xscale),Math.abs(F.yscale)),D=S.translateXY(F.tx,F.ty),T=C._asterisk_TheoRect_Matrix2D(n,o.placement).intersectionWith(t);null==T&&(T=t);var x,G,M,P=C._asterisk_TheoRect_Matrix2D(T,D.inverse),_=T.center,k=t.locate(_.x,_.y);if((x=i.opt(i.as(o,m.ImageForma),(function(e){return e.getFocusRegion()})))&&(G=x.intersectionWith(T))&&(k=t.locate(G.center.x,G.center.y)),r==u.CropType.PreserveFocusAndScale){var R=P.eval(k),w=C.Matrix2D.translation(b._negate_TheoPoint(R));w=C._asterisk_Matrix2D_Matrix2D(w,S);var A=e.eval(k);w=w.translate(A),M=C._asterisk_Matrix2D_Matrix2D(y,w)}else{w=C.Matrix2D.calculateResizeTransform(P,e,k,u.FitType.ProportionalFit),M=C._asterisk_Matrix2D_Matrix2D(y,w);var B=e.transform(M.inverse);n.contains(B)||(w=C.Matrix2D.calculateResizeTransform(P,e,k,u.FitType.ProportionalFill),M=C._asterisk_Matrix2D_Matrix2D(y,w))}o.placement=M}else v.LegacyCoreAssert.fail("ERROR. image has no bounds. possibly a corrupted document",void 0,"ImageController.setCrop","ImageController.swift",203)},processFormaClick:function(e){var t;if((t=i.opt(this.forma,(function(e){return e.parent})))&&t.kind==h.FrameForma.KIND)return e.forma=t,void i.opt(t.controller,(function(t){return t.processFormaClick(e)}));s.FormaController.prototype.processFormaClick.call(this,e)},processEvent:function(e){var t;return(t=i.as(e,d.BeginPointerTrackingEvent))?(i.opt(t.selectionState,(function(e){return 1==e.inCropMode}))?t.trackingResponse=c.BeginPointerTrackingResponseEnum.TrackWithinGroup:t.trackingResponse=c.BeginPointerTrackingResponseEnum.TrackAsGroup,!1):s.FormaController.prototype.processEvent.call(this,e)},processEndFormaDrag:function(e){var t;s.FormaController.prototype.processEndFormaDrag.call(this,e),(t=i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),u.FrameController))&&t.fitChildrenToFrame()},afterProcessEndFormaDrag:function(e){var t;f.ImageFacade.inCropMode(this.forma)||(t=i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),u.FrameController))&&t.fitChildrenToFrame()},processFormaDoubleClick:function(e){var t;f.ImageFacade.inCropMode(this.forma)||((t=i.opt(this.forma,(function(e){return e.parent})))&&t.kind==h.FrameForma.KIND&&(e.forma=t),this.owner.selection.replaceSelection(e.forma),this.owner.selection.isSelected(e.forma)&&(this.owner.controllerSettingsState.settings=new a.ImageControllerSettings(this)))},fit:function(e){var t,r;(t=this.forma)&&(t.placement=C.Matrix2D.Identity,(r=t.frame)&&(y.TransformFacade.scaleForma(t,r.aspectRatio>=1?e.width/r.width:e.height/r.height),t.moveCenterToPoint(e.center)),this.updateParentGroup())},internalShuffleColorAssignment:function(e){var t;if(t=this.forma){if(t.isLogo())return;var r,o;if((r=i.as(t.style,g.ImageStyle))&&r.isColorizedFilter&&(o=t.page.imageFilterLibrary.getNextImageStyleOfSameType(r,!1))){var n,a;if(null!=(n=o.colors.colorID(l.ColorRole.FieldPrimary))){var s=e?(new F.ProfilingColorMap).overridePaletteMappingDueToContrast(n,t.formaID):n;o.colors.setColorIDs([{key:l.ColorRole.FieldPrimary,value:s}])}null!=(a=o.colors.colorID(l.ColorRole.FieldSecondary))&&(s=e?(new F.ProfilingColorMap).overridePaletteMappingDueToContrast(a,t.formaID+F.ProfilingColorMap.backingColorKey):a,o.colors.setColorIDs([{key:l.ColorRole.FieldSecondary,value:s}])),t.applyStyle(o)}}},shuffleColorAssignment:function(){this.internalShuffleColorAssignment(!0)},shuffleColorAssignmentForAnimation:function(){this.internalShuffleColorAssignment(!1)}}}),o)},ZK0l:function(e,t,r){var o,n=t,i=r("oAGj"),a=r("0wFF"),l=r("SpAV"),s=r("CWW7"),u=r("yGNn"),c=r("ascj"),d=r("FNB+"),h=r("H9Ol"),m=r("6ZWm"),f=r("yHU1"),g=r("Pil/"),p=r("cmoc"),v=r("x7yN"),C=r("/afT"),F=r("pnSN"),y=r("X0GW"),b=r("iCxV"),I=r("Qlvz"),S=r("NkBu"),D=r("fdtz"),T=r("lmwz"),x=r("fNpk"),G=r("tGKA"),M=r("JFv5"),P=r("voLh"),_=r("DjTP"),k=r("T6jX"),R=r("8t9B"),w=r("mL0c"),A=r("zjod"),B=r("QTen");n.GroupController=(o=function(e,t,r){this.preserveResizeController_=!1,this.resizeLayoutController_=null,this.preferrededResizeType_=null,h.FormaController.call(this,e,t,r)},i.defineClass({name:"GroupController",ctor:o,superName:"FormaController",statics:{KIND:{get:function(){return"group"}},USER_GROUP_PROPERTY:"user-group",isImageOrVideo:function(e){return e.kind==D.ImageForma.KIND||e.kind==A.VideoForma.KIND}},props:{oldBounds:{get:function(){return this.oldBounds_}},updatedChild:{get:function(){return this.updatedChild_},set:function(e){this.updatedChild_=e}},preserveResizeController:{get:function(){return this.preserveResizeController_},set:function(e){this.preserveResizeController_=e}},preferredResizeType:{get:function(){return this.preferrededResizeType_},set:function(e){this.preferrededResizeType_=e}},resizeLayoutController:{get:function(){return this.resizeLayoutController_}},selectable:{get:function(){return this.userGroup}},duplicatable:{get:function(){return this.userGroup}},replaceable:{get:function(){return!1}},userGroup:{get:function(){var e;return!(!(e=i.opt(this.forma,(function(e){return e.hasIntent(d.Forma.INTENT_USER_GROUP)})))&&null==e)&&e}},maintainAspectRatio:{get:function(){if(this.userGroup)return!0;if(this.forma.hasIntent(d.Forma.INTENT_INFERRED_TEMP_GROUP))for(var e=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!e.done;e.next()){var t=e.value;if(null!=t.controller&&t.finalFrame.equalWithAccuracy(this.forma.finalFrame,10))return t.controller instanceof R.TypeLockupController||t.controller.maintainAspectRatio}return!1}},clone:function(e){return h.FormaController.prototype.clone.call(this,e)},addFormaToGroup:function(e){var t;(t=i.as(this.forma,F.GroupForma))&&t.appendChild(e,!0)},removeFormaFromGroup:function(e){var t;(t=i.as(this.forma,F.GroupForma))&&(i.opt(i.as(e.controller,o),(function(e){return e.handleRemoval()})),t.removeChild(e))},handleRemoval:function(){},replaceChildWithForma:function(e,t,r){var n,l,s;if(void 0===r&&(r=!1),o.isImageOrVideo(e)&&x.LegacyCoreAssert.isTrue(t.kind==e.kind,"replacing an ImageForma or VideoForma with an unexpected kind",{kind:t.kind},"GroupController.replaceChildWithForma","GroupController.swift",198),(s=i.as(this.forma,F.GroupForma))&&null!=(l=s.indexOfChild(e))){s.insertChildAt(t,l),null!=e.allowUserMove&&(t.allowUserMove=e.allowUserMove),t.matchColors(e),t.isLogo()||t.isSticker()||(t.allowUserMove=!1);var u,h,f,g=e.rotationInRadians();if(e.controller.rotate(-g),t.controller.floating&&(t.isLogo()||t.isSticker())?t.controller.fitInArea(e.frame):t.controller.fit(e.frame),t.allowUserMove=e.allowUserMove,t.intent=e.intent,T.ImageFacade.formaHasMask(e)&&(u=T.ImageFacade.getFrameFormaForForma(e))&&(h=i.opt(T.ImageFacade.getFrameFormaForForma(t),(function(e){return e.controller})))&&(f=i.opt(T.ImageFacade.getImageFormaForForma(t),(function(e){return e.controller})))&&u.placement.determinant<0){var v=u.placement.transformValuesRKST.yscale<0;h.flip(v),f.flip(v)}e.controller.rotate(g),t.controller.rotate(g),e.removeFromParent();var C,y=i.clone(t.filterWithCallback(o.isImageOrVideo)),M=i.clone(e.filterWithCallback(o.isImageOrVideo));if(y.length>0){for(var P=i.iter(y);!P.done;P.next()){var _,k,R,w=P.value;if((_=i.as(w,D.ImageForma))&&(k=i.as(w.controller,S.ImageController)))_.hasAlpha()&&e.isBackgroundImage()&&(w.allowUserMove=!1),!_.hasAlpha()||t.isLogo()||t.isSticker()||(R=i.as(t.controller,m.FrameController))&&R.fitWithCrop(e.frame,m.CropType.FitBorder),i.opt(b.Host.logging,(function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsImageReplaced,{hasAlpha:_.hasAlpha()?"true":"false",isLogo:_.isLogo()?"true":"false",isBackground:k.floating?"false":"true"})}));if(M.length>0){var A,L,E,N,U=r,O=M[0];if(A=i.as(O,D.ImageForma)){var Y,z,X=A.style.clone(),H=i.opt(i.opt(X,(function(e){return e.adjustments})),(function(e){return e.blur}));i.opt(X,(function(e){return e.adjustments=I.ImageAdjustments.createDefault().copyWithNewValues((n=H)||null!=n?n:0)})),(Y=i.as(X,B.VideoStyle))&&((z=i.as(w.style,B.VideoStyle))?(Y.startTime=z.startTime,Y.duration=z.duration):t.kind==D.ImageForma.KIND&&(X=Y.downgradeToImageStyle())),w.applyStyle(X)}if(0==U&&(L=i.opt(i.opt(i.as(w,D.ImageForma),(function(e){return e.contentNode})),(function(e){return e.mediaMetadata})))&&(E=i.opt(i.opt(i.as(O,D.ImageForma),(function(e){return e.contentNode})),(function(e){return e.mediaMetadata})))&&null!=L.assetID&&null!=E.assetID&&L.assetID==E.assetID&&(U=!0),1==U){var W=w,q=O,K=G.Matrix2D.uniformScaling(W.bounds.aspectRatio>=1?W.bounds.width/q.bounds.width:W.bounds.height/q.bounds.height);W.placement=K.inverse.concat(q.placement)}(N=T.ImageFacade.getMaskFormaForForma(e))&&T.ImageFacade.setMaskForForma(t,N)}}var V;(V=i.as(y[0],D.ImageForma))&&i.opt(i.opt(V.contentNode,(function(e){return e.image})),(function(e){return e.whenLoaded().then((function(e){return V.page.colorLibraryController.extractImageColors()}))}))}(C=i.opt(i.opt(i.opt(this.forma,(function(e){return e.page.document})),(function(e){return e.controller})),(function(e){return e.selection})))&&(C.removeStaleSelections(),C.isSelected(e)&&C.deselectForma(e),x.LegacyCoreAssert.isTrue(C.selectedCount==C.asFormaArray().length,"selection count does not match number of entries in selected forma array",void 0,"GroupController.replaceChildWithForma","GroupController.swift",372))}else if(s=i.as(this.forma,p.FrameForma)){var j,Z;null!=e.frame&&i.eq(d._equality_Forma_Forma,T.ImageFacade.getMaskFormaForForma(s),e)&&(T.ImageFacade.setMaskForForma(s,t),null!=e.allowUserMove&&(t.allowUserMove=e.allowUserMove),null!=(j=e.style.colors.colorID(c.ColorRole.FieldPrimary))&&t.style.colors.setColorId(c.ColorRole.FieldPrimary,j),null!=(Z=e.style.colors.colorID(c.ColorRole.FieldSecondary))&&t.style.colors.setColorId(c.ColorRole.FieldSecondary,Z))}},match:function(e){h.FormaController.prototype.match.call(this,e),this.updateGroup()},postClone:function(e){},getPinBounds:function(e){return e==w.PinBoundsType.ChildrenBounds?this.forma.childrenBoundsInCoordSpace(G.Matrix2D.Identity):i.opt(this.forma,(function(e){return e.bounds}))},processEvent:function(e){var t,r,o,n;if(n=i.as(e,g.BeginPointerTrackingEvent)){var a=!(!(t=i.opt(i.opt(this.forma,(function(e){return e.controller})),(function(e){return e.userGroup})))&&null==t)&&t,l=(r=i.opt(i.opt(i.opt(this.forma,(function(e){return e.page.document})),(function(e){return e.controller})),(function(e){return e.selection.selectedCount})))||null!=r?r:0,s=!(!(o=i.opt(i.opt(i.opt(this.forma,(function(e){return e.page.document})),(function(e){return e.controller})),(function(e){return e.selection.isSelected(n.dragTargetForma)})))&&null==o)&&o,u=!1;return l<=1&&s&&(u=this.forma.page.document.controller.enableMoveableChildren),n.trackingResponse=a&&!u?f.BeginPointerTrackingResponseEnum.TrackAsGroup:f.BeginPointerTrackingResponseEnum.TrackWithinGroup,!1}return h.FormaController.prototype.processEvent.call(this,e)},childUpdate:function(e){void 0===e&&(e=null),this.updatedChild_=e,this.updateGroup()},beginChildResizeEvent:function(e){},endChildResizeEvent:function(e){var t,r;((t=i.opt(i.opt(i.opt(this.forma,(function(e){return e.page.document})),(function(e){return e.controller})),(function(e){return e.selection.inCropMode})))||null!=t)&&t||!(r=i.opt(i.opt(this.forma,(function(e){return e.controller})),(function(e){return e.userGroup})))&&null==r||!r||y.GroupFacade.updateUserGroupHierarchy(this.forma)},processBeginFormaResize:function(e){h.FormaController.prototype.processBeginFormaResize.call(this,e),this.preserveResizeController_=!0},processEndFormaResize:function(e){h.FormaController.prototype.processEndFormaResize.call(this,e),this.preserveResizeController_=!1},childMoveableInDirection:function(e,t){return!0},groupVisualParent:{get:function(){return C.GroupDetector.getGroupVisualParent(this.forma)}},processFormaDrag:function(e){h.FormaController.prototype.processFormaDrag.call(this,e)},processBeginFormaDrag:function(e){h.FormaController.prototype.processBeginFormaDrag.call(this,e)},processEndFormaDrag:function(e){h.FormaController.prototype.processEndFormaDrag.call(this,e)},canClaimForma:function(e){return!1},claimForma:function(e){this.forma!=e.parent&&!i.eq(d._equality_Forma_Forma,this.forma,e)&&this.canClaimForma(e)&&i.opt(i.as(this.forma,F.GroupForma),(function(t){return t.appendChild(e,!0)}))},beginUpdateGroup:function(e){void 0===e&&(e=null),null==this.oldBounds_&&(this.oldBounds_=null!=e?e:i.opt(this.forma,(function(e){return e.bounds})),null==this.resizeLayoutController_&&this.setCurrentResizeLayoutController(),i.opt(this.resizeLayoutController_,(function(e){return e.beginUpdateGroup()})))},setCurrentResizeLayoutController:function(){var e=this.preferredResizeType;if(null==e){var t=this.forma.childCount;e=this.userGroup?M.ResizeLayoutType.Proportional:t>k.TheoDocumentUtils.DESIGN_COMPLEXITY_HEURISTIC_THRESHOLD?M.ResizeLayoutType.Fit:t<=3||this.kind!=o.KIND?M.ResizeLayoutType.Pin:M.ResizeLayoutType.Spring}e==M.ResizeLayoutType.Pin?this.resizeLayoutController_=new M.PinLayoutController(this.forma):e==M.ResizeLayoutType.Spring?(this.kind==R.TypeLockupController.KIND&&x.LegacyCoreAssert.fail("Don't use a spring layout with a typelockup. It's overkill and lockups should be extremely fast.",void 0,"GroupController.setCurrentResizeLayoutController","GroupController.swift",557),this.resizeLayoutController_=new _.SpringLayoutController(this.forma)):e==M.ResizeLayoutType.Proportional?this.resizeLayoutController_=new P.ProportionalLayoutController(this.forma):e==M.ResizeLayoutType.Fit?this.resizeLayoutController_=new v.FitLayoutController(this.forma):(l.CoreAssert.fail("Invalid layout type, defaulting to proportional",void 0,"GroupController.setCurrentResizeLayoutController","GroupController.swift",569),this.resizeLayoutController_=new P.ProportionalLayoutController(this.forma))},endUpdateGroup:function(){this.oldBounds_=null,i.opt(this.resizeLayoutController_,(function(e){return e.endUpdateGroup()})),this.preserveResizeController_||(this.resizeLayoutController_=null)},updateGroup:function(){this.blockUpdate||null==this.oldBounds_||this.oldBounds_.equal(this.forma.bounds)||(this.beginBlockedUpdate(),i.opt(this.resizeLayoutController_,(function(e){return e.updateGroup()})),this.endBlockedUpdate())},applyColors:function(e,t){if(void 0===t&&(t=c.ColorRole.FieldPrimary),this.userGroup)for(var r=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!r.done;r.next()){var o;(o=r.value.controller)&&o.applyColors(i.clone(e),t)}else h.FormaController.prototype.applyColors.call(this,i.clone(e),t)},currentOpacity:{get:function(){for(var e,t=[],r=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!r.done;r.next()){var o=r.value,n=(e=i.opt(o.controller,(function(e){return e.currentOpacity})))||null!=e?e:1;t.includes(n)||t.push(n)}return t.length>0?t.length>1?1:t[0]:1}},applyOpacity:function(e){if(this.userGroup)for(var t=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!t.done;t.next()){var r;(r=t.value.controller)&&r.applyOpacity(e)}else h.FormaController.prototype.applyOpacity.call(this,e)},copyTo:function(e){void 0===e&&(e=null);var t,r=this;return this.userGroup?(t=i.as(this.forma,F.GroupForma))?s.CreationFacade.copyItems(i.clone(t.childrenAsArray),e).then((function(e){return y.GroupFacade.groupItems(i.clone(e))})).then((function(e){var t;return(t=i.as(e,d.Forma))?(t.match(r.forma),t):null})):u.CorePromise.reject("Should never get here. GroupController must have a GroupForma"):h.FormaController.prototype.copyTo.call(this,e)},doesContrast:function(){var e;if(e=i.as(this.forma,F.GroupForma))for(var t=i.iter(i.range(0,e.childCount,!1));!t.done;t.next()){var r,o=t.value;if((r=i.opt(e.childAt(o),(function(e){return e.controller})))&&!r.doesContrast())return!1}return!0},contrastCheck:function(e){if(void 0===e&&(e=!0),this.userGroup)for(var t=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!t.done;t.next()){var r;(r=t.value.controller)&&r.contrastCheck(e)}else h.FormaController.prototype.contrastCheck.call(this,e)}}}),o)},mL0c:function(e,t,r){var o,n=t,i=r("oAGj"),a=r("tGKA"),l=r("oKlP");n.PinBoundsType=i.defineEnum("PinBoundsType",{ChildrenBounds:0,Bounds:1}),n.TheoPin=(o=function(e,t,r,o,n,i,a,l,s,u){void 0===l&&(l=0),void 0===s&&(s=0),void 0===u&&(u=!1),this.forma=e,this.pinType=t,this.pinPoint=r,this.referenceForma=o,this.referencePinType=n,this.referencePoint=i,this.targetHeight=a,this.absoluteHeightDistance=l,this.relativeHeightDistance=s,this.useAbsoluteHeight=u,this.containedInParent=e.parent.finalFrame.insetRel(-.1,-.1,-.1,-.1).contains(e.finalFrame)},i.defineClass({name:"TheoPin",ctor:o,superName:"CoreObject",statics:{evalPinPoint:function(e,t,r){var o;if(o=i.opt(e.controller,(function(e){return e.getPinBounds(t)}))){var n=o.eval(r);return e.totalPlacement.transformPoint(n)}return null}},props:{offset:function(){var e,t,r;if((e=o.evalPinPoint(this.forma,this.pinType,this.pinPoint))&&(t=o.evalPinPoint(this.referenceForma,this.referencePinType,this.referencePoint))&&null!=(r=i.opt(this.referenceForma.controller,(function(e){return e.currentHeightScale})))){var n=this.useAbsoluteHeight?this.absoluteHeightDistance:r*this.relativeHeightDistance,a=1==this.pinPoint.y?-1:1;return new l.TheoPoint(t.x-e.x,t.y-e.y+a*n)}return l.TheoPoint.ZERO},offsetMatrix:function(){var e=this.offset(),t=l._minus_TheoPoint_TheoPoint(this.forma.totalPlacement.inverse.concat(this.forma.placement).transformPoint(e),this.forma.totalPlacement.inverse.concat(this.forma.placement).transformPoint(l.TheoPoint.ZERO));return a.Matrix2D.translation(t)},isRelativePin:{get:function(){return 0!=this.absoluteHeightDistance||0!=this.relativeHeightDistance}}}}),o)},"uxH+":function(e,t,r){var o,n=t,i=r("oAGj"),a=r("yhkb"),l=r("AVHO"),s=r("ascj"),u=r("FNB+"),c=r("cmoc"),d=r("9Lk3"),h=r("ZK0l"),m=r("pnSN"),f=r("fdtz"),g=r("fNpk"),p=r("8t9B"),v=r("3UhB");n.RootController=(o=function(e,t,r){h.GroupController.call(this,e,t,r)},i.defineClass({name:"RootController",ctor:o,superName:"GroupController",statics:{KIND:{get:function(){return"root"}}},props:{selectable:{get:function(){return!0}},moveable:{get:function(){return!1}},deleteable:{get:function(){return!1}},flippable:{get:function(){return!1}},nudgeable:{get:function(){return!1}},replaceable:{get:function(){var e=i.clone(this.forma.filterByControllerKind(d.GridController.KIND)),t=i.clone(this.forma.filterWithCallback((function(e){return e.isBackgroundImage()})));return 0==e.length&&0==t.length}},processFormaDoubleClick:function(e){this.owner.controllerSettingsState.settings=new l.RootControllerSettings(this)},getSuggestableColors:function(){for(var e=i.clone(h.GroupController.prototype.getSuggestableColors.call(this)),t=i.iter(this.forma.filterWithCallback((function(e){return e.isTypeLockup()})));!t.done;t.next()){var r,o=t.value;if(r=i.as(o.controller,p.TypeLockupController)){var n=r.lockupStyle.colors.fieldPrimary;if(r.textBacked&&(n=r.lockupStyle.colors.fieldSecondary),null!=n){for(var a=[],l=i.iter(e);!l.done;l.next()){var s=l.value;s[0].rgbColor.contrasts(n,!1)&&a.push(i.clone(s))}return a}}}return e},suggestTransparentBackground:function(){var e=i.clone(v.TypeLockupUtils.getFullCanvasLockups(this.forma));if(e.length>0&&i.opt(e[0].lockupStyle,(function(e){return 1==e.backingOpacity})))return!0;var t,r=this.forma.filterWithCallback((function(e){var t,r;return!(!(t=i.as(e,f.ImageForma))||!(r=i.as(e.parent,c.FrameForma)))&&!t.hasAlpha()&&r.isBackgroundImage()})).length,o=1,n=i.clone(this.forma.filterByControllerKind(d.GridController.KIND));return!(n.length>0&&(t=i.as(n[0].controller,d.GridController))&&(o=t.gridStyle.gridCells.length,t.margin>.01))&&(0==r&&1==o)},setBackgroundTransparency:function(e){var t=this;i.opt(this.forma,(function(r){return r.style.colors.fieldPrimary=i.opt(i.opt(t.forma,(function(e){return e.style.colors.fieldPrimary})),(function(t){return t.withAlphaOf(e)}))}));for(var r=i.iter(this.forma.filterWithCallback((function(e){return d.GridController.isBackgroundColoredCell(e)})));!r.done;r.next())r.value.style.opacity=e},getBackgroundTransparency:function(){var e;return(e=i.opt(i.opt(this.forma,(function(e){return e.style.colors.fieldPrimary})),(function(e){return e.alpha})))||null!=e?e:1},createGridControllerIfNone:function(){var e=i.clone(this.forma.filterByControllerKind(d.GridController.KIND));return 0==e.length&&(this.applyGridStyle(this.owner.document.gridLibrary.basicFullDesignGridStyle()),e=i.clone(this.forma.filterByControllerKind(d.GridController.KIND))),e.length>0?i.as(e[0].controller,d.GridController):null},getGridController:function(){var e=i.clone(this.forma.filterByControllerKind(d.GridController.KIND));return e.length>0?i.as(e[0].controller,d.GridController):null},applyGridStyle:function(e,t){void 0===t&&(t=0);var r=i.clone(this.forma.filterByControllerKind(d.GridController.KIND));r.length>1&&g.LegacyCoreAssert.fail("can't have more than one grid at the moment",void 0,"RootController.applyGridStyle","RootController.swift",163);var o=null,n=!1;if(0==r.length){var l=this.forma.root.page.createFormaWithController(m.GroupForma.KIND,d.GridController.KIND);l.applyStyle(this.owner.document.gridLibrary.basicFullDesignGridStyle()),this.forma.insertChildAt(l,0),o=i.as(l.controller,d.GridController),g.LegacyCoreAssert.isTrue(i.opt(i.opt(o,(function(e){return e.gridStyle})),(function(e){return 1==e.gridCells.length})),"Created a brand new grid controller. Why isn't there 1 grid cell?",void 0,"RootController.applyGridStyle","RootController.swift",177),n=!0}else o=i.as(r[0].controller,d.GridController);o.beginBlockedUpdate();var c=i.opt(this.forma,(function(e){return e.bounds}));o.forma.bounds=c;for(var h=i.iter(this.forma.visitAsArray(u.FormaTraversal.JustChildren));!h.done;h.next()){var f=h.value;i.eq(u._equality_Forma_Forma,f,o.forma)||(f.controller.moveable?o.forma.appendChild(f):o.forma.insertChildAt(f,0))}if(o.endBlockedUpdate(),o.applyStyle(e,t),n){var p,v=o.gridStyle.gridCells[0];null!=(p=this.forma.style.colors.colorID(s.ColorRole.FieldPrimary))&&(o.gridStyle.updateCell(v,null,p,null),p!=a.ColorLibraryController.BLACK_KEY&&this.forma.style.colors.setColorId(s.ColorRole.FieldPrimary,"themeColor0"==p?"themeColor1":"themeColor0"),i.opt(o,(function(e){return e.updateGroup()})))}},preferredResizeType:{get:function(){return h.GroupController._getters.preferredResizeType.call(this)},set:function(e){var t;h.GroupController._setters.preferredResizeType.call(this,e),(t=this.getGridController())&&(t.preferredResizeType=e)}}}}),o)}}]);
//# sourceMappingURL=vendors_npm_spark_d441b764-b755845f.js.map