(window.webpackJsonptheoWebApp=window.webpackJsonptheoWebApp||[]).push([[18],{"13MC":function(t,e,i){var n,r,a,s,o,l,u,c,h=e,f=i("oAGj"),p=i("N5RB"),d=i("fVJ2"),m=i("dJuF"),b=i("SmK9"),D=i("fNpk");h.IDBObjectState=f.defineProtocol("IDBObjectState",{id:"String",className:"String",properties:"Dictionary<String>",allProperties:"Dictionary<String>",object:"IDBObject",checkpoint:"() -> IDBObjectState",getProperty:"(String) -> DBProperty",apply:"(Array<IDBObjectState>) -> Void",diff:"(IDBObjectState) -> Dictionary<String>",depth:"Integer",forEachProperty:"(Boolean, (String, DBProperty) -> Void) -> Void"}),h.IDBObjectAncestorState=f.defineProtocol("IDBObjectAncestorState",{isAncestorOf:"(IDBObjectDerivedState) -> Boolean"}),h.IDBObjectDerivedState=f.defineProtocol("IDBObjectDerivedState",{basedOn:"IDBObjectAncestorState"}),h.IDBObjectMutableState=f.defineProtocol("IDBObjectMutableState",{setProperty:"(String, DBProperty) -> Void",updateProperty:"(String, Any, DBPropertyCodec) -> Boolean",removeProperty:"(String) -> Void",clear:"() -> Void",assign:"(IDBObject) -> IDBObjectState",commit:"() -> IDBObjectState"}),h.IDBObjectMutableAncestorState=f.defineProtocol("IDBObjectMutableAncestorState",{flattenFrom:"(IDBObjectDerivedState) -> Void"}),h.IDBObjectMutableDerivedState=f.defineProtocol("IDBObjectMutableDerivedState",{}),h.IDBState=f.defineProtocol("IDBState",{guid:"String",branch:"String",basedOn:"IDBState",database:"IDatabase",objectStates:"Dictionary<String>",allObjectStates:"Dictionary<String>",transaction:"ITransaction",mutableState:"IDBMutableState",beginTransaction:"(String) -> ITransaction",getDerivedState:"(String) -> IDBState",apply:"() -> Void",getObjectStateByID:"(String) -> IDBObjectState",getObjectState:"(DBObject) -> IDBObjectState",forEachObjectState:"(Boolean, (String, IDBObjectState) -> Void) -> Void",validate:"() -> IDBValidationResult",encode:"(IExportDataObject, Integer) -> Void"}),h.IDBMutableState=f.defineProtocol("IDBMutableState",{parentTransaction:"ITransaction",makeObjectMutable:"(DBObject) -> Void",newObjectState:"(DBObject) -> IDBObjectMutableState",setObjectState:"(DBObject, IDBObjectState) -> Void",addNewObject:"(DBObject, IDBObjectState) -> Void",removeObject:"(String) -> Void",commit:"() -> IDBState",abandon:"() -> Void",flattenFrom:"(IDBState) -> Void"}),h.DBObjectBaseState=(n=function(){},f.defineClass({name:"DBObjectBaseState",ctor:n,props:{basedOn:{get:function(){return null}},isAncestorOf:function(t){for(var e=t.basedOn;null!=e;){if(e===this)return!0;e=f.opt(f.as(e,h.IDBObjectDerivedState),(function(t){return t.basedOn}))}return!1},properties:{get:function(){return{}}},id:{get:function(){return f.opt(this.properties.id,(function(t){return t.stringValue}))}},depth:{get:function(){return 0}},allProperties:{get:function(){var t=f.clone(this.properties);if(null!=this.basedOn)for(var e=f.iter(f.opt(this.basedOn,(function(t){return t.allProperties})));!e.done;e.next()){var i=e.key,n=e.value;null==t[i]&&(t[i]=n)}for(var r=f.keys(t).filter((function(e){return t[e]instanceof m.DBDeletedProperty}),this),a=f.iter(r);!a.done;a.next()){var s=a.value;f.removeKey(t,s)}return t}},getProperty:function(t){return this.properties[t]||f.opt(this.basedOn,(function(e){return e.getProperty(t)}))},diff:function(t){var e=this,i={};if(t!==this)if(null!=this.basedOn&&f.as(t,h.IDBObjectAncestorState)===this.basedOn)this.forEachProperty(!1,(function(e,n){var r;(r=t.getProperty(e))?r.isEqual(n)||(i[e]=[n,r]):i[e]=[n,null]}));else if(f.opt(f.as(t,h.IDBObjectDerivedState),(function(t){return t.basedOn===e})))t.forEachProperty(!1,(function(t,n){var r;(r=e.getProperty(t))?r.isEqual(n)||(i[t]=[r,n]):i[t]=[null,n]}));else{var n=f.clone(this.allProperties);t.forEachProperty(!0,(function(t,e){var r;(r=f.removeKey(n,t))?r.isEqual(e)||(i[t]=[r,e]):i[t]=[null,e]})),f.each(n,(function(t,e){i[t]=[e,null]}))}return i},forEachProperty:function(t,e){var i,n={};f.each(this.properties,(function(t,i){e(t,i),n[t]=!0})),t&&(i=this.basedOn)&&i.forEachProperty(!0,(function(t,i){null==n[t]&&(e(t,i),n[t]=!0)}))},notifyParentChange:function(t,e,i){if(null!=e&&0==!e.length)for(var n=f.iter(e);!n.done;n.next()){var r,a=n.value;if(r=f.as(a,h.DBChildObjectState)){for(var s=r.propertyPath,o=f.as(f.opt(r.parentObject,(function(t){return t.state})),h.DBChildObjectState);null!=o;)s=o.propertyPath.appendPath(s),o=f.as(f.opt(f.opt(o,(function(t){return t.parentObject})),(function(t){return t.state})),h.DBChildObjectState);i(r,f.clone(r.deltaForPropertyPath(f.clone(t),s)))}}},notifyParentWillChange:function(t,e){this.notifyParentChange(f.clone(t),f.clone(e),(function(t,e){return t.parentWillChangeState(f.clone(e))}))},notifyParentDidChange:function(t,e){this.notifyParentChange(f.clone(t),f.clone(e),(function(t,e){return t.parentDidChangeState(f.clone(e))}))}}}),n),h.DBObjectDeletedState=(r=function(t){this.obj_=t},f.defineClass({name:"DBObjectDeletedState",ctor:r,statics:{_implements:function(t){return"IDBObjectState"==t}},props:{id:{get:function(){return null}},className:{get:function(){return""}},properties:{get:function(){return{}}},allProperties:{get:function(){return{}}},object:{get:function(){return this.obj_}},checkpoint:function(){return new r(this.object)},depth:{get:function(){return 0}},getProperty:function(t){return null},apply:function(t){},diff:function(t){var e={};if(t!==this)for(var i=f.clone(t.allProperties),n=f.iter(f.keys(i));!n.done;n.next()){var r=n.value;e[r]=[null,i[r]]}return e},forEachProperty:function(t,e){}}}),r),h.DBObjectState=(a=function(){},f.defineClass({name:"DBObjectState",ctor:a,superName:"DBObjectBaseState",statics:{_implements:function(t){return"IDBObjectDerivedState"==t||"IDBObjectState"==t||"IDBObjectAncestorState"==t}},props:{init_be8f:function(t){this.basedOn_=null,this.properties_={},this.obj_=t,this.className_=t.className,h.DBObjectBaseState.call(this)},init_2a9a:function(t,e){this.basedOn_=null,this.properties_=f.clone(e),this.obj_=t,this.className_=t.className,h.DBObjectBaseState.call(this)},init_9f95:function(t,e){this.basedOn_=t,this.properties_=f.clone(e),this.obj_=t.obj_,this.className_=t.className_,D.LegacyCoreAssert.isTrue(null!=this.obj_,"Created a new state on an object that has been destroyed.",void 0,"DBObjectState.init","DBState.swift",445),h.DBObjectBaseState.call(this)},basedOn:{get:function(){return this.basedOn_}},className:{get:function(){return this.className_}},properties:{get:function(){return this.properties_}},getProperty:function(t){return this.properties_[t]||f.opt(this.basedOn_,(function(e){return e.getProperty(t)}))},object:{get:function(){return this.obj_}},checkpoint:function(){return a.init_2a9a(this.object,f.clone(this.allProperties))},apply:function(t){if(this.obj_.state!==this){var e=f.clone(this.diff(this.obj_.state));f.count(e)>0&&this.notifyParentWillChange(f.clone(e),f.clone(t)),this.obj_.state=this,f.count(e)>0&&this.notifyParentDidChange(f.clone(e),f.clone(t))}}}}),a),h.DBObjectMutableState=(s=function(){this.mutableProperties_={}},f.defineClass({name:"DBObjectMutableState",ctor:s,superName:"DBObjectBaseState",statics:{_implements:function(t){return"IDBObjectDerivedState"==t||"IDBObjectState"==t||"IDBObjectMutableAncestorState"==t||"IDBObjectAncestorState"==t||"IDBObjectMutableState"==t||"IDBObjectMutableDerivedState"==t}},props:{init_6f66:function(t){this.className_=t,h.DBObjectBaseState.call(this)},init_226b:function(t){this.obj_=t.object,this.basedOn_=t,this.className_=t.className,h.DBObjectBaseState.call(this)},init_be8f:function(t){this.obj_=t,this.className_=t.className,h.DBObjectBaseState.call(this)},init_6271:function(t,e){this.mutableProperties_=f.clone(e),this.className_=t,h.DBObjectBaseState.call(this)},init_2a9a:function(t,e){this.obj_=t,this.mutableProperties_=f.clone(e),this.className_=t.className,h.DBObjectBaseState.call(this)},init_9f95:function(t,e){this.obj_=t.object,this.basedOn_=t,this.mutableProperties_=f.clone(e),this.className_=t.className,h.DBObjectBaseState.call(this)},basedOn:{get:function(){return this.basedOn_}},className:{get:function(){return this.className_}},properties:{get:function(){return this.mutableProperties_}},getProperty:function(t){return this.mutableProperties_[t]||f.opt(this.basedOn_,(function(e){return e.getProperty(t)}))},object:{get:function(){var t=null!=this.obj_?this.obj_:f.opt(this.basedOn,(function(t){return t.object}));return D.LegacyCoreAssert.isTrue(null!=t,"Mutable state not yet committed to an object",void 0,"DBObjectMutableState","DBState.swift",549),t}},checkpoint:function(){return s.init_2a9a(this.object,f.clone(this.allProperties))},setProperty:function(t,e){D.LegacyCoreAssert.isTrue(t==e.name,"Setting property but value name does not match field name",{valueName:e.name,name:t},"DBObjectMutableState.setProperty","DBState.swift",558),this.mutableProperties_[t]=e},updateProperty:function(t,e,i){var n,r;if((n=this.mutableProperties_[t])&&null!=(r=i.update)&&!(n instanceof m.DBDeletedProperty)){var a=r(n,e);return a!==n&&this.setProperty(t,a),!0}return!1},removeProperty:function(t){this.mutableProperties_[t]=m.DBProperty.deleted(m.DBNamePath.init_b14a(t))},clear:function(){for(var t=f.iter(f.keys(this.allProperties));!t.done;t.next()){var e=t.value;this.removeProperty(e)}},apply:function(t){var e;if(e=null!=this.obj_?this.obj_:f.opt(this.basedOn,(function(t){return t.object}))){var i=f.clone(this.diff(e.state));this.notifyParentWillChange(f.clone(i),f.clone(t)),e.state=this,this.notifyParentDidChange(f.clone(i),f.clone(t))}},assign:function(t){var e=null;this.basedOn_ instanceof h.DBObjectState?e=this.basedOn_:this.basedOn_ instanceof s&&(e=this.basedOn_.assign(t));var i=f.as(t,d.DBObject);f.opt(i,(function(t){return t.willCommitState()}));var n=null!=e?h.DBObjectState.init_9f95(e,f.clone(this.mutableProperties_)):h.DBObjectState.init_2a9a(t,f.clone(this.mutableProperties_));return t.state=n,this.obj_=t,f.opt(i,(function(t){return t.didCommitState()})),n},commit:function(){return this.assign(this.object)},flattenFrom:function(t){for(var e=[],i=t;i!==this&&null!=i;)e.splice(0,0,i),i=f.as(i.basedOn,h.IDBObjectDerivedState);for(var n=f.iter(e);!n.done;n.next())for(var r=n.value,a=f.clone(this.diff(r)),s=f.iter(a);!s.done;s.next()){var o=s.key,l=s.value;null!=l[1]?this.mutableProperties_[o]=l[1]:f.removeKey(this.mutableProperties_,o)}}}}),s),h.DBChildObjectState=(o=function(){},f.defineClass({name:"DBChildObjectState",ctor:o,statics:{_implements:function(t){return"IDBObjectState"==t||"IDBObjectMutableState"==t}},props:{pendingProperties:{get:function(){return this.pendingProperties_}},init_7008:function(t,e,i){this.obj_=t,this.parentObject_=e,this.propertyPath_=i},init_94ed:function(t,e){this.obj_=null,this.parentObject_=t,this.propertyPath_=e},id:{get:function(){return f.opt(this.properties.id,(function(t){return t.stringValue}))}},className:{get:function(){return this.obj_.className}},parentObject:{get:function(){return this.parentObject_}},propertyPath:{get:function(){return this.propertyPath_}},parentProperty:{get:function(){var t,e=null;return(t=f.opt(this.parentObject_,(function(t){return t.state})))&&this.propertyPath_.forEach((function(i){var n,r;null==e?e=t.getProperty(i.name):null!=(n=f.toInt(i.name))&&(r=f.opt(e,(function(t){return t.arrayValue})))?n<r.length&&(e=r[n]):null!=e&&e.isDictionary&&(e=e.getDictionaryProperty(i.name))})),e}},properties:{get:function(){return null!=this.pendingProperties_?this.pendingProperties_:f.opt(this.parentProperty,(function(t){return t.dictionaryValue}))||{}}},depth:{get:function(){var t;return((t=f.opt(f.as(f.opt(this.parentObject_,(function(t){return t.state})),h.IDBObjectMutableState),(function(t){return t.depth})))||null!=t?t:0)+1}},allProperties:{get:function(){return this.properties}},object:{get:function(){return this.obj_},set:function(t){this.obj_!==t&&(D.LegacyCoreAssert.isTrue(null==this.obj_,"This state already has an object assigned",void 0,"DBChildObjectState","DBState.swift",718),this.obj_=t)}},checkpoint:function(){return this},getProperty:function(t){return null!=this.pendingProperties_?this.pendingProperties_[t]:f.opt(this.parentProperty,(function(e){return e.getDictionaryProperty(t)}))},deltaFromParentDelta:function(t){return this.deltaForPropertyPath(f.clone(t),this.propertyPath)},parentWillChangeState:function(t){var e;(e=f.as(this.obj_,d.DBObject))&&f.count(t)>0&&e.willChangeState(f.clone(t))},parentDidChangeState:function(t){var e;(e=f.as(this.obj_,d.DBObject))&&f.count(t)>0&&(e.clearCache(),e.didChangeState(f.clone(t)))},savePropertyDict:function(t){var e,i;if((e=f.as(this.parentObject_,d.DBObject))&&(i=f.as(this.object,d.DBObject))){if(null==e.childObjects.find((function(t){return t.id==i.id}),this))return;for(var n=f.clone(b.DBSchema.getCodecChain(f.clone(this.propertyPath_.path),this.parentObject_)),r=this.propertyPath_,a=f.last(n)[0].encode(r,this.obj_,null);0==!n.length;){n.pop();var s=r.name;if(r=r.parent,0==n.length)e.setProperty(s,a);else{var o,l,u=null;if(null!=(o=f.last(n))&&(u=o[1]),u instanceof m.DBDeletedProperty)a=u;else if(null!=(l=f.toInt(s))){for(var c=f.clone(u.arrayValue);l>=c.length;)c.push(m.DBProperty.deleted(r.append(f.toString(c.length))));c[l]=a,a=m.DBProperty.arrayProperty(r,f.clone(c))}else{var h=f.clone(u.dictionaryValue);h[s]=a,a=m.DBProperty.dictProperty(r,f.clone(h))}}}}},savePendingProperties:function(){null!=this.pendingProperties_&&(this.savePropertyDict(f.clone(this.pendingProperties_)),this.pendingProperties_=null)},abandonPendingProperties:function(){this.pendingProperties_=null},setProperty:function(t,e){if(null==this.pendingProperties_){for(var i={},n=f.iter(this.properties);!n.done;n.next()){var r=n.key,a=n.value;r!=t&&(i[r]=a.copy())}this.pendingProperties_=f.clone(i)}e.reroot(m.DBNamePath.init_b14a(t)),this.pendingProperties_[t]=e,this.savePropertyDict(f.clone(this.pendingProperties_))},canUpdate:{get:function(){var t;return(t=f.opt(f.as(f.opt(this.parentObject_,(function(t){return t.state})),o),(function(t){return t.canUpdate})))||null!=t?t:f.is(f.opt(this.parentObject_,(function(t){return t.state})),h.IDBObjectMutableState)}},updateProperty:function(t,e,i){var n,r;if(null!=this.pendingProperties_&&(n=this.properties[t])&&null!=(r=i.update)&&!(n instanceof m.DBDeletedProperty)&&this.canUpdate){var a=r(n,e);return a!==n&&this.setProperty(t,a),!0}return!1},removeProperty:function(t){this.setProperty(t,new m.DBDeletedProperty(m.DBNamePath.init_b14a(t)))},setProperties:function(t){if(null==this.pendingProperties_){for(var e={},i=f.iter(this.properties);!i.done;i.next()){var n=i.key,r=i.value;null==t[n]&&(e[n]=r.copy())}for(var a=f.iter(t);!a.done;a.next())n=a.key,(r=a.value).reroot(m.DBNamePath.init_b14a(n)),e[n]=r;this.pendingProperties_=f.clone(e),this.savePropertyDict(f.clone(this.pendingProperties_))}},clear:function(){if(null==this.pendingProperties_){for(var t=f.clone(this.properties),e=f.iter(f.keys(this.properties));!e.done;e.next()){var i=e.value;t[i]=new m.DBDeletedProperty(m.DBNamePath.init_b14a(i))}this.pendingProperties_=f.clone(t),this.savePropertyDict(f.clone(this.pendingProperties_))}},deltaForPropertyPath:function(t,e){var i,n,r,a={},s=f.clone(e.path);if(null!=(r=t[s.shift()])){for(var o=r[0],l=r[1];0==!s.length&&(null!=o||null!=l);){var u,c=s.shift();if(null!=(u=f.toInt(c))){var h=(i=f.opt(f.opt(o,(function(t){return t.arrayValue})),(function(t){return t.length})))||null!=i?i:0,p=(n=f.opt(f.opt(l,(function(t){return t.arrayValue})),(function(t){return t.length})))||null!=n?n:0;o=u<h?f.opt(f.opt(o,(function(t){return t.arrayValue})),(function(t){return t[u]})):null,l=u<p?f.opt(f.opt(l,(function(t){return t.arrayValue})),(function(t){return t[u]})):null}else o=f.opt(o,(function(t){return t.getDictionaryProperty(c)})),l=f.opt(l,(function(t){return t.getDictionaryProperty(c)}))}null!=o&&o.isDictionary?(o.forEachDictionaryProperty((function(t,e){a[t]=[e,f.opt(l,(function(e){return e.getDictionaryProperty(t)}))]})),null!=l&&l.isDictionary&&l.forEachDictionaryProperty((function(t,e){f.keys(a).includes(t)||(a[t]=[null,e])}))):null!=l&&l.isDictionary&&l.forEachDictionaryProperty((function(t,e){a[t]=[null,e]}))}return a},diff:function(t){var e={};if(t!==this){for(var i=f.clone(this.properties),n=f.clone(t.properties),r=f.iter(f.keys(i));!r.done;r.next()){var a,s=i[c=r.value];(a=t.getProperty(c))?s.isEqual(a)||(e[c]=[s,t.getProperty(c)]):e[c]=[s,null]}for(var o=f.keys(n),l=f.keys(i),u=f.iter(o);!u.done;u.next()){var c=u.value;l.includes(c)||(e[c]=[null,n[c]])}}return e},forEachProperty:function(t,e){f.each(this.properties,(function(t,i){return e(t,i)}))},apply:function(t){f.opt(this.parentObject_,(function(t){return t.state.apply(null)}))},assign:function(t){return o.init_7008(t,this.parentObject_,this.propertyPath_)},commit:function(){return this}}}),o),h.DBStateTransaction=(l=function t(e,i,n,r){var a;this.finished_=!1,void 0===r&&(r=null);var s,o=n.database.newState((a=r)||null!=a?a:p.PostDB.undoBranchID,n);this.basedOnState_=n,this.name=i,this.parent=e,this.state=o.state,(s=f.as(e,t))&&(D.LegacyCoreAssert.isTrue(null==s.child_,"DBStateTransaction already has a child",{parentStateTransactionName:s.name},"DBStateTransaction.init","DBState.swift",1008),s.child_=this),null!=n.transaction_&&D.LegacyCoreAssert.fail("State already has a transaction",{basedOnStateTransactionName:n.transaction_.name,creating:i},"DBStateTransaction.init","DBState.swift",1014)},f.defineClass({name:"DBStateTransaction",ctor:l,statics:{_implements:function(t){return"ITransaction"==t}},props:{child:{get:function(){return this.child_}},depth:{get:function(){return null==this.parent?1:this.parent.depth+1}},description:{get:function(){return null==this.parent?this.name:this.parent.description+", "+this.name}},finish:function(){var t;this.basedOnState_.database.endTransaction(this),this.basedOnState_.endTransaction(this),(t=f.as(this.parent,l))&&(D.LegacyCoreAssert.isTrue(t.child_===this,"Parent transaction mismatch",void 0,"DBStateTransaction.finish","DBState.swift",1032),t.child_=null),this.finished_=!0},end:function(){D.LegacyCoreAssert.isFalse(this.finished_,"Transaction already finished",{name:this.name},"DBStateTransaction.end","DBState.swift",1039),this.basedOnState_.database.commitState(this.state),this.finish()},mergeWithPrevious:function(){D.LegacyCoreAssert.isFalse(this.finished_,"Transaction already finished",{name:this.name},"DBStateTransaction.mergeWithPrevious","DBState.swift",1045),this.basedOnState_.database.commitAndMergeState(this.state),this.finish()},rollback:function(){D.LegacyCoreAssert.isFalse(this.finished_,"Transaction already finished",{name:this.name},"DBStateTransaction.rollback","DBState.swift",1051),this.basedOnState_.database.abandonState(this.state),this.finish()}}}),l),h.DBState=(u=function(){this.derivedStateIDs={}},f.defineClass({name:"DBState",ctor:u,statics:{_implements:function(t){return"IDBState"==t}},props:{database:{get:function(){return this.db_}},objectStates:{get:function(){return this.objectStates_}},allObjectStates:{get:function(){var t=f.dict([this.guid,this]),e=f.clone(this.objectStates),i=this.basedOn;for(D.LegacyCoreAssert.isTrue(this.generation_<200,"Depth of database states unusually high",void 0,"DBState","DBState.swift",1076);null!=i&&(D.LegacyCoreAssert.isTrue(null==t[i.guid],"Found a state cycle",void 0,"DBState","DBState.swift",1079),null==t[i.guid]);){t[i.guid]=i;for(var n=f.iter(i.objectStates);!n.done;n.next()){var r=n.key,a=n.value;null==e[r]&&(e[r]=a)}i=i.basedOn}return e}},transaction:{get:function(){return this.transaction_}},mutableState:{get:function(){var t;return(t=f.as(this.transaction_,h.DBStateTransaction))?t.state.mutableState||t.state:null}},init_40bf:function(t,e,i,n){this.db_=t,this.basedOn=null,this.generation_=0,this.objectStates_=f.clone(n),this.branch=e,this.guid=i},init_62ed:function(t,e,i,n){this.db_=t.database,this.basedOn=t,this.generation_=t.generation_+1,this.objectStates_=f.clone(n),this.branch=e,this.guid=i,t.derivedStateIDs[e]=i},checkpoint:function(){var t={};return this.forEachObjectState(!0,(function(e,i){t[e]=i.checkpoint()})),u.init_40bf(this.db_,this.branch,this.guid,f.clone(t))},descendsFrom:function(t){return this===t||this.basedOn instanceof u&&this.basedOn.descendsFrom(t)},getDerivedState:function(t){return null!=this.derivedStateIDs[t]?this.db_.getState(this.derivedStateIDs[t]):null},apply:function(){this.applyInternal(!0)},applyInternal:function(t){var e=[];this.forEachObjectState(!0,(function(t,i){return e.push([t,i])}));for(var i=f.iter(e);!i.done;i.next()){var n,r=i.value,a=r[0],s=r[1],o=this.db_.getObject(a);if(n=f.opt(o,(function(t){return t.descendantObjects}))){var l=n.map((function(t){return t.state}),this);s.apply(f.clone(l))}else s.apply(null)}t&&this.db_.stateChanged(this)},getObjectStateByID:function(t){return null!=t?this.objectStates_[t]||f.opt(this.basedOn,(function(e){return e.getObjectStateByID(t)})):null},getObjectState:function(t){return this.getObjectStateByID(t.id)},forEachObjectState:function(t,e){var i,n={};f.each(this.objectStates_,(function(t,i){e(t,i),n[t]=!0})),t&&(i=this.basedOn)&&i.forEachObjectState(!0,(function(t,i){null==n[t]&&(e(t,i),n[t]=!0)}))},validate:function(){var t,e,i=f.clone(this.allObjectStates);return(t=f.as(this.database.host,d.DBObject))&&(e=i[t.id])?b.DBSchema.getValidator(t.className)(e):new b.DBValidationErrorNoHost},encode:function(t,e){var i;if(b.DBSchema.currentSchema=b.DBSchema.init_2af7(e),i=f.as(this.database.host,d.DBObject)){var n=b.DBSchema.getDataObjectWriter(t,i.id,this,this.database);b.DBSchema.getSerializer(i.className)(this.getObjectState(i),n)}},beginTransaction:function(t){return D.LegacyCoreAssert.isTrue(null==this.transaction_,"beginTransaction: State already has an open transaction",void 0,"DBState.beginTransaction","DBState.swift",1255),this.transaction_=new h.DBStateTransaction(f.opt(this.basedOn,(function(t){return t.transaction})),t,this,this.branch),this.transaction_},endTransaction:function(t){D.LegacyCoreAssert.isTrue(t===this.transaction_,"endTransaction transaction mismatch",void 0,"DBState.endTransaction","DBState.swift",1261),this.transaction_=null}}}),u),h.DBMutableState=(c=function(){this.objectMutableStates_={},this.newObjectIDs_=[]},f.defineClass({name:"DBMutableState",ctor:c,superName:"DBState",statics:{_implements:function(t){return"IDBMutableState"==t||"IDBState"==t}},props:{parentTransaction:{get:function(){return this.basedOn.transaction}},objectStates:{get:function(){return this.objectMutableStates_}},mutableState:{get:function(){var t;return(t=h.DBState._getters.mutableState.call(this))||null!=t?t:this}},init_4be2:function(t,e,i){f.super_init(this,h.DBState,h.DBState.prototype.init_40bf,t,e,i,{})},init_1198:function(t,e,i){var n;if(f.super_init(this,h.DBState,h.DBState.prototype.init_62ed,t,e,i,{}),n=f.as(t,c))for(var r=f.iter(n.objectMutableStates_);!r.done;r.next()){var a,s=r.key,o=r.value;(a=f.as(o,h.IDBObjectAncestorState))&&(this.objectMutableStates_[s]=h.DBObjectMutableState.init_226b(a))}},init_40bf:function(t,e,i,n){f.super_init(this,h.DBState,h.DBState.prototype.init_40bf,t,e,i,f.clone(n));for(var r=f.iter(this.objectStates_);!r.done;r.next()){var a,s=r.key,o=r.value;(a=f.as(o,h.IDBObjectAncestorState))&&(this.objectMutableStates_[s]=h.DBObjectMutableState.init_226b(a))}},init_62ed:function(t,e,i,n){f.super_init(this,h.DBState,h.DBState.prototype.init_62ed,t,e,i,f.clone(n));for(var r=f.iter(this.objectStates_);!r.done;r.next()){var a,s=r.key,o=r.value;(a=f.as(o,h.IDBObjectAncestorState))&&(this.objectMutableStates_[s]=h.DBObjectMutableState.init_226b(a))}},getObjectStateByID:function(t){return null!=t?this.objectMutableStates_[t]||h.DBState.prototype.getObjectStateByID.call(this,t):null},forEachObjectState:function(t,e){var i,n={};f.each(this.objectMutableStates_,(function(t,i){e(t,i),n[t]=!0})),t&&(i=this.basedOn)&&i.forEachObjectState(!0,(function(t,i){null==n[t]&&(e(t,i),n[t]=!0)}))},stateToMutableState:function(t){var e,i,n;return(e=f.as(t,h.IDBObjectMutableState))?e:(i=f.as(t,h.IDBObjectDerivedState))&&(n=i.basedOn)?h.DBObjectMutableState.init_9f95(n,f.clone(t.properties)):h.DBObjectMutableState.init_2a9a(t.object,f.clone(t.properties))},makeObjectMutable:function(t){null==f.indexForKey(this.objectMutableStates_,t.id)&&this.newObjectState(t)},newObjectState:function(t){if(t.isChildObject)return this.objectMutableStates_[t.id]=t.state,t.state;var e=this.basedOn,i=f.as(f.opt(e,(function(e){return e.getObjectState(t)})),h.DBObjectState);D.LegacyCoreAssert.isTrue(null!=i||!(t.initialized&&t.persisted),"Object is initialized, but could not find an existing state",{objID:t.id},"DBMutableState.newObjectState","DBState.swift",1369);var n=null!=i?h.DBObjectMutableState.init_226b(i):h.DBObjectMutableState.init_be8f(t),r=t.id;return D.LegacyCoreAssert.isTrue(null==f.indexForKey(this.objectMutableStates_,r),"Object already has a state",{objID:r},"DBMutableState.newObjectState","DBState.swift",1376),this.objectMutableStates_[t.id]=n,t.state=n,n},setObjectState:function(t,e){var i=this.stateToMutableState(e),n=t.id;D.LegacyCoreAssert.isTrue(e instanceof h.DBChildObjectState||null==f.indexForKey(this.objectMutableStates_,n),"Object already has a state",{objID:n},"DBMutableState.setObjectState","DBState.swift",1387),this.objectMutableStates_[t.id]=i,t.state=i},addNewObject:function(t,e){this.newObjectIDs_.push(t.id),this.setObjectState(t,e)},removeObject:function(t){this.newObjectIDs_.includes(t)?(f.remove(this.newObjectIDs_,t),f.removeKey(this.objectMutableStates_,t),this.db_.removeObject(t)):null!=this.objectMutableStates_[t]&&(this.objectMutableStates_[t]=this.db_.deletedObject.state)},forEachInCommitList:function(t){for(var e=[],i={},n=0;n<f.count(this.objectMutableStates_);)for(var r=f.keys(this.objectMutableStates_),a=f.iter(r);!a.done;a.next()){var s;if(null==i[u=a.value])(s=this.database.getObject(u))&&(s.willCommitState(),(l=f.as(s.state,h.DBChildObjectState))&&l.savePendingProperties()),i[u]=!0,n+=1}for(var o=f.iter(this.objectMutableStates_);!o.done;o.next()){var l,u=o.key;(p=o.value)instanceof h.DBObjectDeletedState||(D.LegacyCoreAssert.isTrue(f.is(p,h.IDBObjectMutableState),"Immutable state in mutable states dictionary",void 0,"DBMutableState.forEachInCommitList","DBState.swift",1431),(l=f.as(f.opt(this.database.getObject(u),(function(t){return t.state})),h.DBChildObjectState))?e.push([u,l]):e.push([u,p]))}f.sortInPlace(e,(function(t,e){return e[1].depth<t[1].depth}));for(var c=f.iter(e);!c.done;c.next()){var p,d=c.value;t(u=d[0],p=d[1]),f.opt(this.database.getObject(u),(function(t){return t.didCommitState()}))}},commit:function(){var t,e=this,i={};if(this.forEachInCommitList((function(t,n){var r,a,s;(r=f.as(n,h.DBObjectMutableState))?null==r.basedOn?(s=e.database.getObject(t))&&(i[t]=r.assign(s)):i[t]=r.commit():(a=f.as(n,h.DBChildObjectState))?i[t]=a:(D.LegacyCoreAssert.isTrue(n instanceof h.DBObjectDeletedState,"The only immutable object state in a mutable DB state should be the deleted object state",void 0,"DBMutableState.commit","DBState.swift",1467),i[t]=e.db_.deletedObject.state)})),t=f.as(this.basedOn,h.DBState)){var n=h.DBState.init_62ed(t,this.branch,this.guid,f.clone(i));return t.generation_>25?n.checkpoint():n}return h.DBState.init_40bf(this.db_,this.branch,this.guid,f.clone(i))},abandon:function(){var t=f.clone(this.newObjectIDs_);this.newObjectIDs_.splice(0);for(var e=f.clone(this.objectMutableStates_),i=f.iter(e);!i.done;i.next()){var n,r,a=i.key,s=i.value;(n=f.as(s,h.DBChildObjectState))&&n.abandonPendingProperties(),(r=this.database.getObject(a))&&r.abandonChanges()}for(var o=f.iter(t);!o.done;o.next())a=o.value,f.removeKey(this.objectMutableStates_,a),this.db_.removeObject(a)},flattenFrom:function(t){for(var e=this,i=[],n=t;n!==this&&null!=n;)i.splice(0,0,n),n=n.basedOn;for(var r=f.iter(i);!r.done;r.next()){var a,s=r.value;if(a=f.as(s,c))a.forEachInCommitList((function(t,i){var n;if(i instanceof h.DBObjectDeletedState)e.objectMutableStates_[t]=e.db_.deletedObject.state;else if(null==e.objectMutableStates_[t])e.objectMutableStates_[t]=e.stateToMutableState(i);else if(n=f.as(e.objectMutableStates_[t],h.DBObjectMutableState))for(var r=f.iter(i.properties);!r.done;r.next()){var a=r.key,s=r.value;n.setProperty(a,s)}}));else for(var o=f.iter(s.objectStates);!o.done;o.next()){var l,u=o.key;if((n=o.value)instanceof h.DBObjectDeletedState)this.objectMutableStates_[u]=this.db_.deletedObject.state;else if(null==this.objectMutableStates_[u])this.objectMutableStates_[u]=this.stateToMutableState(n);else if(l=f.as(this.objectMutableStates_[u],h.DBObjectMutableState))for(var p=f.iter(n.properties);!p.done;p.next()){var d=p.key,m=p.value;l.setProperty(d,m)}}}}}}),c)},N5RB:function(t,e,i){var n,r,a,s,o,l=e,u=i("oAGj"),c=i("fVJ2"),h=i("13MC"),f=i("ZhwN"),p=i("iCxV"),d=i("8vXU"),m=i("rxGp"),b=i("fNpk");l.IDatabase=u.defineProtocol("IDatabase",{host:"IDBObject",deletedObject:"IDBObject",transactionDepth:"Integer",beginTransaction:"(String, IDBState) -> ITransaction",endTransaction:"(ITransaction) -> Void",addListener:"(IDatabaseListener) -> Void",removeListener:"(IDatabaseListener) -> Void",appliedState:"IDBState",mutableState:"IDBMutableState",immutableState:"IDBState",beginBranch:"(String, IDBState, Boolean) -> IDBState",applyBranch:"(String) -> Void",branch:"String",getState:"(String) -> IDBState",newState:"(String, IDBState) -> (String, IDBMutableState)",commitState:"(IDBMutableState) -> Void",commitAndMergeState:"(IDBMutableState) -> Void",abandonState:"(IDBMutableState) -> Void",stateChanged:"(IDBState) -> Void",objectStateChanged:"(IDBObjectState) -> Void",getBranch:"(String, IDBState) -> Array<IDBState>",getBranchHead:"(String) -> IDBState",getObject:"(String) -> DBObject",createObject:"(String, IDBLink) -> DBObject",addObject:"(String, DBObject) -> Void",stageObjectState:"(String, String, IDBObjectState) -> Void",removeObject:"(String) -> Void"}),l.IDatabaseListener=u.defineProtocol("IDatabaseListener",{onBeginTransaction:"(IDatabase, ITransaction) -> Void",onEndTransaction:"(IDatabase, ITransaction) -> Void",onStateChanged:"(IDatabase, IDBState) -> Void",onObjectStateChanged:"(IDatabase, IDBObjectState) -> Void"}),l.PostDBInitialTransaction=(n=function(t,e,i){var n;void 0===i&&(i=null);var r=t.newState((n=i)||null!=n?n:l.PostDB.undoBranchID,null);this.name=e,this.parentDB_=t,this.state=r.state},u.defineClass({name:"PostDBInitialTransaction",ctor:n,statics:{_implements:function(t){return"ITransaction"==t}},props:{parent:{get:function(){return null}},child:{get:function(){return null}},depth:{get:function(){return null==this.parent?1:this.parent.depth+1}},description:{get:function(){return null==this.parent?this.name:this.parent.description+", "+this.name}},end:function(){this.parentDB_.commitState(this.state),this.parentDB_.endTransaction(this)},mergeWithPrevious:function(){this.parentDB_.commitAndMergeState(this.state),this.parentDB_.endTransaction(this)},rollback:function(){this.parentDB_.abandonState(this.state),this.parentDB_.endTransaction(this)}}}),n),l.WeakListener=(r=function(){},u.defineClass({name:"WeakListener",ctor:r,props:{init_cbb0:function(t,e){this.listener_=t,this.db_=e},onBeginTransaction:function(t){var e=this;null!=this.db_&&u.opt(this.listener_,(function(i){return i.onBeginTransaction(e.db_,t)}))},onEndTransaction:function(t){var e=this;null!=this.db_&&u.opt(this.listener_,(function(i){return i.onEndTransaction(e.db_,t)}))},onStateChanged:function(t){var e=this;null!=this.db_&&u.opt(this.listener_,(function(i){return i.onStateChanged(e.db_,t)}))},onObjectStateChanged:function(t){var e=this;null!=this.db_&&u.opt(this.listener_,(function(i){return i.onObjectStateChanged(e.db_,t)}))},init_implicit:function(t,e){this.listener_=t,this.db_=e},clone:function(){return r.init_implicit(this.listener_,this.db_)}}}),r),l.WeakState=(a=function(){},u.defineClass({name:"WeakState",ctor:a,props:{init_9ed3:function(t){this.state=t},init_implicit:function(t){this.state=t},clone:function(){return a.init_implicit(this.state)}}}),a),l.PostDocumentState=(s=function(t){this.state_=t},u.defineClass({name:"PostDocumentState",ctor:s,statics:{_implements:function(t){return"IDocumentState"==t}},props:{state:{get:function(){return this.state_}},stateGUID:{get:function(){return this.state.guid}},updateStateFromDatabase:function(t){var e;(e=t.getState(this.stateGUID))&&(this.state_=e)}}}),s),l.PostDB=(o=function(){this.initialTransaction_=null,this.initialized_=!1,this.listeners_=[],this.states_={},this.branches_={},this.appliedState_=null,this.hostObjectID_=null,this.objects_={},this.objectInitialStates_={},this.objectTypes_={},this.deletedObject_=null,this.rootState=null,this.currentState=null,this.stateManagerTransactions=[]},u.defineClass({name:"PostDB",ctor:o,statics:{undoBranchID:"undo",_implements:function(t){return"IDatabase"==t||"IDocumentStateManager"==t}},props:{deletedObject:{get:function(){return null==this.deletedObject_&&(this.deletedObject_=new c.DBDeletedObject(this)),this.deletedObject_}},transaction:{get:function(){return this.initialized_?u.opt(this.mutableState,(function(t){return t.parentTransaction})):this.initialTransaction_}},transactionDepth:{get:function(){var t;return(t=u.opt(this.transaction,(function(t){return t.depth})))||null!=t?t:0}},transactionStackDescription:{get:function(){var t;return(t=u.opt(this.transaction,(function(t){return t.description})))||null!=t?t:""}},defaultTransactionState:{get:function(){return this.appliedState_||this.stateFromDocumentState(this.currentState)||this.branches_[this.branch]}},beginTransaction:function(t,e){var i;if(i=e||this.mutableState||this.defaultTransactionState){var n="["+(null!=i.transaction?i.transaction.description+", ":"")+"+"+t+"]";return p.Host.logging.logForCategory(m.LogCategories.kTransaction,"transaction: begin "+n,d.LogLevelEnum.INFO_LEVEL),i.beginTransaction(t)}return b.LegacyCoreAssert.isTrue(0==u.count(this.branches_),"If we can't find a transaction state, our branches should be empty",void 0,"PostDB.beginTransaction","Database.swift",263),b.LegacyCoreAssert.isTrue(null==this.initialTransaction_&&0==this.initialized_,"Database already initialized. Why couldn't we find a transaction state?",void 0,"PostDB.beginTransaction","Database.swift",264),this.initialTransaction_=new l.PostDBInitialTransaction(this,t),this.initialTransaction_},beginBranch:function(t,e,i){b.LegacyCoreAssert.isTrue(e instanceof h.DBState||null==e&&this.immutableState instanceof h.DBState,"The database may only be branched from an immutable state.",void 0,"PostDB.beginBranch","Database.swift",270);var n=f.GUIDUtils.makeGUID(),r=e||this.immutableState,a=h.DBState.init_62ed(r,t,n,u.clone({}));return i&&(a.apply(),this.appliedState_=a),this.branches_[t]=a,a},applyBranch:function(t){var e;(e=this.getBranchHead(t))&&(e.apply(),this.appliedState_=e)},branch:{get:function(){var t;return(t=u.opt(this.appliedState_,(function(t){return t.branch})))||null!=t?t:o.undoBranchID}},endTransaction:function(t){p.Host.logging.logForCategory(m.LogCategories.kTransaction,"transaction: end   "+t.description,d.LogLevelEnum.INFO_LEVEL);for(var e=u.iter(this.listeners_);!e.done;e.next())e.value.onEndTransaction(t);t===this.initialTransaction_&&(this.initialTransaction_=null,this.initialized_=!0)},addListener:function(t){this.removeListener(t),this.listeners_.push(u.clone(l.WeakListener.init_cbb0(t,this)))},removeListener:function(t){this.listeners_=this.listeners_.filter((function(e){return null!=e.listener_&&e.listener_!==t}),this)},appliedState:{get:function(){return this.appliedState_}},mutableState:{get:function(){return this.initialized_?u.opt(this.appliedState_,(function(t){return t.mutableState})):u.opt(this.initialTransaction_,(function(t){return t.state}))}},immutableState:{get:function(){for(var t=this.defaultTransactionState;u.is(t,h.IDBMutableState);)t=u.opt(t,(function(t){return t.basedOn}));return t}},getState:function(t){return u.opt(this.states_[t],(function(t){return t.state}))},newState:function(t,e){var i=f.GUIDUtils.makeGUID(),n=e||this.defaultTransactionState,r=null==e||this.appliedState_===e&&u.opt(this.appliedState_,(function(e){return e.branch==t})),a=null!=n?h.DBMutableState.init_1198(n,t,i):h.DBMutableState.init_4be2(this,t,i);if(r)for(var s=u.iter(a.objectStates);!s.done;s.next())s.value.apply(null);return this.states_[i]=u.clone(l.WeakState.init_9ed3(a)),r&&(this.branches_[t]=a,this.appliedState_=a),{guid:i,state:a}},commitState:function(t){this.initialized_&&b.LegacyCoreAssert.isTrue(u.opt(t.basedOn,(function(t){return null!=t.transaction})),"commitState transaction stack underflow",void 0,"PostDB.commitState","Database.swift",361);var e,i,n=t,r=n.guid,a=n.branch,s=n.basedOn,o=t===this.appliedState_;if(0==u.count(n.objectStates)&&null!=s)this.branches_[a]=s,u.removeKey(this.states_,r);else if(e=u.as(s,h.IDBMutableState))e.flattenFrom(t),this.branches_[a]=e,u.removeKey(this.states_,r);else{var c=t.commit();this.branches_[a]=c,this.states_[r]=u.clone(l.WeakState.init_9ed3(c))}o&&((i=this.branches_[a])?(u.opt(this.host_,(function(t){return t.willApplyDatabaseState(i)})),u.opt(u.as(i,h.DBState),(function(t){return t.applyInternal(!1)})),this.appliedState_=i,u.opt(this.host_,(function(t){return t.didApplyDatabaseState(i)}))):(this.appliedState_=null,u.assert(!1)))},commitAndMergeState:function(t){var e=this;if(this.initialized_&&b.LegacyCoreAssert.isTrue(u.opt(t.basedOn,(function(t){return null!=t.transaction})),"commitAndMergeState transaction stack underflow",void 0,"PostDB.commitAndMergeState","Database.swift",402),o=u.as(t,h.DBMutableState)){var i,n=o.branch,r=t===this.appliedState_,a=o.guid;if(i=u.as(o.basedOn,h.IDBMutableState)){if(i.flattenFrom(t),this.branches_[n]=i,r){for(var s=u.iter(i.objectStates);!s.done;s.next()){var o;(o=s.value).apply(null)}this.appliedState_=i}u.removeKey(this.states_,o.guid)}else{var c,f,p,d={};if(c=o.basedOn){for(var m=u.iter(c.objectStates);!m.done;m.next()){var D=m.key,y=m.value;D!=this.hostObjectID_&&null==this.objects_[D]||(b.LegacyCoreAssert.isFalse(y instanceof h.DBObjectMutableState,"Immutable database states should not contain mutable object state",void 0,"PostDB.commitAndMergeState","Database.swift",429),d[D]=y)}u.removeKey(this.states_,c.guid),a=c.guid}if(o.forEachInCommitList((function(t,i){var n,r;if(n=e.getObject(t))if(r=d[t]){var a,s;if(i!==r&&((a=u.as(r,h.IDBObjectAncestorState))&&(s=u.as(i,h.IDBObjectDerivedState))?b.LegacyCoreAssert.isTrue(a.isAncestorOf(s),"Merging descendant database states shouldn't merge non-descendant object states",void 0,"PostDB.commitAndMergeState","Database.swift",444):b.LegacyCoreAssert.fail("Expected to merge a derived state into an ancestor state",void 0,"PostDB.commitAndMergeState","Database.swift",447)),_=u.as(r,h.DBChildObjectState))for(var o=u.clone(_.diff(i)),l=u.iter(o);!l.done;l.next()){var c,f=l.key;(c=l.value[1])?_.setProperty(f,c):_.removeProperty(f)}else{var p,m={},D=[];u.append(D,u.keys(r.properties)),u.keys(i.properties).forEach((function(t){D.includes(t)||D.push(t)})),D.forEach((function(t){m[t]=i.getProperty(t)})),(p=u.as(u.opt(u.as(r,h.IDBObjectDerivedState),(function(t){return t.basedOn})),h.DBObjectState))?(d[t]=h.DBObjectState.init_9f95(p,u.clone(m)),n.state=d[t]):(d[t]=h.DBObjectState.init_2a9a(n,u.clone(m)),n.state=d[t])}}else{var y,_,S;(y=u.as(i,h.DBObjectMutableState))?d[t]=y.assign(n):(_=u.as(i,h.DBChildObjectState))?d[t]=_:(S=u.as(i,h.DBObjectState))&&(d[t]=S)}})),u.removeKey(this.states_,o.guid),f=u.as(u.opt(o.basedOn,(function(t){return t.basedOn})),h.DBMutableState)){var _=h.DBMutableState.init_62ed(f,n,a,u.clone(d));this.branches_[n]=_}else(p=u.as(u.opt(o.basedOn,(function(t){return t.basedOn})),h.DBState))?this.branches_[n]=h.DBState.init_62ed(p,n,a,u.clone(d)):this.branches_[n]=h.DBState.init_40bf(this,n,a,u.clone(d));if(this.states_[a]=u.clone(l.WeakState.init_9ed3(this.branches_[n])),u.opt(this.currentState,(function(t){return t.updateStateFromDatabase(e)})),r){for(var S=u.iter(this.branches_[n].objectStates);!S.done;S.next())(y=S.value).apply(null);this.appliedState_=this.branches_[n]}}}},abandonState:function(t){var e,i=t,n=t===this.appliedState_,r=i.branch,a=i.basedOn;t.abandon(),this.branches_[r]=a,n&&(e=this.branches_[r])&&(u.opt(this.host_,(function(t){return t.willApplyDatabaseState(e)})),e.apply(),this.appliedState_=e,u.opt(this.host_,(function(t){return t.didApplyDatabaseState(e)})))},stateChanged:function(t){for(var e=u.iter(this.listeners_);!e.done;e.next())e.value.onStateChanged(t)},objectStateChanged:function(t){for(var e=u.iter(this.listeners_);!e.done;e.next())e.value.onObjectStateChanged(t)},getBranch:function(t,e){var i,n=[];if(i=this.branches_[t]){var r=u.opt(e,(function(t){return t.guid}));n.splice(0,0,i);for(var a=n[0].basedOn;null!=a&&(n.splice(0,0,a),a.guid!=r);)a=n[0].basedOn}return n},getBranchHead:function(t){return this.branches_[t]},getObject:function(t){return t==this.hostObjectID_?this.host_:this.objects_[t]},createObject:function(t,e){var i=this.getObject(t);return null==i&&(this.instantiateObject(t,e),i=this.objects_[t]),i},setAddedObjectState:function(t,e){var i;(i=u.as(e,h.IDBObjectAncestorState))?u.opt(this.mutableState,(function(e){return e.addNewObject(t,h.DBObjectMutableState.init_226b(i))})):u.opt(this.mutableState,(function(i){return i.addNewObject(t,e)}))},addObject:function(t,e){var i,n,r;if(e instanceof c.DBHostObject?(b.LegacyCoreAssert.isTrue(null==this.hostObjectID_,"Host object already added",void 0,"PostDB.addObject","Database.swift",597),this.hostObjectID_=t):this.objects_[t]=e,i=this.objectInitialStates_[t])if(u.removeKey(this.objectInitialStates_,t),u.removeKey(this.objectTypes_,t),r=u.as(i,h.DBObjectMutableState)){var a=r.assign(e);this.setAddedObjectState(e,a)}else this.setAddedObjectState(e,i);else if(n=u.as(e.state,h.DBChildObjectState)){var s;if(e.persisted||e.persistToDatabase(this,t),null!=(s=u.opt(this.mutableState,(function(t){return t.branch}))))for(var o=u.iter(this.getBranch(s,null));!o.done;o.next()){var l,f=o.value;(l=u.as(f,h.DBMutableState))&&l.addNewObject(e,n)}}else b.LegacyCoreAssert.isTrue(null!=this.mutableState,"Adding an object without a staged state to an immutable database",void 0,"PostDB.addObject","Database.swift",626),e.initialized||(e.state=e.emptyState),this.setAddedObjectState(e,e.initialState)},stageObjectState:function(t,e,i){this.objectInitialStates_[t]=i,this.objectTypes_[t]=e},removeObject:function(t){u.removeKey(this.objects_,t),u.removeKey(this.objectInitialStates_,t),u.removeKey(this.objectTypes_,t),null!=this.mutableState&&this.mutableState.removeObject(t)},host:{get:function(){return this.host_},set:function(t){b.LegacyCoreAssert.isTrue(null==this.host_,"Host already set",void 0,"PostDB","Database.swift",652),this.host_=t}},instantiateObject:function(t,e){var i,n,r,a;(i=this.objectInitialStates_[t])&&null!=(n=this.objectTypes_[t])&&null!=(r=c.DBHostObject.factory(n))&&(u.removeKey(this.objectInitialStates_,t),u.removeKey(this.objectTypes_,t),(a=u.as(r(t,this,i,e),c.DBObject))&&(a instanceof c.DBHostObject?(b.LegacyCoreAssert.isTrue(null==this.hostObjectID_,"Host object already added",void 0,"PostDB.instantiateObject","Database.swift",667),this.hostObjectID_=t):null==this.objects_[t]&&(this.objects_[t]=a)))},stateFromDocumentState:function(t){var e=this;return b.LegacyCoreAssert.isTrue(null==t||null!=this.states_[t.stateGUID],"Document state removed from the database",void 0,"PostDB.stateFromDocumentState","Database.swift",684),u.opt(t,(function(t){return t.updateStateFromDatabase(e)})),u.opt(t,(function(t){return t.state}))},resetStates:function(){var t;(t=this.branches_[o.undoBranchID])&&(this.rootState=new l.PostDocumentState(t),this.currentState=this.rootState)},getRootState:function(){return this.rootState},beginNewState:function(t){this.stateManagerTransactions.push(this.beginTransaction(t,this.mutableState||this.appliedState_||this.stateFromDocumentState(this.currentState)))},endNewState:function(){var t,e=this.stateManagerTransactions.pop(),i=e.name,n=(t=u.opt(u.opt(u.opt(this.mutableState,(function(t){return t.basedOn})),(function(t){return t.transaction})),(function(t){return t.name})))||null!=t?t:"nil";return b.LegacyCoreAssert.isTrue(e===u.opt(u.opt(this.mutableState,(function(t){return t.basedOn})),(function(t){return t.transaction})),"endNewState ending state manager transaction ["+i+"] that isn't the active transaction ["+n+"]",void 0,"PostDB.endNewState","Database.swift",707),e.end(),null==this.mutableState&&(b.LegacyCoreAssert.isTrue(this.appliedState_===this.branches_[o.undoBranchID],"Current state is not the branch head after a transaction",void 0,"PostDB.endNewState","Database.swift",711),this.currentState=new l.PostDocumentState(this.branches_[o.undoBranchID])),this.currentState},setCurrentState:function(t){var e,i;(e=u.as(t,l.PostDocumentState))&&u.opt(this.currentState,(function(t){return t.stateGUID!=e.stateGUID}))&&(i=this.stateFromDocumentState(e))&&(u.opt(this.host_,(function(t){return t.willApplyDatabaseState(i)})),this.currentState=e,i.apply(),this.appliedState_=i,u.opt(this.host_,(function(t){return t.didApplyDatabaseState(i)})))},getNewStateNestingDepth:function(){return this.stateManagerTransactions.length}}}),o)},O60Y:function(t,e,i){var n,r=e,a=i("oAGj");r.IDBLink=a.defineProtocol("IDBLink",{database:"IDatabase",referenceID:"String",backLink:"IDBLink",dereference:"() -> DBObject"}),r.DBLink=(n=function(){this.keepAlive_=null},a.defineClass({name:"DBLink",ctor:n,statics:{_implements:function(t){return"IDBLink"==t}},props:{init_8408:function(t,e,i){this.objID_=t,this.db_=e,this.backLinkID_=i},init_14fa:function(t,e){this.objID_=t.id,this.db_=t.persisted?t.database:null,this.backLinkID_=e,this.keepAlive_=t},database:{get:function(){return this.db_}},referenceID:{get:function(){return this.objID_}},backLink:{get:function(){return null!=this.backLinkID_?n.init_8408(this.backLinkID_,this.db_,this.objID_):null}},dereference:function(){var t;return(t=this.keepAlive_)?t:(this.keepAlive_=this.db_.createObject(this.objID_,this),this.keepAlive_)}}}),n)},QBb7:function(t,e,i){var n,r,a,s=e,o=i("oAGj"),l=i("90dd");s.ITransaction=o.defineProtocol("ITransaction",{name:"String",description:"String",parent:"ITransaction",child:"ITransaction",depth:"Integer",end:"() -> Void",mergeWithPrevious:"() -> Void",rollback:"() -> Void"}),s.TransactionMessage=(n=function(t,e,i){this.transaction=t,l.TheoMessage.call(this,e,i)},o.defineClass({name:"TransactionMessage",ctor:n,superName:"TheoMessage"}),n),s.TransactionBegunMessage=(r=function t(e,i){s.TransactionMessage.call(this,e,t.TYPE,i)},o.defineClass({name:"TransactionBegunMessage",ctor:r,superName:"TransactionMessage",statics:{TYPE:"DatabaseTransactionBegunMessage"}}),r),s.TransactionEndedMessage=(a=function t(e,i){s.TransactionMessage.call(this,e,t.TYPE,i)},o.defineClass({name:"TransactionEndedMessage",ctor:a,superName:"TransactionMessage",statics:{TYPE:"DatabaseTransactionEndedMessage"}}),a)},SmK9:function(t,e,i){var n,r,a,s,o,l,u,c,h,f,p,d,m,b,D,y,_,S,v,B,g,O,P,j,T=e,I=i("oAGj"),E=i("fVJ2"),C=i("dJuF"),V=i("13MC"),N=i("iCxV"),R=i("3hwA"),A=i("fNpk"),w=i("9YN4");T.DBSchemaType=I.defineEnum("DBSchemaType",{UnknownType:"unknown",BooleanType:"boolean",NumberType:"number",IntegerType:"integer",StringType:"string",ObjectType:"object",ArrayType:"array"}),T.DBSchemaValue=(n=function(){},I.defineClass({name:"DBSchemaValue",ctor:n,statics:{fromBool:function(t){return n.init_4199(T.DBSchemaType.BooleanType,t,null)},fromDouble:function(t){return n.init_4199(T.DBSchemaType.NumberType,t,null)},fromInt:function(t){return n.init_4199(T.DBSchemaType.IntegerType,t,null)},fromString:function(t){return n.init_4199(T.DBSchemaType.StringType,t,null)},fromClass:function(t,e){return n.init_4199(T.DBSchemaType.ObjectType,I.clone(e),t)},fromArray:function(t){return n.init_4199(T.DBSchemaType.ArrayType,I.clone(t),null)},fromDict:function(t){return n.init_4199(T.DBSchemaType.ObjectType,I.clone(t),null)},emptyValue:function(t){return n.init_4199(T.DBSchemaType.UnknownType,null,t)}},props:{init_4199:function(t,e,i){this.schemaType=t,this.value_=e,this.className_=i,this.isDefault_=!1},init_e1d9:function(t,e,i,n){this.schemaType=t,this.value_=e,this.className_=i,this.isDefault_=n},merge:function(t){if(null!=t&&t.schemaType!=T.DBSchemaType.UnknownType)if(A.LegacyCoreAssert.isTrue(this.schemaType==T.DBSchemaType.UnknownType||t.schemaType==this.schemaType,"Mismatched types in merge.",void 0,"DBSchemaValue.merge","DBSchema.swift",54),(this.schemaType==T.DBSchemaType.UnknownType||this.isDefault_)&&(this.isDefault_=t.isDefault_),null==this.className_&&(this.className_=t.className_),this.schemaType==T.DBSchemaType.ArrayType){if(null==this.value_)this.value_=t.value_;else if(null!=t.value_){var e=t.value_.concat(this.value_);this.value_=I.clone(e)}}else if(this.schemaType==T.DBSchemaType.ObjectType){if(null==this.value_)this.value_=t.value_;else if(null!=t.value_){for(var i={},n=I.iter(t.value_);!n.done;n.next()){var r=n.key,a=n.value;i[r]=a}for(var s=I.iter(this.value_);!s.done;s.next())r=s.key,a=s.value,i[r]=a;this.value_=I.clone(i)}}else null!=t.value_&&(this.value_=t.value_),this.schemaType==T.DBSchemaType.UnknownType&&(this.schemaType=t.schemaType)},property:function(t,e,i){var r=null;if(this.schemaType==T.DBSchemaType.ObjectType){for(var a={},s=I.as(I.opt(I.opt(I.as(this.value_,["Dictionary","String",n]),(function(t){return t[T.DBSchema.PROPERTY_ID]})),(function(t){return t.value_})),"String"),o=I.iter(this.value_);!o.done;o.next()){var l=o.key,u=o.value;null!=u.value_&&(a[l]=u.property(l,e,s))}if(null==this.className_||null==a[T.DBSchema.PROPERTY_ID])r=C.DBProperty.dictEncoded(C.DBNamePath.init_b14a(t),I.clone(a),this.className_);else{for(var c=V.DBObjectMutableState.init_6f66(this.className_),h=a[T.DBSchema.PROPERTY_ID].stringValue,f=I.iter(a);!f.done;f.next()){var p=f.key,d=f.value;c.setProperty(p,d)}e.stageObjectState(h,this.className_,c),r=C.DBProperty.linkProperty(C.DBNamePath.init_b14a(t),h,e,this.className_,i)}}else switch(this.schemaType){case"boolean":r=C.DBProperty.boolEncoded(C.DBNamePath.init_b14a(t),this.value_,this.className_);break;case"integer":r=C.DBProperty.intEncoded(C.DBNamePath.init_b14a(t),this.value_,this.className_);break;case"number":r=C.DBProperty.doubleEncoded(C.DBNamePath.init_b14a(t),this.value_,this.className_);break;case"string":r=C.DBProperty.stringEncoded(C.DBNamePath.init_b14a(t),this.value_,this.className_);break;case"array":var m=I.toSequence(this.value_).map((function(t){return t.element.property(I.toString(t.offset),e,i)}),this);r=C.DBProperty.arrayEncoded(C.DBNamePath.init_b14a(t),I.clone(m),this.className_);break;default:r=null}return this.isDefault_&&I.opt(r,(function(t){return t.shouldWrite=!1})),r},valuesEqual:function(t){return(this.schemaType==T.DBSchemaType.BooleanType||this.schemaType==T.DBSchemaType.IntegerType||this.schemaType==T.DBSchemaType.NumberType||this.schemaType==T.DBSchemaType.StringType)&&this.value_==t.value_},isEqual:function(t){var e;return!!(e=I.as(t,n))&&e.schemaType==this.schemaType&&e.isDefault_==this.isDefault_&&e.className_==this.className_&&this.valuesEqual(e)}}}),n),T.IDBValidationResult=I.defineProtocol("IDBValidationResult",{value:"DBSchemaValue"}),T.DBValidationResult=(r=function(){},a={},I.defineClass({name:"DBValidationResult",ctor:r,statics:{empty:{get:function(){return void 0===a.empty&&(a.empty=r.init_d41d()),a.empty}},_implements:function(t){return"IDBValidationResult"==t}},props:{init_2063:function(t){this.value=t},init_d41d:function(){this.value=null}}}),r),T.DBValidationError=(s=function(){},I.defineClass({name:"DBValidationError",ctor:s,statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{value:{get:function(){return null}},error:{get:function(){return"Validation failed"}}}}),s),T.DBValidationErrorNotImplemented=(o=function(){T.DBValidationError.call(this)},I.defineClass({name:"DBValidationErrorNotImplemented",ctor:o,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"Not implemented"}}}}),o),T.DBValidationErrorNoHost=(l=function(){T.DBValidationError.call(this)},I.defineClass({name:"DBValidationErrorNoHost",ctor:l,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"No host object or host object state"}}}}),l),T.DBValidationErrorType=(u=function(t,e){this.value_=t,this.type_=e},I.defineClass({name:"DBValidationErrorType",ctor:u,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return null!=this.value_?this.value_+" is not of type "+this.type_:"value is nil"}}}}),u),T.DBValidationErrorConstantIntMismatch=(c=function(t,e){this.value_=t,this.constant_=e},I.defineClass({name:"DBValidationErrorConstantIntMismatch",ctor:c,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" != "+this.constant_}}}}),c),T.DBValidationErrorConstantStringMismatch=(h=function(t,e){this.value_=t,this.constant_=e},I.defineClass({name:"DBValidationErrorConstantStringMismatch",ctor:h,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" != "+this.constant_}}}}),h),T.DBValidationErrorIntEnumMismatch=(f=function(t,e){this.value_=t,this.enumeration_=I.clone(e)},I.defineClass({name:"DBValidationErrorIntEnumMismatch",ctor:f,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" not in "+this.enumeration_}}}}),f),T.DBValidationErrorStringEnumMismatch=(p=function(t,e){this.value_=t,this.enumeration_=I.clone(e)},I.defineClass({name:"DBValidationErrorStringEnumMismatch",ctor:p,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" not in "+this.enumeration_}}}}),p),T.DBValidationErrorLimit=(d=function(t,e,i,n){this.value_=t,this.limit_=e,this.less_=i,this.exclusive_=n},I.defineClass({name:"DBValidationErrorLimit",ctor:d,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{comparator:{get:function(){return this.less_?this.exclusive_?"<":"<=":this.exclusive_?">":">="}},error:{get:function(){return this.value_+" "+this.comparator+" "+this.limit_}}}}),d),T.DBValidationErrorMultiple=(m=function(t,e){this.value_=t,this.factor_=e},I.defineClass({name:"DBValidationErrorMultiple",ctor:m,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" is not a multiple of "+this.factor_}}}}),m),T.DBValidationErrorLimitStringLength=(b=function(t,e,i){this.length_=t,this.limit_=e,this.less_=i},I.defineClass({name:"DBValidationErrorLimitStringLength",ctor:b,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{comparator:{get:function(){return this.less_?"<":">"}},error:{get:function(){return"String length "+this.length_+" "+this.comparator+" "+this.limit_}}}}),b),T.DBValidationErrorStringPattern=(D=function(t,e){this.value_=t,this.pattern_=e},I.defineClass({name:"DBValidationErrorStringPattern",ctor:D,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" does not match pattern "+this.pattern_}}}}),D),T.DBValidationErrorLimitItems=(y=function(t,e,i){this.count_=t,this.limit_=e,this.less_=i},I.defineClass({name:"DBValidationErrorLimitItems",ctor:y,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{comparator:{get:function(){return this.less_?"<":">"}},error:{get:function(){return"Item count "+this.count_+" "+this.comparator+" "+this.limit_}}}}),y),T.DBValidationErrorUniqueItems=(_=function(t){this.arrayValue_=I.clone(t)},I.defineClass({name:"DBValidationErrorUniqueItems",ctor:_,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"Items "+this.arrayValue_+" not unique"}}}}),_),T.DBValidationErrorRequiredItem=(S=function(t){this.arrayValue_=I.clone(t)},I.defineClass({name:"DBValidationErrorRequiredItem",ctor:S,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"Required item not found in "+this.arrayValue_}}}}),S),T.DBValidationErrorLimitProperties=(v=function(t,e,i){this.count_=t,this.limit_=e,this.less_=i},I.defineClass({name:"DBValidationErrorLimitProperties",ctor:v,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{comparator:{get:function(){return this.less_?"<":">"}},error:{get:function(){return"Property count "+this.count_+" "+this.comparator+" "+this.limit_}}}}),v),T.DBValidationErrorRequiredProperty=(B=function(t,e){this.value_=t,this.propertyName_=e},I.defineClass({name:"DBValidationErrorRequiredProperty",ctor:B,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"Required property "+this.propertyName_+" not found in "+this.value_}}}}),B),T.DBValidationErrorPropertyError=(g=function(t,e,i){var n;this.propertyError_=t,this.propertyName_=e,this.className_=(n=i)||null!=n?n:""},I.defineClass({name:"DBValidationErrorPropertyError",ctor:g,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.className_+"."+this.propertyName_+" does not match schema rule: "+this.propertyError_.error}}}}),g),T.DBValidationErrorCompound=(O=function(t){this.errors_=I.clone(t)},I.defineClass({name:"DBValidationErrorCompound",ctor:O,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.errors_.reduce((function(t,e){return t+".."+e.error+"\n"}),"Validation failed:\n")}}}}),O),T.DBValidationErrorMultipleMatches=(P=function(t,e){this.matches_=I.clone(t),this.errors_=I.clone(e)},I.defineClass({name:"DBValidationErrorMultipleMatches",ctor:P,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){for(var t=this.matches_.length+" rules match:\n",e=I.iter(this.errors_);!e.done;e.next())t+=".."+e.value+"\n";return t}}}}),P),T.DBValidationErrorNegation=(j=function(){T.DBValidationError.call(this)},I.defineClass({name:"DBValidationErrorNegation",ctor:j,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"Validation passed (negation failed)"}}}}),j),T.Rule=function(){var t=function t(e,i,n){var r=this;this.rawSchema_=I.clone(e),this.filename_=i,this.pathToObject_=n,this._ref=I.as(this.rawSchema_[t._REF],"String"),this._refsResolved=!1,this._schema=I.as(this.rawSchema_[t._SCHEMA],"String"),this._id=I.as(this.rawSchema_[t._ID],"String"),this._comment=I.as(this.rawSchema_[t._COMMENT],"String"),this.title=I.as(this.rawSchema_[t.TITLE],"String"),this.description=I.as(this.rawSchema_[t.DESCRIPTION],"String"),this.dependencies=t.fromJSON(I.clone(I.as(this.rawSchema_[t.DEPENDENCIES],["Dictionary","String","Any"])),i,n+"/"+t.DEPENDENCIES),this.definitions=I.clone(t.fromDefinitions(I.clone(I.as(this.rawSchema_[t.DEFINITIONS],["Dictionary","String",["Dictionary","String","Any"]])),i,n+"/"+t.DEFINITIONS)),this.typeArray=I.clone(t.typesFromSchema(I.clone(e))),this.defaultValue=this.rawSchema_[t.DEFAULT],this.readOnly=I.as(this.rawSchema_[t.READ_ONLY],"Bool"),this.examples=I.clone(I.as(this.rawSchema_[t.EXAMPLES],["Array","Any"])),this.multipleOf=I.as(this.rawSchema_[t.MULTIPLE_OF],"Double"),this.maximum=I.as(this.rawSchema_[t.MAXIMUM],"Double"),this.exclusiveMaximum=I.as(this.rawSchema_[t.EXCLUSIVE_MAXIMUM],"Double"),this.minimum=I.as(this.rawSchema_[t.MINIMUM],"Double"),this.exclusiveMinimum=I.as(this.rawSchema_[t.EXCLUSIVE_MINIMUM],"Double"),this.maxLength=I.as(this.rawSchema_[t.MAX_LENGTH],"Int"),this.minLength=I.as(this.rawSchema_[t.MIN_LENGTH],"Int"),this.pattern=I.as(this.rawSchema_[t.PATTERN],"String"),this.tupleItems=I.clone(I.opt(I.as(this.rawSchema_[t.ITEMS],["Array",["Dictionary","String","Any"]]),(function(e){return e.map((function(e){return t.fromJSON(I.clone(e),i,n+"/"+t.ITEMS)}),r)}))),this.items=null==this.tupleItems?t.fromJSON(I.clone(I.as(this.rawSchema_[t.ITEMS],["Dictionary","String","Any"])),i,n+"/"+t.ITEMS):null,this.additionalItems=t.fromJSON(I.clone(I.as(this.rawSchema_[t.ADDITIONAL_ITEMS],["Dictionary","String","Any"])),i,n+"/"+t.ADDITIONAL_ITEMS),this.maxItems=I.as(this.rawSchema_[t.MAX_ITEMS],"Int"),this.minItems=I.as(this.rawSchema_[t.MIN_ITEMS],"Int"),this.uniqueItems=I.as(this.rawSchema_[t.UNIQUE_ITEMS],"Bool"),this.contains=t.fromJSON(I.clone(I.as(this.rawSchema_[t.CONTAINS],["Dictionary","String","Any"])),i,n+"/"+t.CONTAINS),this.properties=I.clone(t.fromDefinitions(I.clone(I.as(this.rawSchema_[t.PROPERTIES],["Dictionary","String",["Dictionary","String","Any"]])),i,n+"/"+t.PROPERTIES)),this.maxProperties=I.as(this.rawSchema_[t.MAX_PROPERTIES],"Int"),this.minProperties=I.as(this.rawSchema_[t.MIN_PROPERTIES],"Int"),this.requiredProperties=I.clone(I.as(this.rawSchema_[t.REQUIRED],["Array","String"])),this.additionalProperties=t.fromJSON(I.clone(I.as(this.rawSchema_[t.ADDITIONAL_PROPERTIES],["Dictionary","String","Any"])),i,n+"/"+t.ADDITIONAL_PROPERTIES),this.patternProperties=I.clone(t.fromDefinitions(I.clone(I.as(this.rawSchema_[t.PATTERN_PROPERTIES],["Dictionary","String",["Dictionary","String","Any"]])),i,n+"/"+t.PATTERN_PROPERTIES)),this.propertyNames=t.fromJSON(I.clone(I.as(this.rawSchema_[t.PROPERTY_NAMES],["Dictionary","String","Any"])),i,n+"/"+t.PROPERTY_NAMES),this.constant=this.rawSchema_[t.CONST],this.enumeration=I.clone(I.as(this.rawSchema_[t.ENUM],["Array","Any"])),this.format=I.as(this.rawSchema_[t.FORMAT],"String"),this.contentMediaType=I.as(this.rawSchema_[t.CONTENT_MEDIA_TYPE],"String"),this.contentEncoding=I.as(this.rawSchema_[t.CONTENT_ENCODING],"String"),this.ifRule=t.fromJSON(I.clone(I.as(this.rawSchema_[t.IF],["Dictionary","String","Any"])),i,n+"/"+t.IF),this.thenRule=t.fromJSON(I.clone(I.as(this.rawSchema_[t.THEN],["Dictionary","String","Any"])),i,n+"/"+t.THEN),this.elseRule=t.fromJSON(I.clone(I.as(this.rawSchema_[t.ELSE],["Dictionary","String","Any"])),i,n+"/"+t.ELSE),this.allOf=I.clone(I.opt(I.as(this.rawSchema_[t.ALL_OF],["Array",["Dictionary","String","Any"]]),(function(e){return e.map((function(e){return t.fromJSON(I.clone(e),i,n+"/"+t.ALL_OF)}),r)}))),this.anyOf=I.clone(I.opt(I.as(this.rawSchema_[t.ANY_OF],["Array",["Dictionary","String","Any"]]),(function(e){return e.map((function(e){return t.fromJSON(I.clone(e),i,n+"/"+t.ANY_OF)}),r)}))),this.oneOf=I.clone(I.opt(I.as(this.rawSchema_[t.ONE_OF],["Array",["Dictionary","String","Any"]]),(function(e){return e.map((function(e){return t.fromJSON(I.clone(e),i,n+"/"+t.ONE_OF)}),r)}))),this.notRule=t.fromJSON(I.clone(I.as(this.rawSchema_[t.NOT],["Dictionary","String","Any"])),i,n+"/"+t.NOT),this.className=I.as(this.rawSchema_[t.CLASS_NAME],"String"),this.manifestProperties=I.clone(I.as(this.rawSchema_[t.MANINFEST_PROPERTIES],["Array","String"])),this.readData=I.as(this.rawSchema_[t.READ_DATA],"Bool"),this.reified_=!1,this.simplified_=!1},e={};return I.defineClass({name:"Rule",ctor:t,statics:{_SCHEMA:{get:function(){return void 0===e._SCHEMA&&(e._SCHEMA="$schema"),e._SCHEMA}},_ID:{get:function(){return void 0===e._ID&&(e._ID="$id"),e._ID}},_REF:{get:function(){return void 0===e._REF&&(e._REF="$ref"),e._REF}},_COMMENT:{get:function(){return void 0===e._COMMENT&&(e._COMMENT="$comment"),e._COMMENT}},TITLE:"title",DESCRIPTION:"description",DEFINITIONS:"definitions",DEPENDENCIES:"dependencies",TYPE:"type",DEFAULT:"default",READ_ONLY:"readOnly",EXAMPLES:"examples",MULTIPLE_OF:"multipleOf",MAXIMUM:"maximum",EXCLUSIVE_MAXIMUM:"exclusiveMaximum",MINIMUM:"minimum",EXCLUSIVE_MINIMUM:"exclusiveMinimum",MAX_LENGTH:"maxLength",MIN_LENGTH:"minLength",PATTERN:"pattern",ITEMS:"items",ADDITIONAL_ITEMS:"additionalItems",MAX_ITEMS:"maxItems",MIN_ITEMS:"minItems",UNIQUE_ITEMS:"uniqueItems",CONTAINS:"contains",PROPERTIES:"properties",MAX_PROPERTIES:"maxProperties",MIN_PROPERTIES:"minProperties",REQUIRED:"required",ADDITIONAL_PROPERTIES:"additionalProperties",PATTERN_PROPERTIES:"patternProperties",PROPERTY_NAMES:"propertyNames",CONST:"const",ENUM:"enum",FORMAT:"format",CONTENT_MEDIA_TYPE:"contentMediaType",CONTENT_ENCODING:"contentEncoding",IF:"if",THEN:"then",ELSE:"else",ALL_OF:"allOf",ANY_OF:"anyOf",ONE_OF:"oneOf",NOT:"not",CLASS_NAME:"className",MANINFEST_PROPERTIES:"manifest-properties",READ_DATA:"read-data",rulesFromSchemata:function(e){for(var i={},n=I.iter(e);!n.done;n.next()){var r=n.key,a=n.value;i[r]=new t(I.clone(a),r,r+"#")}return i},definitionsFromSchemata:function(e){var i=I.clone(t.rulesFromSchemata(I.clone(e))),n=I.clone(i),r=null,a=null;a=function(e,i){var r;if(r=i.definitions)for(var s=I.iter(r);!s.done;s.next()){var o=s.key,l=s.value,u=e+"/"+o;l.definedName=o,n[u]=l,a(u+"/"+t.DEFINITIONS,l)}};for(var s=I.iter(i);!s.done;s.next()){var o=s.key,l=s.value;a(o+"#/"+t.DEFINITIONS,l)}r=function(t){return null!=t?(I.opt(n[t],(function(t){return t.resolveRefs(r)})),n[t]):null};for(var u=I.iter(n);!u.done;u.next()){(l=u.value).resolveRefs(r)}for(var c=I.iter(n);!c.done;c.next()){(l=c.value).reify()}for(var h=I.iter(n);!h.done;h.next()){(l=h.value).simplify()}return n},fromJSON:function(e,i,n){return null!=e?new t(I.clone(e),i,n):null},fromDefinitions:function(e,i,n){if(null!=e){for(var r={},a=I.iter(e);!a.done;a.next()){var s=a.key,o=a.value;r[s]=new t(I.clone(o),i,n+"/"+s)}return r}return null},typesFromSchema:function(e){var i,n,r;if(null!=(n=I.as(e[t.TYPE],"String"))){var a=T.DBSchemaType.toCaseValue(n);return null!=a?[a]:null}return(r=I.as(e[t.TYPE],["Array","String"]))?r.map((function(t){return(i=T.DBSchemaType.toCaseValue(t))||null!=i?i:T.DBSchemaType.UnknownType}),this):null}},props:{getRequiredProperties:function(){return this.requiredProperties},getPropertyRule:function(t){return I.opt(this.properties,(function(e){return e[t]}))},schemaType:{get:function(){var t;return(t=this.type)||null!=t?t:T.DBSchemaType.UnknownType}},schemaTypeName:{get:function(){var t;return(t=this.className)||null!=t?t:this.definedName}},reify:function(){var t=this,e=this.reifiedRule;if(!e.reified_){if(e.reified_=!0,e.dependencies=I.opt(e.dependencies,(function(t){return t.reify()})),e.items=I.opt(e.items,(function(t){return t.reify()})),e.additionalItems=I.opt(e.additionalItems,(function(t){return t.reify()})),e.contains=I.opt(e.contains,(function(t){return t.reify()})),e.additionalProperties=I.opt(e.additionalProperties,(function(t){return t.reify()})),e.propertyNames=I.opt(e.propertyNames,(function(t){return t.reify()})),e.ifRule=I.opt(e.ifRule,(function(t){return t.reify()})),e.thenRule=I.opt(e.thenRule,(function(t){return t.reify()})),e.elseRule=I.opt(e.elseRule,(function(t){return t.reify()})),e.notRule=I.opt(e.notRule,(function(t){return t.reify()})),e.tupleItems=I.clone(I.opt(e.tupleItems,(function(e){return e.map((function(t){return t.reify()}),t)}))),e.allOf=I.clone(I.opt(e.allOf,(function(e){return e.map((function(t){return t.reify()}),t)}))),e.anyOf=I.clone(I.opt(e.anyOf,(function(e){return e.map((function(t){return t.reify()}),t)}))),e.oneOf=I.clone(I.opt(e.oneOf,(function(e){return e.map((function(t){return t.reify()}),t)}))),null!=e.definitions)for(var i=I.iter(e.definitions);!i.done;i.next()){var n=i.key,r=i.value;e.definitions[n]=r.reify()}if(null!=e.properties)for(var a=I.iter(e.properties);!a.done;a.next()){n=a.key,r=a.value;e.properties[n]=r.reify()}if(null!=e.patternProperties)for(var s=I.iter(e.patternProperties);!s.done;s.next()){n=s.key,r=s.value;e.patternProperties[n]=r.reify()}}return e},simplify:function(){if(!this.simplified_){if(this.simplified_=!0,null!=this.allOf){for(;0==!this.allOf.length;)this.merge(this.allOf.pop());this.allOf=null}if(null==this.constant&&null!=this.enumeration&&1==this.enumeration.length&&(this.constant=this.enumeration[0]),null==this.type&&null!=this.typeArray&&1==this.typeArray.length&&(this.type=this.typeArray[0]),this.stringConstant=I.as(this.constant,"String"),this.intConstant=I.as(this.constant,"Int"),this.stringEnumeration=I.clone(I.as(this.enumeration,["Array","String"])),this.intEnumeration=I.clone(I.as(this.enumeration,["Array","Int"])),I.opt(this.dependencies,(function(t){return t.simplify()})),I.opt(this.items,(function(t){return t.simplify()})),I.opt(this.additionalItems,(function(t){return t.simplify()})),I.opt(this.contains,(function(t){return t.simplify()})),I.opt(this.additionalProperties,(function(t){return t.simplify()})),I.opt(this.propertyNames,(function(t){return t.simplify()})),I.opt(this.ifRule,(function(t){return t.simplify()})),I.opt(this.thenRule,(function(t){return t.simplify()})),I.opt(this.elseRule,(function(t){return t.simplify()})),I.opt(this.notRule,(function(t){return t.simplify()})),I.opt(this.tupleItems,(function(t){return t.forEach((function(t){return t.simplify()}))})),I.opt(this.allOf,(function(t){return t.forEach((function(t){return t.simplify()}))})),I.opt(this.anyOf,(function(t){return t.forEach((function(t){return t.simplify()}))})),I.opt(this.oneOf,(function(t){return t.forEach((function(t){return t.simplify()}))})),null!=this.definitions)for(var t=I.iter(this.definitions);!t.done;t.next()){t.value.simplify()}if(null!=this.properties)for(var e=I.iter(this.properties);!e.done;e.next()){e.value.simplify()}if(null!=this.patternProperties)for(var i=I.iter(this.patternProperties);!i.done;i.next()){i.value.simplify()}}},merge:function(e){var i,n,r,a,s,o,l,u,c,h,f,p,d,m,b,D,y,_,S,v,B,g,O;if(this._id=(i=this._id)||null!=i?i:e._id,this._comment=(n=this._comment)||null!=n?n:e._comment,this.title=(r=this.title)||null!=r?r:e.title,this.description=(a=this.description)||null!=a?a:e.description,this.typeArray=I.clone(this.typeArray||e.typeArray),this.defaultValue=(s=this.defaultValue)||null!=s?s:e.defaultValue,this.readOnly=(o=this.readOnly)||null!=o?o:e.readOnly,this.examples=I.clone(this.examples||e.examples),this.multipleOf=(l=this.multipleOf)||null!=l?l:e.multipleOf,this.maximum=(u=this.maximum)||null!=u?u:e.maximum,this.exclusiveMaximum=(c=this.exclusiveMaximum)||null!=c?c:e.exclusiveMaximum,this.minimum=(h=this.minimum)||null!=h?h:e.minimum,this.exclusiveMinimum=(f=this.exclusiveMinimum)||null!=f?f:e.exclusiveMinimum,this.maxLength=(p=this.maxLength)||null!=p?p:e.maxLength,this.minLength=(d=this.minLength)||null!=d?d:e.minLength,this.pattern=(m=this.pattern)||null!=m?m:e.pattern,this.tupleItems=I.clone(this.tupleItems||e.tupleItems),this.maxItems=(b=this.maxItems)||null!=b?b:e.maxItems,this.minItems=(D=this.minItems)||null!=D?D:e.minItems,this.uniqueItems=(y=this.uniqueItems)||null!=y?y:e.uniqueItems,this.contains=this.contains||e.contains,this.maxProperties=(_=this.maxProperties)||null!=_?_:e.maxProperties,this.minProperties=(S=this.minProperties)||null!=S?S:e.minProperties,this.additionalProperties=this.additionalProperties||e.additionalProperties,this.propertyNames=this.propertyNames||e.propertyNames,this.constant=(v=this.constant)||null!=v?v:e.constant,this.enumeration=I.clone(this.enumeration||e.enumeration),this.format=(B=this.format)||null!=B?B:e.format,this.contentMediaType=I.as(this.rawSchema_[t.CONTENT_MEDIA_TYPE],"String"),this.contentEncoding=I.as(this.rawSchema_[t.CONTENT_ENCODING],"String"),this.ifRule=this.ifRule||e.ifRule,this.thenRule=this.thenRule||e.thenRule,this.elseRule=this.elseRule||e.elseRule,this.className=(g=this.className)||null!=g?g:e.className,this.readData=(O=this.readData)||null!=O?O:e.readData,null!=e.dependencies&&(null==this.dependencies?this.dependencies=e.dependencies:I.opt(this.dependencies,(function(t){return t.merge(e.dependencies)}))),null!=e.definitions)if(null==this.definitions)this.definitions=I.clone(e.definitions);else for(var P=I.iter(e.definitions);!P.done;P.next()){var j=P.key,T=P.value;null==this.definitions[j]&&(this.definitions[j]=T)}if(null!=e.items&&(null==this.items?this.items=e.items:I.opt(this.items,(function(t){return t.merge(e.items)}))),null!=e.additionalItems&&(null==this.additionalItems?this.additionalItems=e.additionalItems:I.opt(this.additionalItems,(function(t){return t.merge(e.additionalItems)}))),null!=e.properties)if(null==this.properties)this.properties=I.clone(e.properties);else for(var E=I.iter(e.properties);!E.done;E.next()){var C=E.key,V=E.value;null==this.properties[C]&&(this.properties[C]=V)}if(null!=e.patternProperties)if(null==this.patternProperties)this.patternProperties=I.clone(e.patternProperties);else for(var N=I.iter(e.patternProperties);!N.done;N.next()){var R=N.key;V=N.value;null==this.patternProperties[R]&&(this.patternProperties[R]=V)}null!=e.notRule&&(null==this.notRule?this.notRule=e.notRule:I.opt(this.notRule,(function(t){return t.merge(e.notRule)}))),null!=e.allOf&&(null==this.allOf?this.allOf=I.clone(e.allOf):this.allOf=this.allOf.concat(I.clone(e.allOf))),null!=e.anyOf&&(null==this.anyOf?this.anyOf=I.clone(e.anyOf):this.anyOf=this.anyOf.concat(I.clone(e.anyOf))),null!=e.oneOf&&(null==this.oneOf?this.oneOf=I.clone(e.oneOf):this.oneOf=this.oneOf.concat(I.clone(e.oneOf))),null!=e.manifestProperties&&(null==this.manifestProperties?this.manifestProperties=I.clone(e.manifestProperties):this.manifestProperties=I.clone(I.opt(this.manifestProperties,(function(t){return t.concat(I.clone(e.manifestProperties))})))),null!=e.requiredProperties&&(null==this.requiredProperties?this.requiredProperties=I.clone(e.requiredProperties):this.requiredProperties=I.clone(I.opt(this.requiredProperties,(function(t){return t.concat(I.clone(e.requiredProperties))}))))},resolveRefs:function(t){if(!this._refsResolved){if(this._refsResolved=!0,null!=this._ref){var e=this._ref.startsWith("#")?this.filename_+this._ref:this._ref;this._refRule=t(e)}if(I.opt(this.dependencies,(function(e){return e.resolveRefs(t)})),null!=this.definitions)for(var i=I.iter(this.definitions);!i.done;i.next()){i.value.resolveRefs(t)}if(I.opt(this.items,(function(e){return e.resolveRefs(t)})),I.opt(this.tupleItems,(function(e){return e.forEach((function(e){return e.resolveRefs(t)}))})),I.opt(this.additionalItems,(function(e){return e.resolveRefs(t)})),I.opt(this.contains,(function(e){return e.resolveRefs(t)})),null!=this.properties)for(var n=I.iter(this.properties);!n.done;n.next()){n.value.resolveRefs(t)}if(I.opt(this.additionalProperties,(function(e){return e.resolveRefs(t)})),null!=this.patternProperties)for(var r=I.iter(this.patternProperties);!r.done;r.next()){r.value.resolveRefs(t)}I.opt(this.propertyNames,(function(e){return e.resolveRefs(t)})),I.opt(this.ifRule,(function(e){return e.resolveRefs(t)})),I.opt(this.thenRule,(function(e){return e.resolveRefs(t)})),I.opt(this.elseRule,(function(e){return e.resolveRefs(t)})),I.opt(this.allOf,(function(e){return e.forEach((function(e){return e.resolveRefs(t)}))})),I.opt(this.anyOf,(function(e){return e.forEach((function(e){return e.resolveRefs(t)}))})),I.opt(this.oneOf,(function(e){return e.forEach((function(e){return e.resolveRefs(t)}))})),I.opt(this.notRule,(function(e){return e.resolveRefs(t)}))}},reifiedRule:{get:function(){return 1==I.count(this.rawSchema_)&&null!=this.rawSchema_[t._REF]&&this._refRule||this}},isValid:function(t){return null!=this.validate(t).value},validateProperty:function(t){if(t instanceof C.DBDeletedProperty)return T.DBValidationResult.empty;var e;if(e=I.as(t.objValue,E.DBObject)){var i=I.clone(e.state.allProperties);return i[T.DBSchema.PROPERTY_ID]=C.DBProperty.stringProperty(C.DBNamePath.init_b14a(T.DBSchema.PROPERTY_ID),e.id),this.validate(I.clone(i))}return this.validate(t.value)},validate:function(t){var e,i,n=this;if(i=I.as(t,C.DBProperty))return this.validateProperty(i);if(null!=this._refRule)return this._refRule.validate(t);var r=null;if(null!=this.className&&(null==r?r=this.emptyClass(t).value:I.opt(r,(function(e){return e.merge(n.emptyClass(t).value)}))),null!=this.constant){var a,s=this.validateConstant(t);if(a=I.as(s,T.DBValidationError))return a;null==r?r=s.value:I.opt(r,(function(t){return t.merge(s.value)}))}else if(null!=this.enumeration){var o,l=this.validateEnumeration(t);if(o=I.as(l,T.DBValidationError))return o;null==r?r=l.value:I.opt(r,(function(t){return t.merge(l.value)}))}if(null!=this.type){var u,c,h=null;switch(this.type){case"boolean":h=this.validateBoolean(t);break;case"integer":h=this.validateInteger(t);break;case"number":h=this.validateNumber(t);break;case"string":h=this.validateString(t);break;case"array":h=this.validateArray(t);break;case"object":h=this.validateObject(t);break;case"unknown":return this.fail(t)}if(u=I.as(h,T.DBValidationError))return u;(c=I.opt(h,(function(t){return t.value})))&&(null==r?r=c:I.opt(r,(function(t){return t.merge(c)})))}else if(null!=this.typeArray){var f,p=this.validateTypes(t);if(f=I.as(p,T.DBValidationError))return f;null==r?r=p.value:I.opt(r,(function(t){return t.merge(p.value)}))}if(null!=this.anyOf||null!=this.oneOf||null!=this.ifRule&&null!=this.thenRule||null!=this.notRule){var d,m=this.validateCompounds(t);if(d=I.as(m,T.DBValidationError))return d;null==r?r=m.value:I.opt(r,(function(t){return t.merge(m.value)}))}return null!=this.defaultValue&&(null==r?r=this.validateDefault(t).value:I.opt(r,(function(e){return e.merge(n.validateDefault(t).value)}))),(!(e=this.readData)&&null==e||e)&&null!=r?T.DBValidationResult.init_2063(r):T.DBValidationResult.empty},fail:function(t){return new T.DBValidationError},pass:function(t){return T.DBValidationResult.init_2063(T.DBSchemaValue.init_4199(T.DBSchemaType.UnknownType,t,this.className))},emptyClass:function(t){return T.DBValidationResult.init_2063(T.DBSchemaValue.emptyValue(this.className))},validateDefault:function(t){var e;return null==t?T.DBValidationResult.init_2063(T.DBSchemaValue.init_e1d9((e=this.type)||null!=e?e:T.DBSchemaType.UnknownType,this.defaultValue,this.className,!0)):T.DBValidationResult.init_2063(T.DBSchemaValue.emptyValue(this.className))},validateConstant:function(t){var e,i,n,r;return null!=(e=this.intConstant)?null!=t?null!=(n=I.as(t,"Int"))?n==e?T.DBValidationResult.init_2063(T.DBSchemaValue.fromInt(n)):new T.DBValidationErrorConstantIntMismatch(n,e):new T.DBValidationErrorType(t,T.DBSchemaType.IntegerType):T.DBValidationResult.init_2063(T.DBSchemaValue.init_4199(T.DBSchemaType.IntegerType,null,null)):null!=(i=this.stringConstant)?null!=t?null!=(r=I.as(t,"String"))?r==i?T.DBValidationResult.init_2063(T.DBSchemaValue.fromString(r)):new T.DBValidationErrorConstantStringMismatch(r,i):new T.DBValidationErrorType(t,T.DBSchemaType.StringType):T.DBValidationResult.init_2063(T.DBSchemaValue.init_4199(T.DBSchemaType.StringType,null,null)):new T.DBValidationErrorNotImplemented},validateEnumeration:function(t){var e,i,n,r;return(e=this.intEnumeration)?null!=(n=I.as(t,"Int"))?e.includes(n)?T.DBValidationResult.init_2063(T.DBSchemaValue.fromInt(n)):new T.DBValidationErrorIntEnumMismatch(n,I.clone(e)):new T.DBValidationErrorType(t,T.DBSchemaType.IntegerType):(i=this.stringEnumeration)?null!=t?null!=(r=I.as(t,"String"))?i.includes(r)?T.DBValidationResult.init_2063(T.DBSchemaValue.fromString(r)):new T.DBValidationErrorStringEnumMismatch(r,I.clone(i)):new T.DBValidationErrorType(t,T.DBSchemaType.StringType):T.DBValidationResult.init_2063(T.DBSchemaValue.init_4199(T.DBSchemaType.StringType,null,null)):new T.DBValidationErrorNotImplemented},validateTypes:function(t){for(var e=[],i=I.iter(this.typeArray);!i.done;i.next()){var n,r=null;switch(i.value){case"boolean":r=this.validateBoolean(t);break;case"integer":r=this.validateInteger(t);break;case"number":r=this.validateNumber(t);break;case"string":r=this.validateString(t);break;case"array":r=this.validateArray(t);break;case"object":r=this.validateObject(t);break;case"unknown":e.push(this.fail(t))}if(I.opt(r,(function(t){return null!=t.value})))return r;(n=I.as(r,T.DBValidationError))&&e.push(n)}return new T.DBValidationErrorCompound(I.clone(e))},validateBoolean:function(t){var e;return null!=t?null!=(e=I.as(t,"Bool"))?T.DBValidationResult.init_2063(T.DBSchemaValue.fromBool(e)):new T.DBValidationErrorType(t,T.DBSchemaType.BooleanType):T.DBValidationResult.init_2063(T.DBSchemaValue.init_4199(T.DBSchemaType.BooleanType,null,null))},validateInteger:function(t){if(null!=t){var e;if(null!=(e=I.as(t,"Int"))){if(null!=this.maximum&&I.toDouble(e)>this.maximum)return new T.DBValidationErrorLimit(e,this.maximum,!1,!1);if(null!=this.exclusiveMaximum&&I.toDouble(e)>=this.exclusiveMaximum)return new T.DBValidationErrorLimit(e,this.maximum,!1,!0);if(null!=this.minimum&&I.toDouble(e)<this.minimum)return new T.DBValidationErrorLimit(e,this.minimum,!0,!1);if(null!=this.exclusiveMinimum&&I.toDouble(e)<=this.exclusiveMinimum)return new T.DBValidationErrorLimit(e,this.minimum,!0,!0);var i;if(null!=(i=this.multipleOf)){var n=I.toDouble(e),r=n/i;if(r!=Math.floor(r))return new T.DBValidationErrorMultiple(n,i)}return T.DBValidationResult.init_2063(T.DBSchemaValue.fromInt(e))}return new T.DBValidationErrorType(t,T.DBSchemaType.IntegerType)}return T.DBValidationResult.init_2063(T.DBSchemaValue.init_4199(T.DBSchemaType.IntegerType,null,null))},validateNumber:function(t){if(null!=t){var e;if(null!=(e=I.as(t,"Double"))){if(null!=this.maximum&&e>this.maximum)return new T.DBValidationErrorLimit(e,this.maximum,!1,!1);if(null!=this.exclusiveMaximum&&e>=this.exclusiveMaximum)return new T.DBValidationErrorLimit(e,this.maximum,!1,!0);if(null!=this.minimum&&e<this.minimum)return new T.DBValidationErrorLimit(e,this.minimum,!0,!1);if(null!=this.exclusiveMinimum&&e<=this.exclusiveMinimum)return new T.DBValidationErrorLimit(e,this.minimum,!0,!0);var i;if(null!=(i=this.multipleOf)){var n=e/i;if(n!=Math.floor(n))return new T.DBValidationErrorMultiple(e,i)}return T.DBValidationResult.init_2063(T.DBSchemaValue.fromDouble(e))}return new T.DBValidationErrorType(t,T.DBSchemaType.NumberType)}return T.DBValidationResult.init_2063(T.DBSchemaValue.init_4199(T.DBSchemaType.NumberType,null,null))},validateString:function(t){var e,i=this;if(null!=t){var n;if(null!=(n=I.as(t,"String"))){if(null!=this.maxLength&&n.length>this.maxLength)return new T.DBValidationErrorLimitStringLength(n.length,this.maxLength,!1);if(null!=this.minLength&&n.length<this.minLength)return new T.DBValidationErrorLimitStringLength(n.length,this.minLength,!0);if(null!=this.pattern)if(!(!(e=I.opt(N.Host.schema,(function(t){return t.matches(n,i.pattern)})))&&null==e||e))return new T.DBValidationErrorStringPattern(n,this.pattern);return T.DBValidationResult.init_2063(T.DBSchemaValue.fromString(n))}return new T.DBValidationErrorType(t,T.DBSchemaType.StringType)}return T.DBValidationResult.init_2063(T.DBSchemaValue.init_4199(T.DBSchemaType.StringType,null,null))},validateArray:function(t){var e;if(null!=t){var i;if(i=I.as(t,["Array","Any"])){var n,r,a,s=[];if(null!=this.maxItems&&i.length>this.maxItems)return new T.DBValidationErrorLimitItems(i.length,this.maxItems,!1);if(null!=this.minItems&&i.length<this.minItems)return new T.DBValidationErrorLimitItems(i.length,this.minItems,!0);if(n=this.tupleItems)for(var o=I.iter(I.range(0,i.length,!1));!o.done;o.next()){var l=o.value;if(l>=n.length){var u;if(!(u=this.additionalItems))return new T.DBValidationErrorLimitItems(i.length,n.length,!1);var c=u.validate(i[l]);if(h=I.as(c,T.DBValidationError))return h;(m=c.value)&&s.push(m)}else{var h,f=n[l].validate(i[l]);if(h=I.as(f,T.DBValidationError))return h;(m=f.value)&&s.push(m)}}else if(r=this.items)for(var p=I.iter(i);!p.done;p.next()){var d,m,b=p.value,D=r.validate(b);if(d=I.as(D,T.DBValidationError))return d;(m=D.value)&&s.push(m)}if(((e=this.uniqueItems)||null!=e)&&e)for(var y=[],_=I.iter(s);!_.done;_.next()){t=_.value;if(y.filter((function(e){return t.isEqual(e)}),this).length>0)return new T.DBValidationErrorUniqueItems(I.clone(i));y.push(t)}if(a=this.contains){for(var S=!1,v=I.iter(i);!v.done;v.next()){b=v.value;if(a.isValid(b)){S=!0;break}}if(!S)return new T.DBValidationErrorRequiredItem(I.clone(i))}return T.DBValidationResult.init_2063(T.DBSchemaValue.fromArray(I.clone(s)))}return new T.DBValidationErrorType(t,T.DBSchemaType.ArrayType)}return T.DBValidationResult.init_2063(T.DBSchemaValue.init_4199(T.DBSchemaType.ArrayType,null,null))},validateObject:function(t){var e,i,n,r=this;if(null!=t){var a,s,o,l,u,c={};if(null!=this.maxProperties)if((a=I.as(t,["Dictionary","String","Any"]))&&I.count(a)>this.maxProperties)return new T.DBValidationErrorLimitProperties(I.count(a),this.maxProperties,!1);if(null!=this.minProperties)if((a=I.as(t,["Dictionary","String","Any"]))&&I.count(a)<this.minProperties)return new T.DBValidationErrorLimitProperties(I.count(a),this.minProperties,!0);if(C=this.requiredProperties)if(o=I.as(t,R.IImportDataObject))for(var h=I.iter(C);!h.done;h.next()){if((b=h.value)!=T.DBSchema.PROPERTY_ID&&b!=T.DBSchema.PROPERTY_TYPE&&b!=T.DBSchema.PROPERTY_NAME&&b!=T.DBSchema.PROPERTY_PATH&&null==o.property(b))return new T.DBValidationErrorRequiredProperty(o,b)}else if(I.is(t,R.IImportDataComponent))for(var f=I.iter(C);!f.done;f.next()){if((b=f.value)!=T.DBSchema.PROPERTY_ID&&b!=T.DBSchema.PROPERTY_NAME&&b!=T.DBSchema.PROPERTY_PATH&&b!=T.DBSchema.PROPERTY_MIME_TYPE&&b!=T.DBSchema.PROPERTY_ETAG&&b!=T.DBSchema.PROPERTY_URL)return new T.DBValidationErrorRequiredProperty(t,b)}else if(a=I.as(t,["Dictionary","String","Any"]))for(var p=I.iter(C);!p.done;p.next()){if(null==a[b=p.value])return new T.DBValidationErrorRequiredProperty(I.clone(a),b)}else if(null!=t)return new T.DBValidationErrorType(t,T.DBSchemaType.ObjectType);if((s=this.propertyNames)&&(u=I.as(t,["Dictionary","String","Any"])))for(var d=I.iter(I.keys(u));!d.done;d.next()){var m,b=d.value,D=s.validate(b);if(m=I.as(D,T.DBValidationError))return m}if(o=I.as(t,R.IImportDataObject)){if(null!=this.properties){var y=[];(C=this.requiredProperties)&&(y=I.clone(C)),I.append(y,I.keys(this.properties).filter((function(t){return!(((e=I.opt(r.requiredProperties,(function(e){return e.includes(t)})))||null!=e)&&e)}),this));for(var _=I.iter(y);!_.done;_.next()){var S=_.value,v=this.properties[S],B=null;if(S==T.DBSchema.PROPERTY_ID)null!=(E=o.id)&&(B=v.validate(E));else if(S==T.DBSchema.PROPERTY_TYPE){null!=(E=o.type)&&(B=v.validate(E))}else if(S==T.DBSchema.PROPERTY_NAME){null!=(E=o.name)&&(B=v.validate(E))}else if(S==T.DBSchema.PROPERTY_PATH){null!=(E=o.path)&&(B=v.validate(E))}else if(S==T.DBSchema.PROPERTY_CHILDREN){var g=[];o.forEachChild((function(t,e){return g.splice(e,0,t)})),B=v.validate(I.clone(g))}else if(S==T.DBSchema.PROPERTY_COMPONENTS){var O=[];o.forEachComponent((function(t,e){return O.splice(e,0,t)})),B=v.validate(I.clone(O))}else if(null!=(t=o.property(S)))B=v.validate(t);else if(null!=v.defaultValue){null!=(w=v.validate(null)).value&&(B=w)}if(H=I.as(B,T.DBValidationError))return new T.DBValidationErrorPropertyError(H,S,this.className);(j=I.opt(B,(function(t){return t.value})))&&(c[S]=j)}}}else if(l=I.as(t,R.IImportDataComponent)){if(null!=this.properties){y=[];(C=this.requiredProperties)&&(y=I.clone(C)),I.append(y,I.keys(this.properties).filter((function(t){return!(((i=I.opt(r.requiredProperties,(function(e){return e.includes(t)})))||null!=i)&&i)}),this));for(var P=I.iter(y);!P.done;P.next()){var j;S=P.value,v=this.properties[S],B=null;if(S==T.DBSchema.PROPERTY_ID)null!=(E=l.id)&&(B=v.validate(E));else if(S==T.DBSchema.PROPERTY_NAME){null!=(E=l.name)&&(B=v.validate(E))}else if(S==T.DBSchema.PROPERTY_PATH){null!=(E=l.path)&&(B=v.validate(E))}else if(S==T.DBSchema.PROPERTY_MIME_TYPE){null!=(E=l.mimeType)&&(B=v.validate(E))}else if(S==T.DBSchema.PROPERTY_ETAG){null!=(E=l.etag)&&(B=v.validate(E))}else if(S==T.DBSchema.PROPERTY_URL){var E;null!=(E=l.url)&&(B=v.validate(E))}if(H=I.as(B,T.DBValidationError))return new T.DBValidationErrorPropertyError(H,S,this.className);(j=I.opt(B,(function(t){return t.value})))&&(c[S]=j)}}}else if(u=I.as(t,["Dictionary","String","Any"])){if(null!=this.properties){var C;if(C=this.requiredProperties)for(var V=I.iter(C);!V.done;V.next()){if(null==(t=u[b=V.value]))return new T.DBValidationErrorRequiredProperty(I.clone(u),b);B=this.properties[b].validate(t);if(H=I.as(B,T.DBValidationError))return new T.DBValidationErrorPropertyError(H,b,this.className);(G=B.value)&&(c[b]=G)}for(var A=I.iter(this.properties);!A.done;A.next()){b=A.key,v=A.value;if(null==c[b])if(null!=(t=u[b])){B=v.validate(t);if(H=I.as(B,T.DBValidationError))return new T.DBValidationErrorPropertyError(H,b,this.className);(G=B.value)&&(c[b]=G)}else if(null!=v.defaultValue){var w,M;(M=(w=v.validate(null)).value)&&(c[b]=M)}}}var k;if(k=this.patternProperties)for(var x=I.iter(k);!x.done;x.next())for(var L=x.key,F=(v=x.value,I.keys(u).filter((function(t){return null==c[t]&&!(!(n=I.opt(N.Host.schema,(function(e){return e.matches(t,L)})))&&null==n)&&n}),this)),U=I.iter(F);!U.done;U.next()){S=U.value,B=v.validate(u[S]);if(H=I.as(B,T.DBValidationError))return new T.DBValidationErrorPropertyError(H,S,this.className);(G=B.value)&&(c[S]=G)}var Y,q=I.keys(u).filter((function(t){return null==c[t]}),this);if(Y=this.additionalProperties)for(var W=I.iter(q);!W.done;W.next()){var H,G;S=W.value,B=Y.validate(u[S]);if(H=I.as(B,T.DBValidationError))return new T.DBValidationErrorPropertyError(H,S,this.className);(G=B.value)&&(c[S]=G)}}return T.DBValidationResult.init_2063(T.DBSchemaValue.fromDict(I.clone(c)))}return T.DBValidationResult.init_2063(T.DBSchemaValue.init_4199(T.DBSchemaType.ObjectType,null,null))},validateAnyOf:function(t,e){var i;if(i=e){for(var n=[],r=I.iter(i);!r.done;r.next()){var a,s=r.value.validate(t);if(!(a=I.as(s,T.DBValidationError)))return s;n.push(a)}return new T.DBValidationErrorCompound(I.clone(n))}return new T.DBValidationError},validateOneOf:function(t,e){var i;if(i=e){for(var n=[],r=[],a=0,s=null,o=I.iter(i);!o.done;o.next()){var l,u=o.value,c=u.validate(t);if((l=I.as(c,T.DBValidationError))?n.push(l):(s=c,a+=1,r.push(u.pathToObject_)),a>1)break}return 1==a?s:new T.DBValidationErrorMultipleMatches(I.clone(r),I.clone(n))}return new T.DBValidationError},validateCompounds:function(t){var e,i;if(A.LegacyCoreAssert.isTrue(null==this.allOf,"Rules should be simplified before validation",void 0,"Rule.validateCompounds","DBSchema.swift",1668),e=this.anyOf)return this.validateAnyOf(t,I.clone(e));if(i=this.oneOf)return this.validateAnyOf(t,I.clone(i));if(null!=this.notRule){var n=!0;return this.notRule.validate(t)instanceof T.DBValidationError&&(n=!1),n?new T.DBValidationErrorNegation:T.DBValidationResult.init_2063(T.DBSchemaValue.emptyValue(this.className))}if(null!=this.ifRule&&null!=this.thenRule){if(!(this.ifRule.validate(t)instanceof T.DBValidationError))return this.thenRule.validate(t);if(null!=this.elseRule)return this.elseRule.validate(t)}return T.DBValidationResult.init_2063(T.DBSchemaValue.emptyValue(this.className))},codec:{get:function(){var t=null!=this.definedName?C.DBPropertyCodec.typeCodec(this.definedName):null;if(null==t){if(this.schemaType==T.DBSchemaType.BooleanType)t=C.DBPropertyCodec.boolCodec();else if(this.schemaType==T.DBSchemaType.IntegerType||null!=this.intConstant||null!=this.intEnumeration)t=C.DBPropertyCodec.intCodec();else if(this.schemaType==T.DBSchemaType.NumberType)t=C.DBPropertyCodec.doubleCodec();else if(this.schemaType==T.DBSchemaType.StringType||null!=this.stringConstant||null!=this.stringEnumeration)t=C.DBPropertyCodec.stringCodec();else if(this.schemaType==T.DBSchemaType.ArrayType){if(null!=this.tupleItems){var e=this.tupleItems.map((function(t){return t.codec}),this);null!=this.additionalItems&&e.push(this.additionalItems.codec),t=C.DBPropertyCodec.tupleCodec(I.clone(e))}else if(null!=this.items){var i=this.items.codec;t=C.DBPropertyCodec.arrayCodec(i)}}else if(this.schemaType==T.DBSchemaType.ObjectType)if(null!=this.definedName&&I.opt(this.properties,(function(t){return null!=t.id})))t=C.DBPropertyCodec.objectCodec(this.definedName);else{var n={};if(null!=this.properties)for(var r=I.iter(this.properties);!r.done;r.next()){var a=r.key,s=r.value;n[a]=s.codec}t=C.DBPropertyCodec.dictionaryCodec(I.clone(n))}A.LegacyCoreAssert.isTrue(null!=t,"Failed to generate a codec.",{rule:this},"Rule","DBSchema.swift",1737)}return t}},propertyCodecs:{get:function(){var t={};if(null!=this.properties)for(var e=I.iter(this.properties);!e.done;e.next()){var i=e.key,n=e.value;i==T.DBSchema.PROPERTY_CHILDREN?t[i]=C.DBPropertyCodec.arrayCodec(C.DBPropertyCodec.objectCodec()):t[i]=n.codec}return t}},propertyRules:{get:function(){return this.properties||{}}},getCodecChain:function(t,e){var i,n=[],r=I.clone(t),a=r.shift(),s=e.getProperty(a);if(a==T.DBSchema.PROPERTY_CHILDREN){var o=C.DBPropertyCodec.arrayCodec(C.DBPropertyCodec.objectCodec());null==s&&(s=C.DBProperty.arrayProperty(C.DBNamePath.init_b14a(a),[])),n.push([o,s]),A.LegacyCoreAssert.isTrue(0==r.length,"Need to figure out property chains for database links; objects with child-states should be direct objects",void 0,"Rule.getCodecChain","DBSchema.swift",1777)}else{var l;if(l=I.opt(this.properties,(function(t){return t[a]}))){var u=l,c=function(t,e,i){var r=t.codec,a=t.schemaType;null==(s=i())&&(s=a==T.DBSchemaType.ArrayType?C.DBProperty.arrayProperty(C.DBNamePath.init_b14a(e),[]):C.DBProperty.dictProperty(C.DBNamePath.init_b14a(e),{})),n.push([r,s]),u=t},h=function(t,e){var i=I.toInt(e);return null!=t&&t.isArray&&i<t.arrayPropertyCount?t.getArrayProperty(i):null};for(c(l,a,(function(){return s}));0==!r.length;){var f,p,d,m,b,D=u.schemaType,y=r.shift(),_=null;if(null!=(f=I.last(n))&&(_=f[1]),D==T.DBSchemaType.ArrayType)if(p=u.tupleItems){if(null!=(m=I.toInt(y)))m<p.length?c(p[m],y,(function(){return h(_,y)})):(b=u.additionalItems)&&c(b,y,(function(){return h(_,y)}))}else(d=u.items)&&c(d,y,(function(){return h(_,y)}));else if(D==T.DBSchemaType.ObjectType){var S,v;if(S=I.opt(u.properties,(function(t){return t[y]})))c(S,y,(function(){return I.opt(_,(function(t){return t.getDictionaryProperty(y)}))}));else if(v=u.patternProperties)for(var B=I.iter(v);!B.done;B.next()){var g=B.key,O=B.value;((i=I.opt(N.Host.schema,(function(t){return t.matches(y,g)})))||null!=i)&&i&&c(O,y,(function(){return I.opt(_,(function(t){return t.getDictionaryProperty(y)}))}))}}else A.LegacyCoreAssert.fail("Childless schema type in codec chain",{schemaType:D},"Rule.getCodecChain","DBSchema.swift",1839)}}}return n}}}),t}(),T.DBSchema=function(){var t=function(){this.propertyCodecs={}},e={};return I.defineClass({name:"DBSchema",ctor:t,statics:{schemaVersion:"http://json-schema.org/draft-04/schema",PROPERTY_ID:"id",PROPERTY_TYPE:"type",PROPERTY_NAME:"name",PROPERTY_PATH:"path",PROPERTY_CHILDREN:"children",PROPERTY_COMPONENTS:"components",PROPERTY_MIME_TYPE:"mimeType",PROPERTY_ETAG:"etag",PROPERTY_URL:"url",PROPERTY_REF:{get:function(){return void 0===e.PROPERTY_REF&&(e.PROPERTY_REF="$ref"),e.PROPERTY_REF}},currentSchema:{get:function(){return void 0===e.currentSchema&&(e.currentSchema=t.init_2af7(w.TheoDocument.CURRENT_VERSION)),e.currentSchema},set:function(t){e.currentSchema=t}},getPropertyRules:function(e){var i;return(i=t.currentSchema.rulesByName[e])?i.propertyRules:{}},getCodecChain:function(e,i){var n,r=[];return(n=t.currentSchema.rulesByName[i.className])&&(r=I.clone(n.getCodecChain(I.clone(e),i))),r},getManifestProperties:function(e){return I.opt(t.currentSchema.rulesByName[e],(function(t){return t.manifestProperties}))},getValidator:function(e){var i=I.clone(t.getPropertyRules(e));return function(t){for(var e={},n=I.iter(i);!n.done;n.next()){var r,a=n.key,s=n.value;if((r=t.getProperty(a))&&r.shouldWrite){var o,l=s.validateProperty(r);if(o=I.as(l,T.DBValidationError))return o;e[a]=l.value}}return T.DBValidationResult.init_2063(T.DBSchemaValue.fromDict(I.clone(e)))}},getSerializer:function(e){var i=I.clone(t.getPropertyRules(e)),n=I.clone(t.getManifestProperties(e));return function(t,e){for(var r=I.iter(I.keys(i));!r.done;r.next()){var a=r.value;(o=t.getProperty(a))&&o.shouldWrite&&e(a,o,!1)}if(null!=n&&0==!n.length)for(var s=I.iter(n);!s.done;s.next()){var o;a=s.value;(o=t.getProperty(a))&&e(a,o,!0)}}},getArrayWriter:function(e,i,n){return function(r,a,s){var o,l;if(a.shouldWrite)if(null!=(o=a.className)&&(l=i.getObjectStateByID(a.linkID))){var u=t.getDictionaryWriter(m={},i,n);t.getSerializer(o)(l,u),e.push(m)}else switch(a.schemaType){case"boolean":var c;null!=(c=a.boolValue)&&e.push(c);break;case"integer":var h;null!=(h=a.intValue)&&e.push(h);break;case"number":var f;null!=(f=a.doubleValue)&&e.push(f);break;case"string":var p;null!=(p=a.stringValue)&&e.push(p);break;case"array":if(a.isArray){var d=[];u=t.getArrayWriter(d,i,n);a.forEachArrayProperty((function(t,e){return u("",e,!1)})),e.push(d)}break;case"object":if(a.isDictionary){var m;u=t.getDictionaryWriter(m={},i,n);a.forEachDictionaryProperty((function(t,e){return u(t,e,!1)})),e.push(m)}break;case"unknown":A.LegacyCoreAssert.fail("Cannot write a property of unknown type",void 0,"DBSchema.getArrayWriter","DBSchema.swift",2019)}}},getDictionaryWriter:function(e,i,n){return function(r,a,s){var o,l;if(a.shouldWrite)if(null!=(o=a.className)&&(l=i.getObjectStateByID(a.linkID))){var u=t.getDictionaryWriter(h={},i,n);t.getSerializer(o)(l,u),e[r]=h}else switch(a.schemaType){case"boolean":e[r]=a.boolValue;break;case"integer":e[r]=a.intValue;break;case"number":e[r]=a.doubleValue;break;case"string":e[r]=a.stringValue;break;case"array":if(a.isArray){var c=[];u=t.getArrayWriter(c,i,n);a.forEachArrayProperty((function(t,e){return u("",e,!1)})),e[r]=c}break;case"object":if(a.isDictionary){var h;u=t.getDictionaryWriter(h={},i,n);a.forEachDictionaryProperty((function(t,e){return u(t,e,!1)})),e[r]=h}break;case"unknown":A.LegacyCoreAssert.fail("Cannot write a property of unknown type",void 0,"DBSchema.getDictionaryWriter","DBSchema.swift",2071)}}},getDataObjectWriter:function(e,i,n,r){return function(a,s,o){if(s.shouldWrite)if(a==t.PROPERTY_ID){var l=I.opt(I.opt(n.getObjectStateByID(i),(function(e){return e.getProperty(t.PROPERTY_PATH)})),(function(t){return t.stringValue}));A.LegacyCoreAssert.isTrue(s.stringValue==i||i==l,"Saving object with ID",{objID:i,property:s.stringValue},"DBSchema.getDataObjectWriter","DBSchema.swift",2090)}else if(a!=t.PROPERTY_PATH||o)if(a!=t.PROPERTY_NAME||o)if(a!=t.PROPERTY_TYPE||o)if(a!=t.PROPERTY_COMPONENTS||o)if(a!=t.PROPERTY_CHILDREN||o){var u=s.className,c=s.objValue;if(null!=u&&null!=c){var h=t.getDictionaryWriter(m={},n,r);t.getSerializer(u)(n.getObjectStateByID(s.linkID),h),o?e.setManifestProperty(a,m,!0):e.setProperty(a,m)}else switch(s.schemaType){case"boolean":var f;null!=(f=s.boolValue)?o?e.setManifestProperty(a,I.as(f,"AnyObject"),!0):e.setBooleanProperty(a,f):e.setOptionalBooleanProperty(a,null);break;case"integer":o?e.setManifestProperty(a,I.as(s.intValue,"AnyObject"),!0):e.setIntProperty(a,s.intValue);break;case"number":o?e.setManifestProperty(a,I.as(s.doubleValue,"AnyObject"),!0):e.setNumberProperty(a,s.doubleValue);break;case"string":var p;null!=(p=s.stringValue)?o?e.setManifestProperty(a,I.as(p,"AnyObject"),!0):e.setStringProperty(a,p):e.setOptionalStringProperty(a,null);break;case"array":if(s.isArray){var d=[];h=t.getArrayWriter(d,n,r);s.forEachArrayProperty((function(t,e){return h("",e,!1)})),o?e.setManifestProperty(a,d,!0):e.setProperty(a,d)}break;case"object":if(s.isDictionary){var m;h=t.getDictionaryWriter(m={},n,r);s.forEachDictionaryProperty((function(t,e){return h(t,e,!1)})),o?e.setManifestProperty(a,m,!0):e.setProperty(a,m)}break;case"unknown":A.LegacyCoreAssert.fail("Cannot write a property of unknown type",void 0,"DBSchema.getDataObjectWriter","DBSchema.swift",2209)}}else s.isArray&&s.forEachArrayProperty((function(i,a){var s=I.as(a.objValue,E.DBObject);if(null!=s){var o=n.getObjectState(s);t.getSerializer(s.className)(o,t.getDataObjectWriter(e.appendChild(s.id),s.id,n,r))}}));else s.isArray&&s.forEachArrayProperty((function(i,n){if(n.isDictionary){var r=I.opt(n.getDictionaryProperty(t.PROPERTY_ID),(function(t){return t.stringValue})),a=I.opt(n.getDictionaryProperty(t.PROPERTY_URL),(function(t){return t.stringValue})),s=I.opt(n.getDictionaryProperty(t.PROPERTY_MIME_TYPE),(function(t){return t.stringValue}));null!=r&&null!=a&&null!=s&&e.appendComponent(r,a,s)}}));else{var b;null!=(b=s.stringValue)&&e.setType(b)}else{var D;null!=(D=s.stringValue)&&e.setName(D)}else e.setPath(s.stringValue);else o&&e.setManifestProperty(a,null,!0)}}},props:{getPropertyCodec:function(e,i){var n;return(n=t.currentSchema.propertyCodecs[i])&&n[e]||I.opt(this.getPropertyCodecs(i),(function(t){return t[e]}))},getPropertyCodecs:function(t){var e,i=I.clone(this.propertyCodecs[t]);null==i&&((e=this.rulesByName[t])&&(i=I.clone(e.propertyCodecs),this.propertyCodecs[t]=I.clone(i)));return i},init_2af7:function(t){this.init_f987(t,I.clone(N.Host.schema.getRoot(t)),N.Host.schema.rootFile,I.clone(N.Host.schema.getFiles(t)))},init_f987:function(t,e,i,n){for(var r=I.clone(T.Rule.definitionsFromSchemata(I.clone(n))),a={},s=I.iter(r);!s.done;s.next()){var o,l=s.key,u=s.value;if(l.includes("#"))null!=(o=u.definedName)&&(a[o]=u)}this.rules=I.clone(r),this.rulesByName=I.clone(a),this.rootFile=i,this.formatVersion=t,this.rootSchema=I.clone(e),this.rootSchemaFile=i,this.auxiliarySchemata=I.clone(n),this.description=I.as(this.rootSchema.description,"String")},schemaForReference:function(t){var e,i=t.split("#"),n=i[0],r=null;if(e=I.isEmpty(n)?this.rootSchema:this.auxiliarySchemata[n]){r=I.clone(e);for(var a=i[1].split("/"),s=I.iter(a.filter((function(t){return!I.isEmpty(t)}),this));!s.done;s.next()){var o,l=s.value;r=(o=I.as(I.opt(r,(function(t){return t[l]})),["Dictionary","String","Any"]))?I.clone(o):null}}return r},validateAndRead:function(t,e,i){var n,r,a=this.rules[this.rootFile],s=I.opt(a,(function(e){return e.validate(t)})),o=I.opt(s,(function(t){return t.value}));return(r=I.as(s,T.DBValidationError))&&(I.opt(N.Host.logging,(function(t){return t.warning("Validation encountered errors: "+r.error)})),i([r])),(n=I.opt(I.opt(o,(function(t){return t.property("",e,null)})),(function(t){return t.linkID})))||null!=n?n:""},referenceSchema:function(e,i){return t.init_f987(this.formatVersion,I.clone(e),i,I.clone(this.auxiliarySchemata))},type:function(e){var i,n,r,a,s,o=T.DBSchemaType.UnknownType,l=I.as(e.className,"String"),u=null;(null!=(i=I.as(e.type,"String"))&&null!=(n=T.DBSchemaType.toCaseValue(i))&&(o=n,u=this),o==T.DBSchemaType.UnknownType&&null!=e.enum)&&((r=I.as(e.enum,["Array","Any"]))&&(r.length>0&&I.is(r[0],"String")?o=T.DBSchemaType.StringType:r.length>0&&I.is(r[0],"Int")&&(o=T.DBSchemaType.IntegerType)));if(o==T.DBSchemaType.UnknownType||o==T.DBSchemaType.ObjectType&&null==l)if(null!=(a=I.as(e[t.PROPERTY_REF],"String"))){var c,h=T.DBSchemaType.UnknownType,f=null,p=null,d=a.startsWith("#")?this.rootSchemaFile+a:a;if(c=this.schemaForReference(d)){var m=d.split("#")[0],b=d.split("/");if(l=I.last(b),m==this.rootSchemaFile){var D=this.type(I.clone(c));h=D[0],f=D[1],p=D[2]}else{var y=this.referenceSchema(I.clone(c),m).type(I.clone(c));h=y[0],f=y[1],p=y[2]}}o==T.DBSchemaType.UnknownType&&(o=h),null==l&&(l=f),null==u&&(u=p)}else if(s=I.as(e.allOf,["Array",["Dictionary","String","Any"]]))for(var _=I.iter(s);!_.done;_.next()){var S=_.value,v=this.type(I.clone(S)),B=v[0],g=v[1],O=v[2];o==T.DBSchemaType.UnknownType&&(o=B),null==l&&(l=g),null==u&&(u=O)}return[o,l,u]},findValue:function(e,i){var n,r=i[e];if(null==r&&null!=(n=I.as(i[t.PROPERTY_REF],"String"))){var a,s=n.startsWith("#")?this.rootSchemaFile+n:n;(a=this.schemaForReference(s))&&(r=this.findValue(e,I.clone(a)))}return r},allProperties:function(e){A.LegacyCoreAssert.isTrue(null==e.anyOf&&null==e.oneOf,"Specific type should be known by this point or a custom codec is needed.",void 0,"DBSchema.allProperties","DBSchema.swift",2385);var i,n,r,a={};if((i=I.as(e.properties,["Dictionary","String",["Dictionary","String","Any"]]))&&(a=I.clone(i)),n=I.as(e.allOf,["Array",["Dictionary","String","Any"]]))for(var s=I.iter(n);!s.done;s.next())for(var o=s.value,l=I.iter(this.allProperties(I.clone(o)));!l.done;l.next()){var u=l.key,c=l.value;a[u]=I.clone(c)}if(null!=(r=I.as(e[t.PROPERTY_REF],"String"))){var h,f=r.startsWith("#")?this.rootSchemaFile+r:r;if(h=this.schemaForReference(f))for(var p=I.iter(this.allProperties(I.clone(h)));!p.done;p.next()){u=p.key;var d=p.value;null==a[u]&&(a[u]=I.clone(d))}}return a},schemaAttribute:function(e,i){A.LegacyCoreAssert.isTrue(null==i.anyOf&&null==i.oneOf,"Specific type should be known by this point or a custom codec is needed.",void 0,"DBSchema.schemaAttribute","DBSchema.swift",2417);var n,r,a=i[e];if(null==a&&(n=I.as(i.allOf,["Array",["Dictionary","String","Any"]])))for(var s=I.iter(n);!s.done;s.next()){var o,l=s.value;if(null!=(o=this.schemaAttribute(e,I.clone(l)))){a=o;break}}if(null==a&&null!=(r=I.as(i[t.PROPERTY_REF],"String"))){var u,c,h=r.startsWith("#")?this.rootSchemaFile+r:r;if(u=this.schemaForReference(h))null!=(c=this.schemaAttribute(e,I.clone(u)))&&(a=c)}return a}}}),t}()},dJuF:function(t,e,i){var n,r,a,s,o,l=e,u=i("oAGj"),c=i("O60Y"),h=i("fVJ2"),f=i("SmK9"),p=i("13MC"),d=i("fNpk");l.DBNamePath=(n=function(){},u.defineClass({name:"DBNamePath",ctor:n,props:{init_1346:function(t,e){this.name=t,this.parent=e},init_b14a:function(t){this.name=t,this.parent=null},prepend:function(t){return n.init_b14a(t).appendPath(this)},append:function(t){return n.init_1346(t,this)},appendPath:function(t){var e=this;return t.forEach((function(t){e=e.append(t.name)})),e},forEach:function(t){u.opt(this.parent,(function(e){return e.forEach(t)})),t(this)},path:{get:function(){var t=[];return this.forEach((function(e){return t.push(e.name)})),t}}}}),n),l.DBProperty=(r=function t(e,i,n,r){this.shouldWrite=!0,this.schemaType=e,this.className=r,this.name_=i.name,this.value_=n,this.namePath_=i,e==f.DBSchemaType.ArrayType?this.arrayValue_=u.clone(u.as(n,["Array",t])):this.arrayValue_=null,e==f.DBSchemaType.ObjectType?this.dictionaryValue_=u.clone(u.as(n,["Dictionary","String",t])):this.dictionaryValue_=null,this.reroot(i)},u.defineClass({name:"DBProperty",ctor:r,statics:{deleted:function(t){return new l.DBDeletedProperty(t)},boolEncoded:function(t,e,i){return new r(f.DBSchemaType.BooleanType,t,e,i)},doubleEncoded:function(t,e,i){return new r(f.DBSchemaType.NumberType,t,e,i)},intEncoded:function(t,e,i){return new r(f.DBSchemaType.IntegerType,t,e,i)},stringEncoded:function(t,e,i){return new r(f.DBSchemaType.StringType,t,e,i)},arrayEncoded:function(t,e,i){return new r(f.DBSchemaType.ArrayType,t,u.clone(e),i)},dictEncoded:function(t,e,i){return new r(f.DBSchemaType.ObjectType,t,u.clone(e),i)},objProperty:function(t,e,i,n){return new r(f.DBSchemaType.ObjectType,t,c.DBLink.init_14fa(e,n),i)},linkProperty:function(t,e,i,n,a){return new r(f.DBSchemaType.ObjectType,t,c.DBLink.init_8408(e,i,a),n)},boolProperty:function(t,e,i){void 0===i&&(i=!1);var n=new r(f.DBSchemaType.BooleanType,t,e,null);return n.shouldWrite=!i,n},doubleProperty:function(t,e,i){void 0===i&&(i=!1);var n=new r(f.DBSchemaType.NumberType,t,e,null);return n.shouldWrite=!i,n},intProperty:function(t,e,i){void 0===i&&(i=!1);var n=new r(f.DBSchemaType.IntegerType,t,e,null);return n.shouldWrite=!i,n},stringProperty:function(t,e,i){void 0===i&&(i=!1);var n=new r(f.DBSchemaType.StringType,t,e,null);return n.shouldWrite=!i,n},arrayProperty:function(t,e){return new r(f.DBSchemaType.ArrayType,t,u.clone(e),null)},dictProperty:function(t,e){return new r(f.DBSchemaType.ObjectType,t,u.clone(e),null)},arraysEqual:function(t,e){var i=t.arrayPropertyCount;if(e.arrayPropertyCount!=i)return!1;for(var n=u.iter(u.range(0,i,!1));!n.done;n.next()){var r=n.value;if(!t.arrayValue_[r].isEqual(e.arrayValue_[r]))return!1}return!0},dictsEqual:function(t,e){if(u.keys(t.dictionaryValue_).length==u.keys(e.dictionaryValue_).length){for(var i=u.iter(u.keys(t.dictionaryValue_));!i.done;i.next()){var n=i.value,r=t.dictionaryValue_[n],a=e.dictionaryValue_[n];if(null==a||!r.isEqual(a))return!1}return!0}return!1}},props:{name:{get:function(){return this.name_}},namePath:{get:function(){return this.namePath_}},index:{get:function(){return u.toInt(this.name_)}},copy:function(){var t,e;if(t=this.arrayValue)return new r(this.schemaType,this.namePath_,t.map((function(t){return t.copy()}),this),this.className);if(e=this.dictionaryValue){for(var i={},n=u.iter(e);!n.done;n.next()){var a=n.key,s=n.value;i[a]=s.copy()}return new r(this.schemaType,this.namePath_,u.clone(i),this.className)}return new r(this.schemaType,this.namePath_,this.value_,this.className)},reroot:function(t){if(this.namePath_=t,this.isArray)for(var e=u.iter(u.toSequence(this.arrayValue_));!e.done;e.next()){var i=e.value,n=i.offset,r=i.element,a=t.append(u.toString(n));r.reroot(a)}else if(this.isDictionary&&null==this.className)for(var s=u.iter(this.dictionaryValue_);!s.done;s.next()){var o=s.key;r=s.value,a=t.append(o),r.reroot(a)}},prependNameToPath:function(t){this.namePath_=this.namePath_.prepend(t),null==this.className&&this.prependNameToChildPaths(t)},prependNameToChildPaths:function(t){if(null!=this.arrayValue_)for(var e=u.iter(this.arrayValue_);!e.done;e.next())e.value.prependNameToPath(t);else if(null!=this.dictionaryValue_)for(var i=u.iter(this.dictionaryValue_);!i.done;i.next())i.value.prependNameToPath(t)},value:{get:function(){return this.value_}},boolValue:{get:function(){return u.as(this.value_,"Bool")}},doubleValue:{get:function(){return u.as(this.value_,"Double")}},intValue:{get:function(){return u.as(this.value_,"Int")}},stringValue:{get:function(){return u.as(this.value_,"String")}},linkID:{get:function(){var t;return(t=u.as(this.value_,c.IDBLink))?t.referenceID:null}},objValue:{get:function(){var t;return(t=u.as(this.value_,c.IDBLink))?t.dereference():null}},isArray:{get:function(){return this.schemaType==f.DBSchemaType.ArrayType}},getArrayProperty:function(t){return this.arrayValue_[t]},arrayPropertyCount:{get:function(){var t;return(t=u.opt(this.arrayValue_,(function(t){return t.length})))||null!=t?t:0}},forEachArrayProperty:function(t){if(this.isArray)for(var e=u.iter(u.toSequence(this.arrayValue_));!e.done;e.next()){var i=e.value;t(i.offset,i.element)}},arrayValue:{get:function(){return this.isArray?this.arrayValue_:null}},isDictionary:{get:function(){return this.schemaType==f.DBSchemaType.ObjectType&&null!=this.dictionaryValue_}},getDictionaryProperty:function(t){return this.isDictionary?this.dictionaryValue_[t]:null},setDictionaryProperty:function(t,e){this.isDictionary&&(null!=e?this.dictionaryValue_[t]=e:u.removeKey(this.dictionaryValue_,t),this.value_=u.clone(this.dictionaryValue_))},forEachDictionaryProperty:function(t){if(this.isDictionary)for(var e=u.iter(this.dictionaryValue_);!e.done;e.next())t(e.key,e.value)},dictionaryValue:{get:function(){return this.isDictionary?this.dictionaryValue_:null}},isEqual:function(t){var e;if(e=u.as(t,r)){if(e===this)return!0;if(this.schemaType!=e.schemaType)return!1;switch(this.schemaType){case"string":return null!=this.stringValue&&null!=e.stringValue&&this.stringValue==e.stringValue;case"boolean":return null!=this.boolValue&&null!=e.boolValue&&this.boolValue==e.boolValue;case"integer":return null!=this.intValue&&null!=e.intValue&&this.intValue==e.intValue;case"number":return null!=this.doubleValue&&null!=e.doubleValue&&this.doubleValue==e.doubleValue;case"object":if(null!=this.objValue)return this.objValue===e.objValue;if(this.isDictionary&&e.isDictionary)return r.dictsEqual(this,e);break;case"array":return this.isArray&&e.isArray&&r.arraysEqual(this,e);case"unknown":return!1}}return!1}}}),r),l.DBDeletedProperty=(a=function(t){l.DBProperty.call(this,f.DBSchemaType.UnknownType,t,0,null)},u.defineClass({name:"DBDeletedProperty",ctor:a,superName:"DBProperty",props:{shouldWrite:{get:function(){return!1},set:function(t){}},copy:function(){return new a(this.namePath_)},boolValue:{get:function(){return null}},doubleValue:{get:function(){return null}},intValue:{get:function(){return null}},stringValue:{get:function(){return null}},objValue:{get:function(){return null}},arrayValue:{get:function(){return null}},dictionaryValue:{get:function(){return null}},isEqual:function(t){return t instanceof a}}}),a),l.DBPropertyCodec=(s=function(){},o={},u.defineClass({name:"DBPropertyCodec",ctor:s,statics:{registeredCodecs_:{},primitiveUpdater_:{get:function(){return void 0===o.primitiveUpdater_&&(o.primitiveUpdater_=function(t,e){return t.value_=e,t}),o.primitiveUpdater_}},codec:function(t,e,i){return s.init_a58a(t,e,i)},updatingCodec:function(t,e,i,n){return s.init_e208(t,e,i,n)},boolCodec:function(){var t;return s.init_e208((function(t,e,i){return l.DBProperty.boolProperty(t,e)}),(function(e,i){return!(!(t=u.opt(e,(function(t){return t.boolValue})))&&null==t)&&t}),s.primitiveUpdater_,"Bool")},intCodec:function(){var t;return s.init_e208((function(t,e,i){return l.DBProperty.intProperty(t,e)}),(function(e,i){return(t=u.opt(e,(function(t){return t.intValue})))||null!=t?t:0}),s.primitiveUpdater_,"Int")},doubleCodec:function(){var t;return s.init_e208((function(t,e,i){return l.DBProperty.doubleProperty(t,e)}),(function(e,i){return(t=u.opt(e,(function(t){return t.doubleValue})))||null!=t?t:NaN}),s.primitiveUpdater_,"Double")},stringCodec:function(){return s.init_e208((function(t,e,i){return l.DBProperty.stringProperty(t,e)}),(function(t,e){return u.opt(t,(function(t){return t.stringValue}))}),s.primitiveUpdater_,"String")},objectCodec:function(t){return void 0===t&&(t=null),s.init_a58a((function(e,i,n){return l.DBProperty.objProperty(e,i,t,u.opt(n,(function(t){return t.id})))}),(function(t,e){return u.opt(t,(function(t){return t.objValue}))}),"Link")},directObjectCodec:function(t){return s.init_a58a((function(t,e,i){var n,r=l.DBProperty.deleted(t);if(n=u.as(e,h.DBObject)){var a,s,o=u.clone(n.state.allProperties);if((a=f.DBSchema.currentSchema.rulesByName[n.state.className])&&(s=a.getRequiredProperties()))for(var c=u.iter(s);!c.done;c.next()){var m=c.value;d.LegacyCoreAssert.isTrue(u.keys(o).includes(m),"missing property encountered when encoding",{property:m,className:n.state.className},"DBPropertyCodec.directObjectCodec","DBProperty.swift",454)}r=l.DBProperty.dictEncoded(t,u.clone(o),n.className),null!=i&&(n.isChildObject?d.LegacyCoreAssert.isFalse(n.state instanceof p.DBChildObjectState&&n.state.parentObject!==i,"Cannot reparent child objects. Clone the object before assigning to a new parent",void 0,"DBPropertyCodec.directObjectCodec","DBProperty.swift",466):i.addChildObject(n,t))}else d.LegacyCoreAssert.fail("Expected DBObject",{actual:e},"DBPropertyCodec.directObjectCodec","DBProperty.swift",472);return r}),(function(t,e){var i,n,r,a=null;return null!=(i=u.opt(t,(function(t){return t.className})))&&(n=u.as(e,h.DBObject))&&(r=u.opt(t,(function(t){return t.namePath})))&&(a=n.createChildObject(i,r)),a}),"Direct object")},arrayCodec:function(t){var e=this;return s.init_a58a((function(i,n,r){var a,s=l.DBProperty.deleted(i);if(a=u.as(n,["Array","Any"])){var o=u.toSequence(a).map((function(e){return t.encode(i.append(u.toString(e.offset)),e.element,r)}),e);s=l.DBProperty.arrayProperty(i,u.clone(o))}else d.LegacyCoreAssert.fail("Expected an array",{actual:n},"DBPropertyCodec.arrayCodec","DBProperty.swift",497);return s}),(function(i,n){var r,a=null;return(r=u.opt(i,(function(t){return t.arrayValue})))&&(a=r.map((function(e){return t.decode(e,n)}),e).filter((function(t){return null!=t}),e).map((function(t){return t}),e)),a}),"Array")},tupleCodec:function(t){return s.init_a58a((function(e,i,n){var r,a=l.DBProperty.deleted(e);if(r=u.as(i,["Array","Any"])){for(var s=[],o=u.iter(u.range(0,r.length,!1));!o.done;o.next()){var c=o.value;c<t.length?s.push(t[c].encode(e.append(u.toString(c)),r[c],n)):s.push(u.last(t).encode(e.append(u.toString(c)),r[c],n))}a=l.DBProperty.arrayProperty(e,u.clone(s))}else d.LegacyCoreAssert.fail("Expected an array",{actual:i},"DBPropertyCodec.tupleCodec","DBProperty.swift",529);return a}),(function(e,i){var n=null;return null!=e&&e.isArray&&(n=[],e.forEachArrayProperty((function(r,a){var s;r<t.length?null!=(s=t[r].decode(a,i))?n.push(s):d.LegacyCoreAssert.fail("Failed to decode array property",{property:e,index:r},"DBPropertyCodec.tupleCodec","DBProperty.swift",543):null!=(s=u.last(t).decode(a,i))?n.push(s):d.LegacyCoreAssert.fail("Failed to decode array property",{property:e,index:r},"DBPropertyCodec.tupleCodec","DBProperty.swift",549)}))),n}),"Tuple")},dictionaryCodec:function(t){var e=function(t,e,i){var n,r,a,s,o=l.DBProperty.deleted(t);return null!=(n=u.as(e,"Bool"))?o=l.DBProperty.boolProperty(t,n):null!=(r=u.as(e,"Int"))?o=l.DBProperty.intProperty(t,r):null!=(a=u.as(e,"Double"))?o=l.DBProperty.doubleProperty(t,a):null!=(s=u.as(e,"String"))&&(o=l.DBProperty.stringProperty(t,s)),o};return s.init_a58a((function(i,n,r){var a,s=l.DBProperty.deleted(i);if(a=u.as(n,["Dictionary","String","Any"])){for(var o={},c=u.iter(a);!c.done;c.next()){var h,f=c.key,p=c.value;(h=t[f])?o[f]=h.encode(i.append(f),p,r):o[f]=e(i.append(f),p)}s=l.DBProperty.dictProperty(i,u.clone(o))}else d.LegacyCoreAssert.fail("Expected a dictionary",{actual:n},"DBPropertyCodec.dictionaryCodec","DBProperty.swift",588);return s}),(function(e,i){var n=null;return null!=e&&e.isDictionary&&(n={},e.forEachDictionaryProperty((function(e,r){var a;(a=t[e])?n[e]=a.decode(r,i):n[e]=function(t,e){var i;if(null!=(i=u.opt(t,(function(t){return t.schemaType}))))switch(i){case"boolean":return t.boolValue;case"integer":return t.intValue;case"number":return t.doubleValue;case"string":return t.stringValue;default:return null}return null}(r)}))),n}),"Dictionary")},registerCodec:function(t,e){return d.LegacyCoreAssert.isTrue(null==s.registeredCodecs_[t],"Duplicate codec registered",{typeName:t},"DBPropertyCodec.registerCodec","DBProperty.swift",629),s.registeredCodecs_[t]=e,s.registeredCodecs_[t]},typeCodec:function(t){return s.registeredCodecs_[t]}},props:{init_a58a:function(t,e,i){this.encode=t,this.decode=e,this.update=null,this.tag=i},init_e208:function(t,e,i,n){this.encode=t,this.decode=e,this.update=i,this.tag=n}}}),s)},fVJ2:function(t,e,i){var n,r,a,s=e,o=i("oAGj"),l=i("gXiO"),u=i("N5RB"),c=i("O60Y"),h=i("dJuF"),f=i("SmK9"),p=i("13MC"),d=i("ZhwN"),m=i("iCxV"),b=i("fNpk");s.IDBObject=o.defineProtocol("IDBObject",{database:"IDatabase",state:"IDBObjectState",persisted:"Boolean",className:"String",getProperty:"(String) -> DBProperty",setProperty:"(String, DBProperty) -> Void",removeProperty:"(String) -> Void",abandonChanges:"() -> Void"}),s.DBDeletedObject=(n=function(t){this.db_=t,l.CoreObject.call(this),this.state_=new p.DBObjectDeletedState(this)},o.defineClass({name:"DBDeletedObject",ctor:n,superName:"CoreObject",statics:{_implements:function(t){return"IDBObject"==t}},props:{database:{get:function(){return this.db_}},state:{get:function(){return this.state_},set:function(t){b.LegacyCoreAssert.fail("Cannot set the state of a deleted object",void 0,"DBDeletedObject","DBObject.swift",58)}},persisted:{get:function(){return!1}},getProperty:function(t){return null},setProperty:function(t,e){b.LegacyCoreAssert.fail("Cannot set a proeprty on a deleted object",void 0,"DBDeletedObject.setProperty","DBObject.swift",63)},removeProperty:function(t){b.LegacyCoreAssert.fail("Cannot remove a property from a deleted object",void 0,"DBDeletedObject.removeProperty","DBObject.swift",64)},className:{get:function(){return""}},abandonChanges:function(){}}}),n),s.DBObject=(r=function(){this.initialState_=null,this.childObjects_=[],this.childObjectProperties_={},this.noOpSetter=function(t){},this.cachedValues_={},this.decodedObjects_={},this.validateOnSet=!1},o.defineClass({name:"DBObject",ctor:r,superName:"CoreObject",statics:{instantiateItemDescendants:function(t,e){var i,n,a;if(i=o.as(t,r))i.instantiateDescendants();else if(n=o.as(t,["Array","Any"])){var s;if(s=e.arrayValue)for(var l=o.iter(o.toSequence(s));!l.done;l.next()){var u=l.value,c=u.offset,h=u.element;r.instantiateItemDescendants(n[c],h)}}else(a=o.as(t,["Dictionary","String","Any"]))&&e.isDictionary&&e.forEachDictionaryProperty((function(t,e){var i;null!=(i=a[t])&&r.instantiateItemDescendants(i,e)}))},_implements:function(t){return"IDBObject"==t}},props:{database:{get:function(){return b.LegacyCoreAssert.isTrue(null!=this.db_,"Constant objects are not bound to a database",void 0,"DBObject","DBObject.swift",100),this.db_}},state:{get:function(){return this.state_||this.initialState},set:function(t){var e;if(b.LegacyCoreAssert.isTrue(null!=this.db_,"Cannot change the state of a constant object",void 0,"DBObject","DBObject.swift",107),b.LegacyCoreAssert.isTrue(!(this.initialState_ instanceof p.DBChildObjectState)||t===this.initialState_,"Child objects should have their states changed via a parent object.",void 0,"DBObject","DBObject.swift",108),e=o.as(t,p.DBChildObjectState))this.state_=e,this.initialState_=e;else if(null==this.state_&&null==this.initialState_&&(this.initialState_=t,this.state_=t),t!==this.state_){var i=o.clone(o.opt(this.state_,(function(e){return e.diff(t)})));null!=i&&o.count(i)>0&&this.willChangeState(o.clone(i)),this.state_=t,this.db_.objectStateChanged(t),null!=i&&o.count(i)>0&&(o.removeAll(this.cachedValues_),this.didChangeState(o.clone(i)))}}},removeChildObject:function(t){var e;null!=(e=o.indexOf(this.childObjects_,t))&&(t.removeAllChildren(),this.childObjects_.splice(e,1))},removeAllChildren:function(){for(var t=o.iter(this.childObjects_);!t.done;t.next()){var e=t.value;e.removeAllChildren(),e.persisted&&o.opt(o.as(this.db_.mutableState,p.DBMutableState),(function(t){return t.removeObject(e.id)}))}this.childObjects_.splice(0),o.removeAll(this.childObjectProperties_)},persistToDatabase:function(t,e){this.db_=t,this.guid_=e;for(var i=o.iter(this.childObjects_);!i.done;i.next()){var n=i.value;b.LegacyCoreAssert.isFalse(n.persisted,"Child object already persisted when its parent wasn't",void 0,"DBObject.persistToDatabase","DBObject.swift",160),t.addObject(d.GUIDUtils.makeGUID(),n)}},addChildObject:function(t,e){var i;t.convertToChildObject(this,e),this.persisted&&!t.persisted&&this.database.addObject(d.GUIDUtils.makeGUID(),t),null==e.parent&&((i=this.childObjectProperties_[e.name])&&this.removeChildObject(i),this.childObjectProperties_[e.name]=t),this.childObjects_.push(t)},createChildObject:function(t,e){var i,n=null;if(null!=(i=s.DBHostObject.factory(t))){var a,l=p.DBChildObjectState.init_94ed(this,e),u=d.GUIDUtils.makeGUID();if(null!=(n=o.as(i(u,this.db_,l,null),r)))l.object=n,o.opt(this.db_,(function(t){return t.addObject(u,n)})),null==e.parent&&((a=this.childObjectProperties_[e.name])&&this.removeChildObject(a),this.childObjectProperties_[e.name]=n),this.childObjects_.push(n)}return n},childObjects:{get:function(){return this.childObjects_.concat()}},descendantObjectsMA:{get:function(){for(var t=this.childObjects_.slice(0,this.childObjects_.length),e=o.iter(this.childObjects_);!e.done;e.next()){var i=e.value;o.append(t,i.descendantObjectsMA)}return t}},descendantObjects:{get:function(){return this.descendantObjectsMA.concat()}},convertToChildObject:function(t,e){if(!this.isChildObject){var i=o.clone(this.state.allProperties),n=p.DBChildObjectState.init_7008(this,t,e);this.initialState_=n,this.state_=n,n.setProperties(o.clone(i)),n.savePendingProperties()}return this.state},isChildObject:{get:function(){return this.initialState_ instanceof p.DBChildObjectState}},persisted:{get:function(){return null!=this.db_}},initialized:{get:function(){return null!=this.initialState_}},willChangeState:function(t){},didChangeState:function(t){},className:{get:function(){return b.LegacyCoreAssert.fail("Object class name not provided",void 0,"DBObject","DBObject.swift",239),""}},init_3f7c:function(t){var e,i=t instanceof p.DBChildObjectState;this.guid_=i?d.GUIDUtils.makeGUID():"",l.CoreObject.call(this),!i&&o.is(t,p.IDBObjectMutableState)?(this.initialState_=p.DBObjectState.init_2a9a(this,o.clone(t.allProperties)),this.state_=p.DBObjectMutableState.init_226b(this.initialState_)):(this.initialState_=t,this.state_=t,(e=o.as(t,p.DBChildObjectState))&&(e.object=this))},init_dd5d:function(t,e){this.guid_="",l.CoreObject.call(this),this.initialState_=p.DBObjectMutableState.init_2a9a(this,o.clone(t)),this.state_=this.initialState_;for(var i=o.clone(t),n=o.iter(e);!n.done;n.next()){var r,a=n.key,s=n.value;(r=f.DBSchema.currentSchema.getPropertyCodec(a,this.className))&&(i[a]=r.encode(h.DBNamePath.init_b14a(a),s,this))}this.initialState_=p.DBObjectState.init_2a9a(this,o.clone(i)),this.state_=p.DBObjectMutableState.init_226b(this.initialState_)},init_866e:function(t,e){var i,n=t instanceof p.DBChildObjectState;this.guid_=e,l.CoreObject.call(this),!n&&o.is(t,p.IDBObjectMutableState)?(this.initialState_=p.DBObjectState.init_2a9a(this,o.clone(t.allProperties)),this.state_=p.DBObjectMutableState.init_226b(this.initialState_)):(this.initialState_=t,this.state_=t,(i=o.as(t,p.DBChildObjectState))&&(i.object=this))},init_11e0:function(t){this.db_=t,this.guid_=d.GUIDUtils.makeGUID(),l.CoreObject.call(this),this.db_.addObject(this.guid_,this)},init_5079:function(t,e,i,n){this.db_=t,this.guid_=o.isEmpty(n)?d.GUIDUtils.makeGUID():n,l.CoreObject.call(this),this.initialState_=p.DBObjectMutableState.init_2a9a(this,o.clone(e)),this.state_=this.initialState_;for(var r=o.clone(e),a=o.iter(i);!a.done;a.next()){var s,u=a.key,c=a.value;(s=f.DBSchema.currentSchema.getPropertyCodec(u,this.className))&&(r[u]=s.encode(h.DBNamePath.init_b14a(u),c,this))}this.initialState_=p.DBObjectState.init_2a9a(this,o.clone(r)),this.state_=null,this.db_.addObject(this.guid_,this)},init_3181:function(t,e,i){var n;this.db_=t,this.guid_=i,l.CoreObject.call(this),(n=o.as(e,p.IDBObjectMutableState))?this.initialState_=n.assign(this):this.initialState_=e,this.state_=o.as(this.initialState_,p.DBChildObjectState),this.db_.addObject(this.guid_,this)},init_67b3:function(t){this.db_=t.database,this.guid_=d.GUIDUtils.makeGUID(),l.CoreObject.call(this),this.db_.addObject(this.guid_,this)},id:{get:function(){return this.guid_}},fork:function(t){return this.forkWithLink(t,null)},forkWithLink:function(t,e){return this.forkToDatabase(t,!0,o.opt(e,(function(t){return t.database}))||this.db_,e)},forkPropertyToDatabase:function(t,e,i,n,a){var s,l=this,u=null;if(null!=i.linkID){if(e){var f=o.as(i.objValue,r);if(null!=f){var p,m=d.GUIDUtils.makeGUID(),b=null!=a?c.DBLink.init_8408(m,a,n):null;(p=o.opt(f,(function(t){return t.forkToDatabase(m,!0,a,b)})))&&(u=h.DBProperty.objProperty(h.DBNamePath.init_b14a(t),p,this.className,n))}}}else if(s=i.arrayValue){for(var D=[],y=o.iter(o.toSequence(s));!y.done;y.next()){var _,S=y.value,v=S.offset,B=S.element;(_=this.forkPropertyToDatabase(o.toString(v),e,B,n,a))&&D.push(_)}u=null!=i.className?h.DBProperty.arrayEncoded(h.DBNamePath.init_b14a(t),o.clone(D),i.className):h.DBProperty.arrayProperty(h.DBNamePath.init_b14a(t),o.clone(D))}else if(i.isDictionary){var g={};i.forEachDictionaryProperty((function(t,i){var r;(r=l.forkPropertyToDatabase(t,e,i,n,a))&&(g[t]=r)})),u=null!=i.className?h.DBProperty.dictEncoded(h.DBNamePath.init_b14a(t),o.clone(g),i.className):h.DBProperty.dictProperty(h.DBNamePath.init_b14a(t),o.clone(g))}else u=i.copy();return u},forkToDatabase:function(t,e,i,n){var a,l=null;if(null!=(a=s.DBHostObject.factory(this.className))){for(var u=o.clone(this.state.allProperties),c={},h=o.iter(u);!h.done;h.next()){var f,d=h.key,m=h.value;(f=this.forkPropertyToDatabase(d,e,m,t,i))&&(c[d]=f)}var b=p.DBObjectMutableState.init_6271(this.className,o.clone(c));l=o.as(a(t,i,b,n),r)}return l},getCodec:function(t){return f.DBSchema.currentSchema.getPropertyCodec(t,this.className)},clearCache:function(){o.removeAll(this.cachedValues_)},abandonChanges:function(){this.clearCache()},host:{get:function(){var t,e;return(t=o.as(this.state_,p.DBChildObjectState))&&(e=o.as(t.parentObject,r))?e.host:o.as(o.opt(this.db_,(function(t){return t.host})),s.DBHostObject)}},get:function(t){var e,i,n,a,s,l,u,c,p,d=this,D=this.getProperty(t);if(null==D||D instanceof h.DBDeletedProperty)return null;if(null!=(s=this.cachedValues_[t]))return s;if(l=this.childObjectProperties_[t]){if(o.opt(D,(function(t){return t.className==l.className})))return l;b.LegacyCoreAssert.isTrue(o.opt(D,(function(t){return"AlphaBlendFilter"==t.className||o.opt(D,(function(t){return"CompositeFilter"==t.className}))})),"Unexpected className",{className:(e=o.opt(D,(function(t){return t.className})))||null!=e?e:"nil",childObjectClassName:l.className},"DBObject.get","DBObject.swift",475),o.opt(m.Host.logging,(function(t){return t.info("ClassName is "+((i=o.opt(D,(function(t){return t.className})))||null!=i?i:"nil")+" childObject ClassName is "+l.className)}))}if(null!=(u=this.decodedObjects_[t])&&(c=this.database.getObject(u))){if(o.opt(D,(function(t){return t.className==c.className})))return c;b.LegacyCoreAssert.isTrue(o.opt(D,(function(t){return"AlphaBlendFilter"==t.className||o.opt(D,(function(t){return"CompositeFilter"==t.className}))})),"Unexpected className",{className:(n=o.opt(D,(function(t){return t.className})))||null!=n?n:"nil",dbObjectClassName:c.className},"DBObject.get","DBObject.swift",489),o.opt(m.Host.logging,(function(t){return t.info("ClassName is "+((a=o.opt(D,(function(t){return t.className})))||null!=a?a:"nil")+" database obj ClassName is "+c.className)}))}if(p=D){var y=o.opt(this.host,(function(t){return t.decodingSchema})),_=f.DBSchema.currentSchema.getPropertyCodec(t,this.className)||o.opt(y,(function(e){return e.getPropertyCodec(t,d.className)}));if(null!=_){var S,v=_.decode(p,this);return(S=o.as(v,r))?S.persisted&&(this.decodedObjects_[t]=S.id):null!=v&&(this.cachedValues_[t]=v),v}}return this.cachedValues_[t]},set:function(t,e){var i;o.removeKey(this.decodedObjects_,t),null==e?(o.removeKey(this.cachedValues_,t),this.removeProperty(t)):(i=f.DBSchema.currentSchema.getPropertyCodec(t,this.className))&&(this.cachedValues_[t]=e,this.updateProperty(t,e)||this.setProperty(t,i.encode(h.DBNamePath.init_b14a(t),e,this)))},mutable:{get:function(){return null!=this.db_&&(o.is(this.state_,p.IDBObjectMutableState)||null!=this.db_.mutableState)}},schemaRule:{get:function(){return f.DBSchema.currentSchema.rulesByName[this.className]}},getProperty:function(t){return this.state.getProperty(t)},setProperty:function(t,e){var i=this;if(!e.isEqual(this.getProperty(t))){b.LegacyCoreAssert.isTrue(!this.persisted||null!=this.db_.mutableState,"Cannot change the state of a persisted "+this.className+" object when the database is immutable",void 0,"DBObject.setProperty","DBObject.swift",538);var n,r=o.is(this.state_,p.IDBObjectMutableState)?o.as(this.state_,p.IDBObjectMutableState):o.opt(o.opt(this.db_,(function(t){return t.mutableState})),(function(t){return t.newObjectState(i)}));if(n=r){var a;if(this.isChildObject&&o.opt(o.opt(this.db_,(function(t){return t.mutableState})),(function(t){return t.setObjectState(i,n)})),this.validateOnSet&&(a=o.opt(this.schemaRule,(function(e){return e.getPropertyRule(t)})))){var s,l=a.validateProperty(e);if(s=o.as(l,f.DBValidationError))return void b.LegacyCoreAssert.fail("Failed to write property",{property:t,error:s.error},"DBObject.setProperty","DBObject.swift",553)}n.setProperty(t,e)}}},updateProperty:function(t,e){var i,n;return!(!(i=o.as(this.state_,p.IDBObjectMutableState))||!(n=f.DBSchema.currentSchema.getPropertyCodec(t,this.className)))&&i.updateProperty(t,e,n)},removeProperty:function(t){var e=this.getProperty(t);if(null!=e&&!(e instanceof h.DBDeletedProperty)){b.LegacyCoreAssert.isTrue(!this.persisted||null!=this.db_.mutableState,"Cannot remove a property from a persisted "+this.className+" object when the database is immutable",void 0,"DBObject.removeProperty","DBObject.swift",573);var i,n,r=o.is(this.state_,p.IDBObjectMutableState)?this.state_:this.db_.mutableState.newObjectState(this);if(this.validateOnSet&&(i=o.opt(this.schemaRule,(function(t){return t.getRequiredProperties()})))&&i.includes(t))return void b.LegacyCoreAssert.fail("Cannot remove required property",{property:t},"DBObject.removeProperty","DBObject.swift",582);r.removeProperty(t),(n=this.childObjectProperties_[t])&&(this.removeChildObject(n),o.removeKey(this.childObjectProperties_,t),this.persisted&&o.opt(o.as(this.db_.mutableState,p.DBMutableState),(function(t){return t.removeObject(n.id)})))}},matchProperties:function(t){b.LegacyCoreAssert.isTrue(!this.persisted||null!=this.db_.mutableState,"Cannot change the state of a persisted object when the database is immutable",void 0,"DBObject.matchProperties","DBObject.swift",601);var e=o.is(this.state_,p.IDBObjectMutableState)?this.state_:this.db_.mutableState.newObjectState(this);e.clear();for(var i=o.iter(t);!i.done;i.next()){var n=i.key,r=i.value;e.setProperty(n,r)}for(var a=o.iter(this.childObjects);!a.done;a.next()){var s=a.value;s.clearCache(),o.opt(o.as(s.state,p.DBChildObjectState),(function(t){return t.abandonPendingProperties()}))}this.clearCache()},makeMutable:function(){o.opt(this.db_,(function(t){return null!=t.mutableState}))&&this.db_.mutableState.makeObjectMutable(this)},emptyState:{get:function(){return null==this.emptyState_&&(this.emptyState_=p.DBObjectState.init_be8f(this)),this.emptyState_}},initialState:{get:function(){return this.initialState_||this.emptyState}},mutableState:{get:function(){return o.is(this.state_,p.IDBObjectMutableState)?this.state_:this.db_.mutableState.newObjectState(this)}},instantiateDescendants:function(){for(var t=o.iter(this.state.allProperties);!t.done;t.next()){var e,i,n=t.key,a=t.value;a.schemaType!=f.DBSchemaType.ArrayType&&a.schemaType!=f.DBSchemaType.ObjectType||null!=(e=this.get(n))&&(i=this.getProperty(n))&&r.instantiateItemDescendants(e,i)}},willCommitState:function(){},didCommitState:function(){}}}),r),s.DBHostObject=(a=function(){this.hostDB_=new u.PostDB},o.defineClass({name:"DBHostObject",ctor:a,superName:"DBObject",statics:{factories_:{},registerFactory:function(t,e){return null==a.factories_[t]&&(a.factories_[t]=e),a.factories_[t]},factory:function(t){return a.factories_[t]},_implements:function(t){return"IDBObject"==t}},props:{init_1be9:function(t,e,i){this.schema_=f.DBSchema.init_2af7(t);var n=this.hostDB_.beginTransaction("decode",null);this.initialStateID_=this.schema_.validateAndRead(e,this.hostDB_,(function(t){for(var e="Errors: ",n=o.iter(t);!n.done;n.next())e=e+"\n"+n.value.error;i(e)})),o.super_init(this,s.DBObject,s.DBObject.prototype.init_5079,this.hostDB_,{},{},this.initialStateID_),n.end(),this.hostDB_.host=this},init_7341:function(t,e){var i;void 0===e&&(e=null),this.schema_=f.DBSchema.init_2af7(t);var n=this.hostDB_.beginTransaction("decode",null);this.initialStateID_="",o.super_init(this,s.DBObject,s.DBObject.prototype.init_5079,this.hostDB_,{},{},(i=e)||null!=i?i:d.GUIDUtils.makeGUID()),n.end(),this.hostDB_.host=this},init_b80b:function(t){var e;void 0===t&&(t=null),this.schema_=null;var i=this.hostDB_.beginTransaction("decode",null);this.initialStateID_="",o.super_init(this,s.DBObject,s.DBObject.prototype.init_5079,this.hostDB_,{},{},(e=t)||null!=e?e:d.GUIDUtils.makeGUID()),i.end(),this.hostDB_.host=this},decodingSchema:{get:function(){return this.schema_||f.DBSchema.currentSchema}},willApplyDatabaseState:function(t){},didApplyDatabaseState:function(t){}}}),a)}}]);
//# sourceMappingURL=vendors_npm_spark_4dd644c3-fec0723e.js.map